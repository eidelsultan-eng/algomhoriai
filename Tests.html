<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLab.M.S Pro - Laboratory Tests</title>
    <link rel="icon" href="images/datalab_icon3.jpg" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <!-- Add before your custom JS scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Prevent the turnaround time modal table from stacking cells */
        #turnaroundTimeTable {
            table-layout: fixed;
            width: 100%;
        }

        #turnaroundTimeTable thead th,
        #turnaroundTimeTable tbody td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        /* Make each input+button stay on one line */
        .turnaround-cell-inner {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            /* prevent stacking */
        }

        /* Ensure inputs don't expand and force layout break */
        .turnaround-cell-inner .turnaround-time-input {
            flex: 0 0 220px;
            /* fixed width */
            max-width: 220px;
        }

        #exportExcelBtn {
            display: none;
        }

        /* Custom styles */
        body {
            background-color: #f8f9fa;
        }

        .card.bg-primary {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #testsTable th {
            white-space: nowrap;
        }

        .accordion-button:not(.collapsed) {
            background-color: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
        }

        .range-item {
            background-color: #f8f9fa;
            position: relative;
        }

        /* ...existing code... */
        .header-card {
            background-color: #1a73e8;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header-tests-card {
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .test-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .btn {
            font-size: 15px;
            font-weight: 500;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
            }

            .modal-body .row>div {
                margin-bottom: 10px;
            }
        }

        /* Add these styles to your existing style section */
        .sensitivity-table {
            background-color: white;
        }

        .sensitivity-table th {
            background-color: #f8f9fa;
            white-space: nowrap;
        }

        .main-parameters-container .input-group {
            margin-bottom: 5px;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .range-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .range-item h6 {
            color: #0d6efd;
            margin-top: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .remove-range {
            position: absolute;
            bottom: 15px;
            right: 15px;
        }

        /* Responsive adjustments for culture parameters */
        @media (max-width: 768px) {

            .sensitivity-table td,
            .sensitivity-table th {
                padding: 0.3rem;
                font-size: 0.9rem;
            }

            .range-item .col-md-3,
            .range-item .col-md-4 {
                margin-bottom: 10px;
            }
        }

        .ai-float-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #c6c5d4 !important;
            border-color: #4907ff !important;
            color: #212529 !important;
        }

        .ai-float-btn i {
            font-size: 30px;
            font-weight: bold;
        }

        /* Price List Interactions */
        .price-row:hover {
            background-color: rgba(0, 188, 212, 0.08) !important;
            transform: translateX(5px);
            cursor: pointer;
        }

        .test-new-price:focus,
        .test-min-price:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 188, 212, 0.25);
            border-color: #00bcd4;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease forwards;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="btn btn-warning position-relative start-0  ms-3" href="#" onclick="history.back(); return false;"
                style="margin-right: 5px;">
                <i class="fas fa-arrow-left"></i>
                Back
            </a>
            <a class="navbar-brand" href="Dashboard.html">DataLab.M.S Pro</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="navbarNav">

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-bell"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="userProfile"><i class="fas fa-user"></i> <span
                                id="userFullName">Loading...</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="userProfile"><i class="fas fa-building"></i> <span
                                id="userBranchName">Branch Name</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-3">
        <!-- Action Card -->
        <div class="card bg-primary text-white mb-3">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-center">
                    <!-- LEFT GROUP: title + export buttons -->
                    <div class="d-flex align-items-center gap-2">
                        <h5 class="card-title mb-0">Laboratory Tests</h5>
                        <button class="btn btn-danger text-white fw-bold" id="exportPdfBtn" title="Export PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button class="btn btn-light text-white fw-bold" id="exportExcelBtn" title="Export Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                    </div>

                    <!-- RIGHT GROUP: other action buttons -->
                    <div>
                        <!-- Add this in your Action Card button group -->
                        <button class="btn btn-secondary btn-sm ms-2" id="editTurnaroundTimeBtn">
                            <i class="fas fa-clock"></i> Control Turnaround Time (TAT)
                        </button>
                        <button class="btn btn-info btn-sm me-2" id="addPriceListBtn">
                            <i class="fas fa-tags me-1"></i> Price List
                        </button>
                        <button class="btn btn-secondary btn-sm" id="addNewTestBtn" data-bs-toggle="modal"
                            data-bs-target="#testModal">
                            <i class="fas fa-plus me-1"></i> New Test
                        </button>
                        <button class="btn btn-warning btn-sm ms-2" id="bulkAddTestsBtn">
                            <i class="fas fa-layer-group me-1"></i> + Bulk
                        </button>
                        <button class="btn btn-danger btn-sm ms-2" id="deleteAllTestsBtn">
                            <i class="fas fa-trash"></i> Trash All
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control"
                placeholder="Search tests by name, ID, model, group, or abbreviation" id="searchInput">
            <button class="btn btn-primary" type="button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- Tests Table -->
    <div class="table-responsive" class="test-table">
        <table class="table table-striped table-hover table-bordered" id="testsTable">
            <thead class="table-primary">
                <tr>
                    <th>
                        <input type="checkbox" id="selectAllTestsMain">
                    </th>
                    <th>Test Name</th>
                    <th>ID</th>
                    <th>Model</th>
                    <th>Department</th>
                    <th>Group</th>
                    <th>Sample Type</th>
                    <th>Abbreviation</th>
                    <th>Precautions</th>

                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="testsTableBody">
                <!-- Tests will be loaded here -->
            </tbody>
        </table>
    </div>
    </div>

    <!-- Add/Edit Test Modal -->
    <div class="modal fade" id="testModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="testModalLabel">Add New Test</h5>


                    <div class="ms-auto d-flex align-items-center">
                        <button type="button" class="btn btn-light me-2" id="refreshTestModalBtn" title="Refresh">
                            <i class="fas fa-rotate-right"></i>
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="testForm">
                        <div class="row g-3">
                            <!-- Replace your current search bar HTML with this -->
                            <div class="col-md-4">
                                <label for="testNameSearch" class="form-label" id="testNameSearchLabel">Search by Test
                                    Name</label>
                                <div class="input-group">
                                    <input type="text" id="testNameSearch" class="form-control"
                                        placeholder="Search on tests">
                                    <!-- Place this near your search input -->
                                    <input type="text" id="manualTestNameInput" style="display:none;" />
                                    <button class="btn btn-outline-secondary" type="button" id="clearTestSearch"
                                        style="display:none;" title="Clear Search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="addTestManually"
                                        title="Type Test Manually">
                                        <i class="fas fa-add"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="test_name" class="form-label" id="testNamelabel">Test Name</label>
                                <select class="form-select" id="test_name" required>
                                    <option value="">Select a test</option>
                                    <!-- Regular tests will be populated here -->
                                </select>

                            </div>
                            <div class="col-md-4">
                                <label for="test_id" class="form-label">ID</label>
                                <input type="text" class="form-control" id="test_id" required>
                            </div>
                            <div class="col-md-6">
                                <label for="testModel" class="form-label">Model</label>
                                <select class="form-select" id="testModel" required>
                                    <option value="">Select Model</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Special">Special</option>
                                    <option value="Multiple Ranges">Multiple Ranges</option>
                                    <option value="Culture">Culture</option>
                                    <option value="Compatibility">Compatibility</option>
                                    <option value="Pathologic">Pathologic</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="testDepartment" class="form-label">Department</label>
                                <select class="form-select" id="testDepartment">
                                    <option value="">Select Department</option>
                                </select>
                                <input type="text" class="form-control mt-2" id="manualDepartmentInput"
                                    style="display:none;" placeholder="Enter department manually">
                                <button type="button" class="btn btn-sm btn-secondary mt-2"
                                    id="addDepartmentManually">Add Department Manually</button>
                                <button type="button" class="btn btn-sm btn-info mt-2" id="editDepartmentBtn">Edit
                                    Department</button>
                            </div>
                            <div class="col-md-6">
                                <label for="testGroup" class="form-label">Group</label>
                                <select class="form-select" id="testGroup" required>
                                    <option value="">Select Group</option>
                                    <option value="Kidney Functions">Kidney Functions</option>
                                    <option value="Liver Functions">Liver Functions</option>
                                    <option value="Thyroid Functions">Thyroid Functions</option>
                                    <option value="Coagulation">Coagulation</option>
                                    <option value="Cardiac">Cardiac</option>
                                    <option value="Electrolytes">Electrolytes</option>
                                    <option value="Hematology">Hematology</option>
                                    <option value="Lipid Profile">Lipid Profile</option>
                                    <option value="Diabetes">Diabetes</option>
                                    <option value="Hormones">Hormones</option>
                                    <option value="Infectious Diseases">Infectious Diseases</option>
                                    <option value="Immunology">Immunology</option>
                                    <option value="Tumor Markers">Tumor Markers</option>
                                    <option value="Microbiology">Microbiology</option>
                                    <option value="Serology">Serology</option>
                                    <option value="Urine turnaround">Urine turnaround</option>
                                    <option value="Stool turnaround">Stool turnaround</option>
                                    <option value="Semen turnaround">Semen turnaround</option>
                                    <option value="Semen Culture">Semen Culture</option>
                                    <option value="Urine Culture">Urine Culture</option>
                                    <option value="Inflammatory Markers">Inflammatory Markers</option>
                                    <option value="Vitamins & Minerals">Vitamins & Minerals</option>
                                    <option value="Toxicology">Toxicology</option>
                                    <option value="Genetic Testing">Genetic Testing</option>
                                    <option value="Allergy Testing">Allergy Testing</option>
                                    <option value="Autoimmune Diseases">Autoimmune Diseases</option>
                                    <option value="Pathology">Pathology</option>

                                    <!-- Additional groups for comprehensive coverage -->
                                    <option value="Biochemistry">Biochemistry</option>
                                    <option value="Endocrinology">Endocrinology</option>
                                    <option value="Nephrology">Nephrology</option>
                                    <option value="Hepatology">Hepatology</option>
                                    <option value="Cardiology">Cardiology</option>
                                    <option value="Molecular Diagnostics">Molecular Diagnostics</option>
                                    <option value="Reproductive Health">Reproductive Health</option>
                                    <option value="Prenatal Testing">Prenatal Testing</option>
                                    <option value="Nutrition">Nutrition</option>
                                    <option value="Critical Care">Critical Care</option>
                                    <option value="Respiratory">Respiratory</option>
                                    <option value="Gastroenterology">Gastroenterology</option>
                                    <option value="Rheumatology">Rheumatology</option>
                                    <option value="Neurology">Neurology</option>
                                    <option value="Oncology">Oncology</option>
                                    <option value="Blood Gas turnaround">Blood Gas turnaround</option>
                                    <option value="Bone Metabolism">Bone Metabolism</option>
                                    <option value="Anemia Panel">Anemia Panel</option>
                                    <option value="Fertility Testing">Fertility Testing</option>
                                    <option value="Metabolic Panel">Metabolic Panel</option>
                                    <option value="Comprehensive Metabolic Panel">Comprehensive Metabolic Panel</option>
                                    <option value="Basic Metabolic Panel">Basic Metabolic Panel</option>
                                    <option value="TORCH Panel">TORCH Panel</option>
                                    <option value="Hepatitis Panel">Hepatitis Panel</option>
                                    <option value="Iron Studies">Iron Studies</option>
                                    <option value="Blood Banking">Blood Banking</option>
                                    <option value="Parasitology">Parasitology</option>
                                    <option value="Mycology">Mycology</option>
                                    <option value="Virology">Virology</option>
                                    <option value="Bacteriology">Bacteriology</option>
                                    <option value="Autoimmune">Autoimmune</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" class="form-control" id="manualGroupInput" style="display:none;"
                                    placeholder="Enter new group" />
                                <button class="btn btn-outline-secondary" type="button" id="addGroupManually"
                                    title="Type Group Manually">
                                    <i class="fas fa-add"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="editGroupBtn"
                                    title="Edit Selected Group">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>



                            <div class="col-md-6">
                                <label for="sample_type" class="form-label">Sample Type</label>
                                <select class="form-select" id="sample_type" required>
                                    <option value="">Select</option>

                                    <!-- Blood & Derivatives -->
                                    <optgroup label="Blood & Derivatives">
                                        <option value="Blood">Blood</option>
                                        <option value="Whole Blood">Whole Blood</option>
                                        <option value="Serum">Serum</option>
                                        <option value="Serum Gel">Serum Gel</option>
                                        <option value="Plasma">Plasma</option>
                                        <option value="Heparin Plasma">Heparin Plasma</option>
                                        <option value="EDTA">EDTA</option>
                                        <option value="EDTA Plasma">EDTA Plasma</option>
                                        <option value="Citrate Plasma">Citrate Plasma</option>
                                        <option value="Fluoride Plasma">Fluoride Plasma</option>
                                        <option value="ACD Blood">ACD Blood</option>
                                        <option value="CPDA Blood">CPDA Blood</option>
                                        <option value="Buffy Coat">Buffy Coat</option>
                                        <option value="Capillary Blood">Capillary Blood</option>
                                        <option value="Arterial Blood">Arterial Blood</option>
                                        <option value="Venous Blood">Venous Blood</option>
                                        <option value="Cord Blood">Cord Blood</option>
                                    </optgroup>

                                    <!-- Urine & Stool -->
                                    <optgroup label="Urine & Stool">
                                        <option value="Urine">Urine</option>
                                        <option value="24-Hour Urine">24-Hour Urine</option>
                                        <option value="Random Urine">Random Urine</option>
                                        <option value="First Morning Urine">First Morning Urine</option>
                                        <option value="Midstream Urine">Midstream Urine</option>
                                        <option value="Catheterized Urine">Catheterized Urine</option>
                                        <option value="Suprapubic Urine">Suprapubic Urine</option>
                                        <option value="Stool">Stool</option>
                                        <option value="Fecal Occult Blood">Fecal Occult Blood</option>
                                    </optgroup>

                                    <!-- Swabs & Smears -->
                                    <optgroup label="Swabs & Smears">
                                        <option value="Swab">Swab</option>
                                        <option value="Throat Swab">Throat Swab</option>
                                        <option value="Nasal Swab">Nasal Swab</option>
                                        <option value="Nasopharyngeal Swab">Nasopharyngeal Swab</option>
                                        <option value="Oropharyngeal Swab">Oropharyngeal Swab</option>
                                        <option value="Rectal Swab">Rectal Swab</option>
                                        <option value="Urethral Swab">Urethral Swab</option>
                                        <option value="Vaginal Swab">Vaginal Swab</option>
                                        <option value="Cervical Swab">Cervical Swab</option>
                                        <option value="Wound Swab">Wound Swab</option>
                                        <option value="Ear Swab">Ear Swab</option>
                                        <option value="Eye Swab">Eye Swab</option>
                                        <option value="Cervical Smear">Cervical Smear</option>
                                        <option value="Vaginal Smear">Vaginal Smear</option>
                                        <option value="Tissue Smear">Tissue Smear</option>
                                        <option value="Blood Smear">Blood Smear</option>
                                        <option value="Bone Marrow Smear">Bone Marrow Smear</option>
                                    </optgroup>

                                    <!-- Body Fluids -->
                                    <optgroup label="Body Fluids">
                                        <option value="CSF">CSF (Cerebrospinal Fluid)</option>
                                        <option value="Pleural Fluid">Pleural Fluid</option>
                                        <option value="Ascitic Fluid">Ascitic Fluid</option>
                                        <option value="Synovial Fluid">Synovial Fluid</option>
                                        <option value="Pericardial Fluid">Pericardial Fluid</option>
                                        <option value="Amniotic Fluid">Amniotic Fluid</option>
                                        <option value="Gastric Fluid">Gastric Fluid</option>
                                        <option value="Peritoneal Fluid">Peritoneal Fluid</option>
                                        <option value="Bronchoalveolar Lavage">Bronchoalveolar Lavage (BAL)</option>
                                        <option value="Sputum">Sputum</option>
                                        <option value="Induced Sputum">Induced Sputum</option>
                                        <option value="Saliva">Saliva</option>
                                        <option value="Sweat">Sweat</option>
                                        <option value="Tears">Tears</option>
                                        <option value="Breast Milk">Breast Milk</option>
                                        <option value="Seminal Fluid">Seminal Fluid</option>
                                        <option value="Prostatic Fluid">Prostatic Fluid</option>
                                        <option value="Vaginal Secretions">Vaginal Secretions</option>
                                        <option value="Dialysis Fluid">Dialysis Fluid</option>
                                    </optgroup>

                                    <!-- Semen & Reproductive -->
                                    <optgroup label="Reproductive Samples">
                                        <option value="Semen">Semen</option>
                                        <option value="Semen for turnaround">Semen for turnaround</option>
                                        <option value="Semen for Culture">Semen for Culture</option>
                                        <option value="Post-Vasectomy Semen">Post-Vasectomy Semen</option>
                                        <option value="Sperm Wash">Sperm Wash</option>
                                        <option value="Embryo Culture Medium">Embryo Culture Medium</option>
                                        <option value="Follicular Fluid">Follicular Fluid</option>
                                        <option value="Endometrial Fluid">Endometrial Fluid</option>
                                        <option value="Chorionic Villus">Chorionic Villus</option>
                                    </optgroup>

                                    <!-- Pathology Samples -->
                                    <optgroup label="Pathology Samples">
                                        <option value="Tissue">Tissue</option>
                                        <option value="Frozen Tissue">Frozen Tissue</option>
                                        <option value="Paraffin Block">Paraffin Block</option>
                                        <option value="Fine Needle Aspirate">Fine Needle Aspirate</option>
                                        <option value="Core Biopsy">Core Biopsy</option>
                                        <option value="Excisional Biopsy">Excisional Biopsy</option>
                                        <option value="Incisional Biopsy">Incisional Biopsy</option>
                                        <option value="Bone Marrow">Bone Marrow</option>
                                        <option value="Bone Marrow Aspirate">Bone Marrow Aspirate</option>
                                        <option value="Bone Marrow Biopsy">Bone Marrow Biopsy</option>
                                        <option value="Cervical Biopsy">Cervical Biopsy</option>
                                        <option value="Endometrial Biopsy">Endometrial Biopsy</option>
                                        <option value="Lymph Node">Lymph Node</option>
                                        <option value="Skin Scraping">Skin Scraping</option>
                                        <option value="Hair Root">Hair Root</option>
                                        <option value="Nail Clipping">Nail Clipping</option>
                                        <option value="Calculus">Calculus (Stone)</option>
                                    </optgroup>

                                    <!-- Special Collection -->
                                    <optgroup label="Special Collection">
                                        <option value="Hair">Hair</option>
                                        <option value="Nail">Nail</option>
                                        <option value="Tooth">Tooth</option>
                                        <option value="Dried Blood Spot">Dried Blood Spot</option>
                                        <option value="Guthrie Card">Guthrie Card</option>
                                        <option value="Filter Paper">Filter Paper</option>
                                        <option value="Environmental Sample">Environmental Sample</option>
                                        <option value="Food Sample">Food Sample</option>
                                    </optgroup>

                                    <!-- Microbiology Specific -->
                                    <optgroup label="Microbiology Samples">
                                        <option value="Blood Culture">Blood Culture</option>
                                        <option value="Urine Culture">Urine Culture</option>
                                        <option value="Sputum Culture">Sputum Culture</option>
                                        <option value="Stool Culture">Stool Culture</option>
                                        <option value="Wound Culture">Wound Culture</option>
                                        <option value="Tissue Culture">Tissue Culture</option>
                                        <option value="AFB Culture">AFB Culture</option>
                                        <option value="Fungal Culture">Fungal Culture</option>
                                        <option value="Viral Culture">Viral Culture</option>
                                    </optgroup>

                                    Swap
                                    <!-- Swabs -->
                                    <optgroup label="Swabs">
                                        <option value="Swab">Swab</option>
                                        <option value="Eye Swab">Eye Swab</option>
                                        <option value="Nasal Swab">Nasal Swab</option>
                                        <option value="Throat Swab">Throat Swab</option>
                                        <option value="Vaginal Swab">Vaginal Swab</option>
                                        <option value="Urethral Swab">Urethral Swab</option>
                                        <option value="Rectal Swab">Rectal Swab</option>
                                        <option value="Wound Swab">Wound Swab</option>
                                        <option value="Skin Swab">Skin Swab</option>
                                        <option value="Fistula Swab">Fistula Swab</option>
                                        <option value="Catheter Tip Swab">Catheter Tip Swab</option>
                                    </optgroup>

                                    <!-- Other -->
                                    <optgroup label="Other">
                                        <option value="Unknown">Unknown</option>
                                        <option value="Other">Other</option>
                                    </optgroup>
                                </select>
                                <input type="text" class="form-control" id="manualSampleTypeInput" style="display:none;"
                                    placeholder="Enter new sample type" />
                                <button class="btn btn-outline-secondary" type="button" id="addSampleTypeManually"
                                    title="Type Sample Type Manually">
                                    <i class="fas fa-add"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="editSampleTypeBtn"
                                    title="Edit Selected Sample Type">
                                    <i class="fas fa-edit"></i>
                                </button>

                            </div>

                            <div class="col-md-6">
                                <label for="unit" class="form-label">Unit</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="unit" required>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="getUnitAI"
                                        title="Get Unit by AI">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Abbreviation Input Group -->
                            <div class="col-md-6">
                                <label for="abbreviation" class="form-label">Abbreviation</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="abbreviation">
                                    <button type="button" class="btn btn-outline-success btn-sm" id="getAbbreviationAI"
                                        title="Get Abbreviation by AI">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Precautions Input Group -->
                            <div class="col-12">
                                <label for="precautions" class="form-label">Precautions</label>
                                <div class="input-group">
                                    <textarea class="form-control" id="precautions" rows="2"></textarea>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="getPrecautionsAI"
                                        title="Get Precautions by AI">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="questions" class="form-label">Questions</label>
                                <div class="input-group">
                                    <textarea class="form-control" id="questions" rows="2"></textarea>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="getQuestionsAI"
                                        title="Get Questions by AI">
                                        <i class="fas fa-robot"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Reference Ranges Section -->
                        <div class="mt-4">
                            <h5 class="mb-3">Reference Ranges by Gender and Age</h5>
                            <div class="accordion" id="reference_rangesAccordion">
                                <!-- Male Reference Ranges -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingMale">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapseMale">
                                            Male Reference Ranges
                                        </button>
                                    </h2>
                                    <div id="collapseMale" class="accordion-collapse collapse show"
                                        aria-labelledby="headingMale">
                                        <div class="accordion-body">
                                            <div id="maleRangesContainer">
                                                <!-- Male ranges will be added here -->
                                                <div class="male-range-item mb-3 p-3 border rounded">
                                                    <div class="row g-3">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Age From</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control age-from"
                                                                    min="0">
                                                                <select class="form-select age-unit">
                                                                    <option value="days">Days</option>
                                                                    <option value="months">Months</option>
                                                                    <option value="years" selected>Years</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Age To</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control age-to"
                                                                    min="0">
                                                                <select class="form-select age-unit">
                                                                    <option value="days">Days</option>
                                                                    <option value="months">Months</option>
                                                                    <option value="years" selected>Years</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Range</label>
                                                            <input type="text" class="form-control range-value"
                                                                placeholder="e.g., 0.7-1.3">
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-primary mt-2" id="addMaleRange">
                                                <i class="fas fa-plus"></i> Add Male Range
                                            </button>
                                        </div>
                                    </div>
                                    <div id="maleParametersEditor"></div>
                                    <div id="maleParametersContainer"></div>
                                    <!-- Inside Male accordion body -->

                                </div>

                                <!-- Female Reference Ranges -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingFemale">
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#collapseFemale">
                                            Female Reference Ranges
                                        </button>
                                    </h2>
                                    <div id="collapseFemale" class="accordion-collapse collapse"
                                        aria-labelledby="headingFemale">
                                        <div class="accordion-body">
                                            <div id="femaleRangesContainer">
                                                <!-- Female ranges will be added here -->
                                                <div class="female-range-item mb-3 p-3 border rounded">
                                                    <div class="row g-3">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Age From</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control age-from"
                                                                    min="0">
                                                                <select class="form-select age-unit">
                                                                    <option value="days">Days</option>
                                                                    <option value="months">Months</option>
                                                                    <option value="years" selected>Years</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Age To</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control age-to"
                                                                    min="0">
                                                                <select class="form-select age-unit">
                                                                    <option value="days">Days</option>
                                                                    <option value="months">Months</option>
                                                                    <option value="years" selected>Years</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Range</label>
                                                            <input type="text" class="form-control range-value"
                                                                placeholder="e.g., 0.6-1.1">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-check pt-4">
                                                                <input class="form-check-input pregnant-check"
                                                                    type="checkbox">
                                                                <label class="form-check-label">Pregnant</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-primary mt-2"
                                                id="addFemaleRange">
                                                <i class="fas fa-plus"></i> Add Female Range
                                            </button>
                                        </div>
                                    </div>

                                    <div id="femaleParametersEditor"></div>
                                    <div id="femaleParametersContainer"></div>
                                    <!-- Inside Female accordion body -->


                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTestBtn">Save Test</button>

                </div>
            </div>
        </div>
    </div>

    <!-- Price List Modal -->
    <!-- Price List Modal -->
    <div class="modal fade" id="priceListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Update Test Prices</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="applyGlobalChange">
                                <label class="form-check-label" for="applyGlobalChange">
                                    Apply change to all tests
                                </label>
                            </div>

                            <div class="input-group mb-3" id="globalChangeInputGroup" style="display: none;">
                                <select class="form-select" id="changeType" style="max-width: 40px;">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                                <input type="number" class="form-control" id="globalChangeValue" placeholder="Value"
                                    min="0">
                                <button class="btn btn-primary" type="button" id="applyGlobalChangeBtn">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="applyToNewPrice" checked>
                                <label class="form-check-label" for="applyToNewPrice">Apply to New Price</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="applyToMinPrice">
                                <label class="form-check-label" for="applyToMinPrice">Apply to Minimum Price</label>
                            </div>
                            <button class="btn btn-sm btn-success mt-2" id="saveAllPricesBtn">
                                <i class="fas fa-save"></i> Save All Changes
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="branchPriceListSelect" class="form-label">Select Branch</label>
                            <select class="form-select" id="branchPriceListSelect">
                                <option value="">-- All Branches --</option>
                                <!-- Branches will be loaded here -->
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <select class="form-select me-2" id="sourceBranchSelect">
                                <option value="">-- Copy From Branch --</option>
                                <!-- Branches will be loaded here -->
                            </select>
                            <button class="btn btn-info" id="fetchBranchPricesBtn">
                                <i class="fas fa-download"></i> Fetch
                            </button>
                        </div>
                    </div>
                    <!-- Add inside #priceListModal .modal-body -->
                    <button class="btn btn-outline-primary" id="downloadBranchPriceExcelBtn" type="button">
                        <i class="fas fa-download"></i> Download Prices Excel
                    </button>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Upload Price List (Excel) for Branch</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="branchPriceExcelInput" accept=".xlsx,.xls">
                            <button class="btn btn-success" id="uploadBranchPriceExcelBtn" type="button">
                                <i class="fas fa-upload"></i> Upload Excel
                            </button>
                        </div>
                        <div id="branchPriceExcelStatus" class="small mt-2"></div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="priceListTestSearch"
                                placeholder="Search tests by name, id ...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Test ID</th>
                                    <th>Current Price</th>
                                    <th>New Price</th>
                                    <th>Minimum Price</th>

                                </tr>
                            </thead>
                            <tbody id="priceListTableBody">
                                <!-- Tests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Tests Modal -->
    <div class="modal fade" id="bulkAddModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">Bulk Add Tests</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Progress: <span id="bulkProgressText">0/0</span></span>
                            <span>Current ID: <span id="currentTestId">-</span></span>
                        </div>
                        <div class="progress mb-3">
                            <div id="bulkProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-2" id="bulkCheckControls">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="showAddedTestsChk">
                            <label class="form-check-label" for="showAddedTestsChk">Show Added Tests</label>
                        </div>
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="addNotAddedTestsChk">
                            <label class="form-check-label" for="addNotAddedTestsChk">Add Not Added Tests</label>
                        </div>
                        <span class="ms-auto small text-muted" id="bulkTestsStats"></span>
                    </div>

                    <!-- Add this at the top of #bulkAddModal .modal-body -->
                    <div class="mb-3">
                        <label for="excelFileInput" class="form-label">Upload Excel Sheet</label>
                        <input type="file" class="form-control" id="excelFileInput" accept=".xlsx,.xls" required>
                        <div class="form-text">Please select an Excel file (.xlsx or .xls format)</div>
                    </div>
                    <div id="filePreviewSection" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-file-excel me-2"></i>File Selected:</h6>
                            <p id="selectedFileName" class="mb-0"></p>
                            <small id="fileSize" class="text-muted"></small>
                        </div>
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                style="width: 0%" id="progressBar"></div>
                        </div>
                        <div id="progressText" class="text-center"></div>
                    </div>
                    <div id="uploadStatus"></div>

                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Search tests..." id="bulkSearchInput">
                        <button class="btn btn-outline-secondary" type="button" id="bulkClearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>



                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="50px">
                                        <input type="checkbox" id="selectAllTests">
                                    </th>
                                    <th>Test Name</th>
                                    <th>Model</th>
                                    <th>Group</th>
                                </tr>
                            </thead>
                            <tbody id="bulkTestsTableBody">
                                <!-- Tests will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">


                    <button type="button" class="btn btn-success" id="saveBulkTestsBtn">
                        <i class="fas fa-save me-1"></i> Save All Tests
                    </button>
                    <button type="button" class="btn btn-primary" id="mergeTestsDataBtn" disabled>
                        <i class="fas fa-database me-1"></i> Merge Tests Data
                    </button>
                </div>
            </div>
        </div>


    </div>

    <!-- Turnaround Time Modal -->
    <div class="modal fade" id="turnaroundTimeModal" tabindex="-1" aria-labelledby="turnaroundTimeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="turnaroundTimeModalLabel">Bulk Perodization Turnaround Time</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex align-items-center">
                        <input type="text" class="form-control me-2" id="turnaroundTimeSearchInput"
                            placeholder="Search by test name or ID">
                        <button class="btn btn-primary me-2" id="turnaroundTimeSearchBtn"><i class="fas fa-search"></i>
                            Search</button>
                        <select class="form-select me-2" id="bulkTurnaroundTimeSelect" style="max-width: 250px;">
                            <option value="">-- Set Turnaround Time for All --</option>
                            <!-- Options will be populated by JS -->
                        </select>
                        <button class="btn btn-success" id="applyTurnaroundTimeToAllBtn"><i class="fas fa-check"></i>
                            Apply to All</button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-bordered table-striped" id="turnaroundTimeTable">
                            <thead>
                                <tr>
                                    <th style="width:110px">Test ID</th>
                                    <th>Test Name</th>
                                    <th style="width:320px">Normal Turnaround Time</th>
                                    <th style="width:320px">Urgent Turnaround Time</th>
                                </tr>
                            </thead>
                            <tbody id="turnaroundTimeTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="saveTurnaroundTimesBtn"><i class="fas fa-save"></i> Save
                        All</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-danger" id="exportTurnaroundPdfBtn"><i class="fas fa-file-pdf"></i> Export
                        PDF</button>


                </div>
            </div>
        </div>
    </div>

    <!-- Price List Management Modal -->
    <div class="modal fade" id="priceListModal" tabindex="-1" aria-labelledby="priceListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header border-0" style="background: #00bcd4; color: white;">
                    <h5 class="modal-title fw-bold" id="priceListModalLabel">Update Test Prices</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyAllTests">
                                <label class="form-check-label" for="applyAllTests">Apply change to all tests</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyNewPrice" checked>
                                <label class="form-check-label" for="applyNewPrice">Apply to New Price</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="applyMinPrice">
                                <label class="form-check-label" for="applyMinPrice">Apply to Minimum Price</label>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-success" id="savePriceChangesBtn">
                                <i class="fas fa-save me-1"></i> Save All Changes
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label class="form-label">Select Branch</label>
                            <select class="form-select" id="priceBranchSelect">
                                <option value="">-- All Branches --</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Copy From Branch</label>
                            <select class="form-select" id="copyFromBranchSelect">
                                <option value="">-- Copy From Branch --</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-info w-100" id="fetchPricesBtn">
                                <i class="fas fa-download me-1"></i> Fetch
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary" id="downloadPricesExcelBtn">
                                <i class="fas fa-file-excel me-1"></i> Download Prices Excel
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Upload Price List (Excel) for Branch</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="uploadPricesInput">
                            <button class="btn btn-success" id="uploadPricesBtn">
                                <i class="fas fa-upload me-1"></i> Upload Excel
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchPriceTestInput"
                            placeholder="Search tests by name, id ...">
                    </div>

                    <div class="table-responsive"
                        style="max-height: 450px; border-radius: 8px; border: 1px solid #eee;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-top bg-white" style="z-index: 10;">
                                <tr style="border-bottom: 2px solid #00bcd4;">
                                    <th class="py-3 px-3">Test Name</th>
                                    <th class="py-3 px-3">Test ID</th>
                                    <th class="py-3 px-3">Current Price</th>
                                    <th class="py-3 px-3">New Price</th>
                                    <th class="py-3 px-3">Minimum Price</th>
                                </tr>
                            </thead>
                            <tbody id="priceListTableBody">
                                <tr>
                                    <td colspan="5" class="py-5 text-center">
                                        <div class="d-flex flex-column align-items-center opacity-50">
                                            <i class="fas fa-search fa-3x mb-3"></i>
                                            <p class="mb-0 fw-bold">Click "Fetch" to load test prices ...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <a class="btn btn-primary ai-float-btn">
        <i class="fas fa-robot"></i>
    </a>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add these before your custom JS scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Custom JS -->
    <script src="firebase_config.js"></script>
    <script src="tests/handle_tests/regular_tests.js"></script>
    <script src="tests/handle_tests/special_tests.js"></script>
    <script src="tests/handle_tests/multiple_ranges.js"></script>
    <script src="tests/handle_tests/cultures_tests.js"></script>
    <script src="tests/handle_tests/compatibility_tests.js"></script>
    <script src="tests/handle_tests/type_test_manually.js"></script>
    <script src="tests/handle_tests/pathologic_tests.js"></script>
    <script src="tests/tests_features/excel_upload_functions.js"></script>


    <script src="tests/handle_tests/tests_lists/compatibility_list.js"></script>
    <script src="tests/handle_tests/tests_lists/culture_list.js"></script>
    <script src="tests/handle_tests/tests_lists/multiple_ranges_list.js"></script>
    <script src="tests/handle_tests/tests_lists/pathologic_list.js"></script>
    <script src="tests/handle_tests/tests_lists/regular_list.js"></script>
    <script src="tests/handle_tests/tests_lists/special_list.js"></script>
    <script src="tests/tests_features/export_btn_excel.js"></script>
    <script src="tests/tests_features/price_list_excel.js"></script>
    <script src="tests/tests_ai/tests_ai.js"></script>
    <script src="logout.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="global_files/errors_handled.js"> </script>

    <script src="global_files/global_api_ai.js"></script>


    <script>

        document.getElementById('addSampleTypeManually').addEventListener('click', function () {
            document.getElementById('manualSampleTypeInput').style.display = '';
            document.getElementById('sample_type').style.display = 'none';
            document.getElementById('manualSampleTypeInput').value = '';
        });



        // Helper: Add new sample type to dropdown if not exists
        function addSampleTypeToDropdown(newType) {
            const sampleTypeSelect = document.getElementById('sample_type');
            // Check if already exists
            for (let i = 0; i < sampleTypeSelect.options.length; i++) {
                if (sampleTypeSelect.options[i].value.toLowerCase() === newType.toLowerCase()) {
                    return; // Already exists
                }
            }
            // Add to "Other" optgroup if exists, else to end
            let otherGroup = Array.from(sampleTypeSelect.getElementsByTagName('optgroup'))
                .find(g => g.label && g.label.toLowerCase().includes('other'));
            const option = document.createElement('option');
            option.value = newType;
            option.textContent = newType;
            if (otherGroup) {
                otherGroup.appendChild(option);
            } else {
                sampleTypeSelect.appendChild(option);
            }
        }

        // Save manual sample type to Firestore and dropdown
        async function saveManualSampleTypeIfNeeded() {
            const manualInput = document.getElementById('manualSampleTypeInput');
            const newType = manualInput.value.trim();
            if (!newType) return;

            // Save to Firestore (if not already present)
            const docRef = db.collection('user_manual_addition').doc('sample_types');
            const docSnap = await docRef.get();



            let types = [];
            if (docSnap.exists) {
                types = docSnap.data().types || [];
            }
            if (!types.map(t => t.toLowerCase()).includes(newType.toLowerCase())) {
                types.push(newType);
                await docRef.set({ types }, { merge: true });

                addSampleTypeToDropdown(newType);
            }
        }

        // When user leaves manual input, save if new
        document.getElementById('manualSampleTypeInput').addEventListener('blur', async function () {
            if (this.value.trim()) {
                await saveManualSampleTypeIfNeeded();

            }
            if (!this.value.trim()) {
                this.style.display = 'none';
                document.getElementById('sample_type').style.display = '';
            }
        });

        // On page load, load manual sample types from Firestore and add to dropdown
        async function loadManualSampleTypes() {
            const docRef = db.collection('user_manual_addition').doc('sample_types');
            const docSnap = await docRef.get();


            if (docSnap.exists) {
                const types = docSnap.data().types || [];
                types.forEach(addSampleTypeToDropdown);
            }
        }
        document.addEventListener('DOMContentLoaded', loadManualSampleTypes);



        document.getElementById('editSampleTypeBtn').addEventListener('click', function () {
            const sampleTypeSelect = document.getElementById('sample_type');
            const manualInput = document.getElementById('manualSampleTypeInput');
            const selectedOption = sampleTypeSelect.options[sampleTypeSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a sample type to edit.');
                return;
            }
            // Show manual input with current value
            manualInput.value = selectedOption.value;
            manualInput.style.display = '';
            sampleTypeSelect.style.display = 'none';

            // When editing is done (on blur), update the dropdown
            manualInput.onblur = async function () {
                const newValue = manualInput.value.trim();
                if (newValue && newValue !== selectedOption.value) {
                    // Update the option text/value
                    selectedOption.value = newValue;
                    selectedOption.textContent = newValue;
                    // Optionally: update in Firestore if needed
                    // (Remove old, add new)
                    const docRef = db.collection('user_manual_addition').doc('sample_types');
                    const docSnap = await docRef.get();

                    let types = [];
                    if (docSnap.exists) {
                        types = docSnap.data().types || [];
                    }
                    // Remove old, add new
                    const idx = types.findIndex(t => t.toLowerCase() === selectedOption.value.toLowerCase());
                    if (idx !== -1) types.splice(idx, 1);
                    if (!types.map(t => t.toLowerCase()).includes(newValue.toLowerCase())) {
                        types.push(newValue);
                    }
                    await docRef.set({ types }, { merge: true });

                }
                manualInput.style.display = 'none';
                sampleTypeSelect.style.display = '';
            };
        });





        ////////////////////////////////


        // Add Group Manually
        document.getElementById('addGroupManually').addEventListener('click', function () {
            document.getElementById('manualGroupInput').style.display = '';
            document.getElementById('testGroup').style.display = 'none';
            document.getElementById('manualGroupInput').value = '';
        });

        // Save manual group to Firestore and dropdown
        async function saveManualGroupIfNeeded() {
            const manualInput = document.getElementById('manualGroupInput');
            const newGroup = manualInput.value.trim();
            if (!newGroup) return;

            // Save to Firestore (if not already present)
            const docRef = db.collection('user_manual_addition').doc('groups');
            const docSnap = await docRef.get();

            let groups = [];

            if (docSnap.exists) {
                groups = docSnap.data().groups || [];
            }
            if (!groups.map(g => g.toLowerCase()).includes(newGroup.toLowerCase())) {
                groups.push(newGroup);
                await docRef.set({ groups }, { merge: true });

                addGroupToDropdown(newGroup);
            }
        }

        // Helper: Add new group to dropdown if not exists
        function addGroupToDropdown(newGroup) {
            const groupSelect = document.getElementById('testGroup');
            for (let i = 0; i < groupSelect.options.length; i++) {
                if (groupSelect.options[i].value.toLowerCase() === newGroup.toLowerCase()) {
                    return; // Already exists
                }
            }
            const option = document.createElement('option');
            option.value = newGroup;
            option.textContent = newGroup;
            groupSelect.appendChild(option);
        }

        // When user leaves manual input, save if new
        document.getElementById('manualGroupInput').addEventListener('blur', async function () {
            if (this.value.trim()) {
                await saveManualGroupIfNeeded();
            }
            if (!this.value.trim()) {
                this.style.display = 'none';
                document.getElementById('testGroup').style.display = '';
            }
        });

        // Edit Group
        document.getElementById('editGroupBtn').addEventListener('click', function () {
            const groupSelect = document.getElementById('testGroup');
            const manualInput = document.getElementById('manualGroupInput');
            const selectedOption = groupSelect.options[groupSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a group to edit.');
                return;
            }
            manualInput.value = selectedOption.value;
            manualInput.style.display = '';
            groupSelect.style.display = 'none';

            manualInput.onblur = async function () {
                const newValue = manualInput.value.trim();
                if (newValue && newValue !== selectedOption.value) {
                    selectedOption.value = newValue;
                    selectedOption.textContent = newValue;
                    // Update in Firestore
                    const docRef = db.collection('user_manual_addition').doc('groups');
                    const docSnap = await docRef.get();

                    let groups = [];
                    if (docSnap.exists) {
                        groups = docSnap.data().groups || [];
                    }
                    // Remove old, add new
                    const idx = groups.findIndex(g => g.toLowerCase() === selectedOption.value.toLowerCase());
                    if (idx !== -1) groups.splice(idx, 1);
                    if (!groups.map(g => g.toLowerCase()).includes(newValue.toLowerCase())) {
                        groups.push(newValue);
                    }
                    await docRef.set({ groups }, { merge: true });

                }
                manualInput.style.display = 'none';
                groupSelect.style.display = '';
            };
        });

        // On page load, load manual groups from Firestore and add to dropdown
        async function loadManualGroups() {
            const docRef = db.collection('user_manual_addition').doc('groups');
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const groups = docSnap.data().groups || [];
                groups.forEach(addGroupToDropdown);
            }
        }
        document.addEventListener('DOMContentLoaded', loadManualGroups);

        ///////////////////////////////////////////////////////////////////////////
        document.getElementById('priceListTestSearch').addEventListener('input', function () {
            const searchValue = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll('#priceListTableBody tr');
            rows.forEach(row => {
                // Combine all cell texts for searching
                const rowText = Array.from(row.children).map(td => td.textContent.toLowerCase()).join(' ');
                row.style.display = rowText.includes(searchValue) ? '' : 'none';
            });
        });

        // Populate all tests dropdown
        function populateAllTestsDropdown() {
            const testNameSelect = document.getElementById('test_name');
            // Clear existing options
            testNameSelect.innerHTML = '<option value="">Select a test</option>';

            // Add regular tests
            regularTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name;
                option.setAttribute('data-model', 'regular');
                testNameSelect.appendChild(option);
            });

            // Add special tests
            specialTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name + ' (Special)';
                option.setAttribute('data-model', 'special');
                testNameSelect.appendChild(option);
            });

            // Add multiple ranges tests
            multipleRangesTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name + ' (Multiple Ranges)';
                option.setAttribute('data-model', 'multiple_ranges'); // <-- FIXED
                testNameSelect.appendChild(option);
            });

            // Add culture tests
            // Add cultures tests
            culturesTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name + ' (Culture)';
                option.setAttribute('data-model', 'culture');
                testNameSelect.appendChild(option);
            });

            // Add Compatibility tests
            compatibilityTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name + ' (Compatibility)';
                option.setAttribute('data-model', 'compatibility');
                testNameSelect.appendChild(option);
            });

            // Add Pathologic tests
            pathologicTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test.name;
                option.textContent = test.name + ' (Pathologic)';
                option.setAttribute('data-model', 'pathologic');
                testNameSelect.appendChild(option);
            });
        }


        // Gather all tests into one array for Fuse.js (no model in search)
        function getAllTestsForFuse() {
            const all = [];
            regularTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'regular' }));
            specialTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'special' }));
            multipleRangesTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'multiple_ranges' }));
            culturesTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'culture' }));
            compatibilityTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'compatibility' }));
            pathologicTests.forEach(t => all.push({ name: t.name, abbreviation: t.abbreviation || '', model: 'pathologic' }));
            return all;
        }

        // Initialize Fuse.js (search only by name and abbreviation)
        let fuse;
        function initFuse() {
            const allTests = getAllTestsForFuse();
            fuse = new Fuse(allTests, {
                keys: ['name', 'abbreviation'],
                threshold: 0.4,
            });
        }
        if (typeof regularTests !== 'undefined') {
            initFuse();
        }

        // Listen to input on the search bar
        document.getElementById('testNameSearch').addEventListener('input', function () {
            const searchValue = this.value.trim();
            const testNameSelect = document.getElementById('test_name');
            // Open the dropdown programmatically (works for most browsers)
            testNameSelect.size = 6; // Show 6 results, adjust as needed

            if (!searchValue) {
                populateAllTestsDropdown();
                testNameSelect.size = 1; // Reset dropdown size
                testNameSelect.value = "";
                return;
            }
            const results = fuse.search(searchValue);

            // Clear dropdown
            testNameSelect.innerHTML = '';


            if (results.length === 1) {
                const t = results[0].item;
                const option = document.createElement('option');
                option.value = t.name;
                option.textContent = t.name + (t.abbreviation ? ` (${t.abbreviation})` : '');
                option.setAttribute('data-model', t.model); // <-- ADD THIS LINE
                testNameSelect.appendChild(option);
                testNameSelect.value = t.name;
                testNameSelect.dispatchEvent(new Event('change'));
            } else if (results.length > 1) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select a test';
                testNameSelect.appendChild(placeholder);
                results.forEach(res => {
                    const t = res.item;
                    const option = document.createElement('option');
                    option.value = t.name;
                    option.textContent = t.name + (t.abbreviation ? ` (${t.abbreviation})` : '');
                    option.setAttribute('data-model', t.model); // <-- ADD THIS LINE
                    testNameSelect.appendChild(option);
                });
                testNameSelect.value = '';
            } else {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'No test found';
                testNameSelect.appendChild(placeholder);
                testNameSelect.value = '';
            }

        });

        // Optional: When user leaves the search bar, reset dropdown size
        document.getElementById('testNameSearch').addEventListener('blur', function () {
            setTimeout(() => {
                document.getElementById('test_name').size = 1;
            }, 200);
        });

        // clear search 


        const testNameSearch = document.getElementById('testNameSearch');
        const clearTestSearch = document.getElementById('clearTestSearch');
        const testNameSelect = document.getElementById('test_name');

        // Show/hide clear button based on input
        testNameSearch.addEventListener('input', function () {
            clearTestSearch.style.display = this.value ? 'inline-block' : 'none';
            // ...existing search logic...
        });

        // Clear search and restore dropdown
        clearTestSearch.addEventListener('click', function () {
            testNameSearch.value = '';
            clearTestSearch.style.display = 'none';
            // Restore dropdown to original state
            populateAllTestsDropdown(); // This should repopulate all tests, all models/types
            testNameSelect.size = 1;    // Collapse dropdown
            testNameSelect.value = '';  // No selection
        });




        document.addEventListener('DOMContentLoaded', function () {



            // DOM Elements
            const addNewTestBtn = document.getElementById('addNewTestBtn');
            const saveTestBtn = document.getElementById('saveTestBtn');
            const addMaleRangeBtn = document.getElementById('addMaleRange');
            const addFemaleRangeBtn = document.getElementById('addFemaleRange');
            const testsTableBody = document.getElementById('testsTableBody');

            const selectAllCheckbox = document.getElementById('selectAllTestsMain');

            // When select all is clicked
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function () {
                    const checkboxes = testsTableBody.querySelectorAll('.test-row-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                });
            }

            // When any row checkbox is clicked, update select all state
            testsTableBody.addEventListener('change', function (e) {
                if (e.target.classList.contains('test-row-checkbox')) {
                    const checkboxes = testsTableBody.querySelectorAll('.test-row-checkbox');
                    const checked = testsTableBody.querySelectorAll('.test-row-checkbox:checked');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = checkboxes.length === checked.length;
                    }
                }
            });

            // Initialize the app
            function initApp() {
                auth.onAuthStateChanged(user => {
                    if (user || localStorage.getItem('isPersonalUse') === 'true') {
                        currentUser = user || { email: 'personal@datalab.ms', displayName: 'Master Admin' };
                        const email = currentUser.email;
                        fetchDoctorProfile(email);
                        loadTests();
                    } else {
                        window.location.href = 'Login.html';
                    }
                });
            }

            let currentUserPermissions = [];
            let currentUserBranch = null;

            // Fetch doctor's profile and permissions
            function fetchDoctorProfile(email) {
                db.collection('employees').doc(email).get()
                    .then((doc) => {

                        if (doc.exists) {
                            const userData = doc.data();
                            document.getElementById('userFullName').textContent =
                                `Dr. ${userData.fullName || 'User'}`;
                            document.getElementById('userBranchName').textContent =
                                `Branch: ${userData.branch || 'Branch'}`;

                            currentUserBranch = userData.branch || '';
                            currentUserPermissions = userData.permissions || [];



                            // Show only for CEO
                            if (exportExcelBtn) {
                                const isCEO = userData.majority &&
                                    String(userData.majority).toLowerCase() === 'ceo';

                                exportExcelBtn.style.display = isCEO ? 'inline-block' : 'none';

                            }

                            // Apply other permissions
                            applyTestPagePermissions(currentUserPermissions);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching user profile:", error);
                    });
            }

            // Add this function anywhere in your <script> section:
            function applyTestPagePermissions(perms) {
                // Helper to check permission (array or object)
                function hasPerm(p) {
                    if (Array.isArray(perms)) return perms.includes(p);
                    if (typeof perms === "object") return !!perms[p];
                    return false;
                }

                // Add Price List
                document.getElementById('addPriceListBtn').disabled = !hasPerm('add_price_list');
                // Delete All Tests
                document.getElementById('deleteAllTestsBtn').disabled = !hasPerm('delete_all_tests');
                // Bulk Add Tests
                document.getElementById('bulkAddTestsBtn').disabled = !hasPerm('bulk_add_tests');
                // Add New Test
                document.getElementById('addNewTestBtn').disabled = !hasPerm('add_new_test');


                document.getElementById('editTurnaroundTimeBtn').disabled = !hasPerm('edit_turnaround_time');


                // Hide or disable edit/delete icons in the table
                document.querySelectorAll('.edit-test').forEach(btn => {
                    btn.disabled = !hasPerm('edit_test');
                    if (!hasPerm('edit_test')) btn.classList.add('disabled');
                    else btn.classList.remove('disabled');
                });
                document.querySelectorAll('.delete-test').forEach(btn => {

                    btn.disabled = !hasPerm('delete_test');
                    if (!hasPerm('delete_test')) btn.classList.add('disabled');
                    else btn.classList.remove('disabled');
                });
            }
            // Load tests from Firestore






            // Helper: Render all tests from array
            function renderTestsTable(testsArr) {
                testsTableBody.innerHTML = '';
                testsArr.forEach(testObj => {
                    addTestToTable(testObj.data, testObj.id, currentUserBranch);
                });
                applyTestPagePermissions(currentUserPermissions);
            }


            async function loadTests(forceReload = false) {
                // Fetch the single document containing all tests
                const doc = await db.collection('tests_list').doc('Tests.html').get();
                const testsObj = doc.exists ? doc.data() : {};

                // Convert to array for rendering
                const testsArr = Object.entries(testsObj).map(([id, data]) => ({
                    id,
                    data
                }));

                renderTestsTable(testsArr);
            }
            window.loadTests = loadTests;


            // Update addTestToTable to accept branch name and fetch branch price
            async function addTestToTable(test, docId, branchName) {
                let branchPrice = test.price; // default to main price
                if (branchName) {
                    try {
                        const branchPriceDoc = await db
                            .collection('branches')
                            .doc(branchName)
                            .collection('normal_price_list')
                            .doc(docId)
                            .get();

                        if (branchPriceDoc.exists && branchPriceDoc.data().price !== undefined) {
                            branchPrice = branchPriceDoc.data().price;
                        }
                    } catch (e) {
                        console.warn('Could not fetch branch price for', docId, e);
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                 <td>
        <input type="checkbox" class="test-row-checkbox" data-id="${docId}">
    </td>
        <td>${test.test_name || ''}</td>
        <td>${test.test_id || ''}</td>
        <td>${test.model || ''}</td>
        <td>${test.department || ''}</td> 
        <td>${test.group || ''}</td>
        <td>${test.sample_type || ''}</td>
        <td>${test.abbreviation || ''}</td>
        <td>${test.precautions ? test.precautions.substring(0, 20) + (test.precautions.length > 20 ? '...' : '') : ''}</td>



        <td>
            <button class="btn btn-sm btn-primary edit-test" data-id="${docId}">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger delete-test" data-id="${docId}">
                <i class="fas fa-trash"></i>
            </button>
            <button class="btn btn-sm btn-labtolab ${test.lab_to_lab ? 'btn-warning' : 'btn-success'}" data-id="${docId}" title="Lab to Lab">
        <i class="fas fa-flask"></i>
    </button>
        </td>
    `;
                testsTableBody.appendChild(row);

                // Add event listeners for edit and delete buttons
                row.querySelector('.edit-test').addEventListener('click', () => editTest(docId));
                row.querySelector('.delete-test').addEventListener('click', () => deleteTest(docId));
                // Lab to Lab icon logic
                // ...inside addTestToTable...

                const labToLabBtn = row.querySelector('.btn-labtolab');
                if (labToLabBtn) {
                    labToLabBtn.addEventListener('click', async function () {
                        try {
                            const isActive = labToLabBtn.classList.contains('btn-warning');
                            // Update lab_to_lab value in the single tests document
                            await db.collection('tests_list').doc('Tests.html').set({
                                [docId]: {
                                    lab_to_lab: !isActive,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            }, { merge: true });
                            await logTestSystemAction('toggle_lab_to_lab', { test_id: docId, new_status: !isActive });

                            // Toggle button color
                            if (isActive) {
                                labToLabBtn.classList.remove('btn-warning');
                                labToLabBtn.classList.add('btn-success');
                            } else {
                                labToLabBtn.classList.remove('btn-success');
                                labToLabBtn.classList.add('btn-warning');
                            }
                        } catch (e) {
                            alert('Failed to update Lab to Lab status.');
                        }
                    });
                }
                // Apply permissions to the new row
                applyTestPagePermissions(currentUserPermissions);
            }


            async function getNextManualTestId() {
                // Query all tests with test_id >= 3030, get the max
                const snapshot = await db.collection('tests_list')
                    .where('test_id', '>=', 3030)
                    .get();

                let maxId = 3029;
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const idNum = parseInt(t.test_id, 10);
                    if (!isNaN(idNum) && idNum > maxId) maxId = idNum;
                });
                return (maxId + 1).toString();
            }

            function saveTest() {
                let test_name = document.getElementById('manualTestNameInput').value.trim();

                const testNameSelect = document.getElementById('test_name');
                const manualTestNameInput = document.getElementById('manualTestNameInput');
                if (manualTestNameInput && manualTestNameInput.style.display !== 'none') {
                    // Manual mode: get from manual input
                    test_name = manualTestNameInput.value.trim();
                } else if (testNameSelect.style.display === 'none') {
                    // Fallback: get from search input (should not happen)
                    test_name = document.getElementById('testNameSearch').value.trim();
                } else {
                    // Normal mode: get from select
                    test_name = testNameSelect.value.trim();
                }

                let sample_type = '';
                const manualSampleTypeInput = document.getElementById('manualSampleTypeInput');
                const sampleTypeSelect = document.getElementById('sample_type');
                if (manualSampleTypeInput && manualSampleTypeInput.style.display !== 'none') {
                    sample_type = manualSampleTypeInput.value.trim();
                } else {
                    sample_type = sampleTypeSelect.value.trim();
                }
                const test_id = document.getElementById('test_id').value;
                const model = document.getElementById('testModel').value;
                const group = document.getElementById('testGroup').value;

                const unit = document.getElementById('unit').value;
                const abbreviation = document.getElementById('abbreviation').value;
                const price = 0;
                const precautions = document.getElementById('precautions').value;
                const questions = document.getElementById('questions').value;
                const turnaround_time = document.getElementById('turnaround_time') ? document.getElementById('turnaround_time').value : '';

                let reference_ranges = [];
                let parameters = [];

                if (model === "Special") {
                    // Collect parameters for each gender
                    parameters = {
                        male: maleParameters.map(p => ({
                            name: p.name,
                            unit: p.unit,
                            definition: p.definition || p.stand_for || ''
                        })),
                        female: femaleParameters.map(p => ({
                            name: p.name,
                            unit: p.unit,
                            definition: p.definition || p.stand_for || ''
                        }))
                    };

                    // Collect reference ranges for each gender and age group
                    document.querySelectorAll('.male-range-item').forEach(range => {
                        let ranges = {};
                        range.querySelectorAll('.ref-range-input').forEach(input => {
                            ranges[input.dataset.param] = input.value;
                        });
                        reference_ranges.push({
                            gender: "Male",
                            age_from: parseFloat(range.querySelector('.age-from').value),
                            age_to: parseFloat(range.querySelector('.age-to').value),
                            unit: range.querySelector('.age-unit').value,
                            pregnant: false,
                            ranges
                        });
                    });
                    document.querySelectorAll('.female-range-item').forEach(range => {
                        let ranges = {};
                        range.querySelectorAll('.ref-range-input').forEach(input => {
                            ranges[input.dataset.param] = input.value;
                        });
                        reference_ranges.push({
                            gender: "Female",
                            age_from: parseFloat(range.querySelector('.age-from').value),
                            age_to: parseFloat(range.querySelector('.age-to').value),
                            unit: range.querySelector('.age-unit').value,
                            pregnant: range.querySelector('.pregnant-check')?.checked || false,
                            ranges
                        });
                    });
                } else if (model === "Multiple Ranges") {
                    // Multiple Ranges logic



                    document.querySelectorAll('.male-range-item').forEach(range => {
                        const ageFromEl = range.querySelector('.age-from');
                        const ageToEl = range.querySelector('.age-to');
                        const ageUnitEl = range.querySelector('.age-unit');
                        const rangeValueEl = range.querySelector('.range-value');
                        if (!ageFromEl || !ageToEl || !ageUnitEl || !rangeValueEl) {
                            console.warn('Missing input in male-range-item:', { ageFromEl, ageToEl, ageUnitEl, rangeValueEl });
                            return; // skip this range if any input is missing
                        }
                        reference_ranges.push({
                            gender: "Male",
                            age_from: parseFloat(ageFromEl.value),
                            age_to: parseFloat(ageToEl.value),
                            unit: ageUnitEl.value,
                            range: rangeValueEl.value,
                            pregnant: false
                        });
                    });


                    document.querySelectorAll('.male-range-item').forEach(range => {
                        // Collect parameter/value pairs from the table
                        const rangesArr = [];
                        range.querySelectorAll('.ranges-table-body tr').forEach(row => {
                            const labelInput = row.querySelector('.param-label');
                            const valueInput = row.querySelector('.param-value');
                            const label = labelInput ? labelInput.value.trim() : '';
                            const value = valueInput ? valueInput.value.trim() : '';
                            if (label && value) {
                                rangesArr.push({ label, value });
                            }
                        });

                        reference_ranges.push({
                            gender: "Male",
                            age_from: parseFloat(range.querySelector('.age-from').value),
                            age_to: parseFloat(range.querySelector('.age-to').value),
                            age_type: "years", // adjust if you support other units
                            pregnant: false,
                            ranges: rangesArr
                        });
                    });

                    document.querySelectorAll('.female-range-item').forEach(range => {
                        const rangesArr = [];
                        range.querySelectorAll('.ranges-table-body tr').forEach(row => {
                            const label = row.querySelector('.param-label')?.value?.trim();
                            const value = row.querySelector('.param-value')?.value?.trim();
                            if (label && value) {
                                rangesArr.push({ label, value });
                            }
                        });

                        reference_ranges.push({
                            gender: "Female",
                            age_from: parseFloat(range.querySelector('.age-from').value),
                            age_to: parseFloat(range.querySelector('.age-to').value),
                            age_type: "years", // adjust if you support other units
                            pregnant: range.querySelector('.pregnant-check')?.checked || false,
                            ranges: rangesArr
                        });
                    });
                    // In your saveTest function, update the Culture section to:
                } else if (model === "Culture") {
                    // Use getCultureTestData to get the correct structure
                    const cultureData = getCultureTestData();
                    reference_ranges = cultureData.reference_ranges;
                    parameters = cultureData.main_parameters;
                } // Regular test logic (as before)



                if (model === "Compatibility") {
                    // Male ranges
                    document.querySelectorAll('.male-range-item').forEach(range => {
                        const age_from = parseFloat(range.querySelector('.age-from').value);
                        const age_to = parseFloat(range.querySelector('.age-to').value);
                        const age_type = range.querySelector('.age-unit').value;
                        const parameters = [];
                        range.querySelectorAll('.parameters-table-body tr').forEach(row => {
                            const name = row.querySelector('.param-name')?.value?.trim();
                            const value = row.querySelector('.param-value')?.value?.trim();
                            // Save both name and value, even if value is empty
                            if (name) parameters.push({ name, value });
                        });
                        reference_ranges.push({
                            gender: "Male",
                            age_from,
                            age_to,
                            age_type,
                            parameters
                        });
                    });
                    // Female ranges
                    document.querySelectorAll('.female-range-item').forEach(range => {
                        const age_from = parseFloat(range.querySelector('.age-from').value);
                        const age_to = parseFloat(range.querySelector('.age-to').value);
                        const age_type = range.querySelector('.age-unit').value;
                        const parameters = [];
                        range.querySelectorAll('.parameters-table-body tr').forEach(row => {
                            const name = row.querySelector('.param-name')?.value?.trim();
                            const value = row.querySelector('.param-value')?.value?.trim();
                            if (name) parameters.push({ name, value });
                        });
                        reference_ranges.push({
                            gender: "Female",
                            age_from,
                            age_to,
                            age_type,
                            parameters
                        });
                    });
                }
                if (model === "Pathologic") {
                    // Male ranges
                    document.querySelectorAll('.male-range-item').forEach(range => {
                        const age_from = parseFloat(range.querySelector('.age-from').value);
                        const age_to = parseFloat(range.querySelector('.age-to').value);
                        const age_type = range.querySelector('.age-unit').value;
                        const parameters = [];
                        range.querySelectorAll('.parameters-table-body tr').forEach(row => {
                            const name = row.querySelector('.param-name')?.value?.trim();
                            const value = row.querySelector('.param-value')?.value?.trim();
                            // Save both name and value, even if value is empty
                            if (name) parameters.push({ name, value });
                        });
                        reference_ranges.push({
                            gender: "Male",
                            age_from,
                            age_to,
                            age_type,
                            parameters
                        });
                    });
                    // Female ranges
                    document.querySelectorAll('.female-range-item').forEach(range => {
                        const age_from = parseFloat(range.querySelector('.age-from').value);
                        const age_to = parseFloat(range.querySelector('.age-to').value);
                        const age_type = range.querySelector('.age-unit').value;
                        const parameters = [];
                        range.querySelectorAll('.parameters-table-body tr').forEach(row => {
                            const name = row.querySelector('.param-name')?.value?.trim();
                            const value = row.querySelector('.param-value')?.value?.trim();
                            if (name) parameters.push({ name, value });
                        });
                        reference_ranges.push({
                            gender: "Female",
                            age_from,
                            age_to,
                            age_type,
                            parameters
                        });
                    });
                }

                if (model === "Regular") {
                    document.querySelectorAll('.male-range-item').forEach(range => {
                        const ageFromEl = range.querySelector('.age-from');
                        const ageToEl = range.querySelector('.age-to');
                        const ageUnitEl = range.querySelector('.age-unit');
                        const rangeValueEl = range.querySelector('.range-value');
                        if (!ageFromEl || !ageToEl || !ageUnitEl || !rangeValueEl) {
                            console.warn('Missing input in male-range-item:', { ageFromEl, ageToEl, ageUnitEl, rangeValueEl });
                            return; // skip this range if any input is missing
                        }
                        reference_ranges.push({
                            gender: "Male",
                            age_from: parseFloat(ageFromEl.value),
                            age_to: parseFloat(ageToEl.value),
                            unit: ageUnitEl.value,
                            range: rangeValueEl.value,
                            pregnant: false
                        });
                    });
                    document.querySelectorAll('.female-range-item').forEach(range => {
                        const ageFromEl = range.querySelector('.age-from');
                        const ageToEl = range.querySelector('.age-to');
                        const ageUnitEl = range.querySelector('.age-unit');
                        const rangeValueEl = range.querySelector('.range-value');
                        const pregnantEl = range.querySelector('.pregnant-check');
                        if (!ageFromEl || !ageToEl || !ageUnitEl || !rangeValueEl) {
                            console.warn('Missing input in female-range-item:', { ageFromEl, ageToEl, ageUnitEl, rangeValueEl });
                            return; // skip this range if any input is missing
                        }
                        reference_ranges.push({
                            gender: "Female",
                            age_from: parseFloat(ageFromEl.value),
                            age_to: parseFloat(ageToEl.value),
                            unit: ageUnitEl.value,
                            range: rangeValueEl.value,
                            pregnant: pregnantEl?.checked || false
                        });
                    });
                }
                let department = '';
                const manualDepartmentInput = document.getElementById('manualDepartmentInput');
                const departmentSelect = document.getElementById('testDepartment');
                if (manualDepartmentInput && manualDepartmentInput.style.display !== 'none') {
                    department = manualDepartmentInput.value.trim();
                } else if (departmentSelect) {
                    department = departmentSelect.value.trim();
                }

                // Prepare test data
                const testData = {
                    test_name,
                    test_id,
                    model,
                    department,
                    group,
                    sample_type,
                    unit,
                    abbreviation,
                    price,
                    precautions,
                    questions,
                    parameters, // Only for special tests, can be empty for regular
                    reference_ranges,
                    createdBy: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),

                    entry_mode: manualTestNameInput && manualTestNameInput.style.display !== 'none' ? "manually" : "normal"

                };

                // Save to Firestore
                const safeDocId = test_name.replace(/\//g, '-');
                db.collection('tests_list').doc('Tests.html').set({
                    [test_id]: testData
                }, { merge: true })
                    .then(async () => {
                        await logTestSystemAction('save_test', { test_id, test_name });
                        alert('Test saved successfully!');
                        $('#testModal').modal('hide');
                        loadTests(true);
                    })
                    .catch(error => {
                        console.error("Error saving test: ", error);
                        alert("Error saving test. Please try again.");
                    });
            }

            window.saveTest = saveTest; // <-- Add this line

            async function editTest(docId) {

                try {
                    const doc = await db.collection('tests_list').doc('Tests.html').get();
                    const testsObj = doc.exists ? doc.data() : {};
                    const test = testsObj[docId]; // <-- Get the test by docId

                    if (!test) {
                        alert('Test not found!');
                        return;
                    }

                    // Open modal and reset form
                    $('#testModal').modal('show');
                    document.getElementById('testForm').reset();
                    document.getElementById('maleRangesContainer').innerHTML = '';
                    document.getElementById('femaleRangesContainer').innerHTML = '';
                    document.getElementById('maleParametersEditor').innerHTML = '';
                    document.getElementById('femaleParametersEditor').innerHTML = '';
                    document.getElementById('testModalLabel').textContent = 'Edit Test';

                    // Populate dropdowns
                    populateAllTestsDropdown();

                    // Set fields
                    document.getElementById('test_name').value = test.test_name || '';
                    document.getElementById('test_id').value = test.test_id || '';
                    document.getElementById('testDepartment').value = test.department || '';
                    document.getElementById('testModel').value = test.model || '';
                    document.getElementById('testGroup').value = test.group || '';
                    document.getElementById('sample_type').value = test.sample_type || '';
                    document.getElementById('unit').value = test.unit || '';
                    document.getElementById('abbreviation').value = test.abbreviation || '';
                    document.getElementById('precautions').value = test.precautions || '';
                    document.getElementById('questions').value = test.questions || '';

                    // Save docId for update
                    document.getElementById('testForm').setAttribute('data-edit-id', docId);



                    // Detect if test_name is in the dropdown options
                    const testNameSelect = document.getElementById('test_name');
                    const manualTestNameInput = document.getElementById('manualTestNameInput');
                    const testNameSearchLabel = document.getElementById('testNameSearchLabel');
                    const testNamelabel = document.getElementById('testNamelabel');
                    const sampleTypeSelect = document.getElementById('sample_type');
                    const manualSampleTypeInput = document.getElementById('manualSampleTypeInput');
                    let foundSampleType = false;
                    for (let i = 0; i < sampleTypeSelect.options.length; i++) {
                        if (sampleTypeSelect.options[i].value === test.sample_type) {
                            foundSampleType = true;
                            break;
                        }
                    }
                    if (!foundSampleType && test.sample_type) {
                        manualSampleTypeInput.style.display = '';
                        sampleTypeSelect.style.display = 'none';
                        manualSampleTypeInput.value = test.sample_type;
                    } else {
                        manualSampleTypeInput.style.display = 'none';
                        sampleTypeSelect.style.display = '';
                        sampleTypeSelect.value = test.sample_type || '';
                    }
                    manualTestNameInput.style.display = '';
                    testNameSelect.style.display = 'none';
                    testNameSearchLabel.style.display = 'none';
                    testNamelabel.style.display = 'none';
                    manualTestNameInput.value = test.test_name || '';



                    // Populate reference ranges and parameters by model
                    if (test.model === 'Regular') {
                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") addMaleRange(range);
                            else if (range.gender === "Female") addFemaleRange(range);
                        });
                    } else if (test.model === 'Special') {
                        // Set up parameters
                        maleParameters = (test.parameters?.male || []).map(p => ({ ...p }));
                        femaleParameters = (test.parameters?.female || []).map(p => ({ ...p }));
                        renderParametersEditor('maleParametersEditor', maleParameters, () => rerenderAgeGroups('male', test));
                        renderParametersEditor('femaleParametersEditor', femaleParameters, () => rerenderAgeGroups('female', test));


                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") addSpecialMaleRange(range);
                            else if (range.gender === "Female") addSpecialFemaleRange(range);
                        });
                    } else if (test.model === 'Multiple Ranges') {
                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") addMultipleMaleRange(range);
                            else if (range.gender === "Female") addMultipleFemaleRange(range);
                        });
                    } else if (test.model === 'Culture') {
                        const mainParams = test.main_parameters || test.parameters || [];
                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") addCultureMaleRange(range, mainParams);
                            else if (range.gender === "Female") addCultureFemaleRange(range, mainParams);
                        });
                    } else if (test.model === 'Compatibility') {
                        // Populate reference ranges for Compatibility model
                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") {
                                addCompatibilityMaleRange(range, range.parameters || []);
                            } else if (range.gender === "Female") {
                                addCompatibilityFemaleRange(range, range.parameters || []);
                            }
                        });
                    }
                    else if (test.model === 'Pathologic') {
                        // Populate reference ranges for Pathologic model
                        (test.reference_ranges || []).forEach(range => {
                            if (range.gender === "Male") {
                                addPathologicMaleRange(range, range.parameters || []);
                            } else if (range.gender === "Female") {
                                addPathologicFemaleRange(range, range.parameters || []);
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error editing test: ", error);
                    alert("Error loading test for editing.");
                }
            }





            // Event Listeners
            // In your DOMContentLoaded handler, update the addNewTestBtn event listener:

            addNewTestBtn.addEventListener('click', function () {
                // Reset form
                document.getElementById('testForm').reset();
                document.getElementById('maleRangesContainer').innerHTML = '';
                document.getElementById('femaleRangesContainer').innerHTML = '';
                document.getElementById('testModalLabel').textContent = 'Add New Test';
                document.getElementById('testModalLabel').textContent = 'Add New Test';
                populateAllTestsDropdown();

                // Add one default range for each gender
                addMaleRange();
                addFemaleRange();


            });

            saveTestBtn.addEventListener('click', saveTest);



            addMaleRangeBtn.addEventListener('click', function () {
                const model = document.getElementById('testModel').value.trim().toLowerCase();
                if (model === 'regular') {
                    addMaleRange();
                } else if (model === 'multiple ranges' || model === 'multiple_ranges') {
                    // Add a blank male range for Multiple Ranges model
                    addMultipleMaleRange({
                        age_from: '',
                        age_to: '',
                        ranges: [{ label: '', value: '' }]
                    });
                } else if (model === 'culture') {
                    addCultureMaleRange({
                        age_from: '',
                        age_to: '',
                        pregnant: false,
                        antibiotics: [{ name: '', sensitivity: '' }]
                    });
                } else if (model === 'special') {
                    // You may want to pass the current male parameters if available
                    addSpecialMaleRange({
                        age_from: '',
                        age_to: '',
                        unit: 'years',
                        ranges: {}
                    });
                } else if (model === 'compatibility') {
                    // Add a blank male range for Compatibility model
                    addCompatibilityMaleRange({
                        age_from: '',
                        age_to: '',
                        age_type: 'years',
                        parameters: [{ name: '', value: '' }]
                    });
                }
                else if (model === 'pathologic') {

                    addPathologicMaleRange({
                        age_from: '',
                        age_to: '',
                        age_type: 'years',
                        parameters: [{ name: '', value: '' }]
                    })



                }


                else {
                    alert('You can only add male age ranges for Regular or Multiple Ranges model tests.');
                }
            });





            addFemaleRangeBtn.addEventListener('click', function () {
                const model = document.getElementById('testModel').value.trim().toLowerCase();
                if (model === 'regular') {
                    addFemaleRange();
                } else if (model === 'multiple ranges' || model === 'multiple_ranges') {
                    addMultipleFemaleRange({
                        age_from: '',
                        age_to: '',
                        pregnant: false,
                        ranges: [{ label: '', value: '' }]
                    });
                } else if (model === 'culture') {
                    addCultureFemaleRange({
                        age_from: '',
                        age_to: '',
                        pregnant: false,
                        antibiotics: [{ name: '', sensitivity: '' }]
                    });
                } else if (model === 'special') {
                    // You may want to pass the current male parameters if available
                    addSpecialFemaleRange({
                        age_from: '',
                        age_to: '',
                        unit: 'years',
                        ranges: {}
                    });
                } else if (model === 'compatibility') {
                    // Add a blank female range for Compatibility model
                    addCompatibilityFemaleRange({
                        age_from: '',
                        age_to: '',
                        age_type: 'years',
                        parameters: [{ name: '', value: '' }]
                    });
                } else if (model === 'pathologic') {

                    addPathologicFemaleRange({
                        age_from: '',
                        age_to: '',
                        age_type: 'years',
                        parameters: [{ name: '', value: '' }]
                    })



                } else {
                    alert('You can only add female age ranges for Regular, Multiple Ranges, or Culture model tests.');
                }
            });


            // Call one by default on page load
            populateRegularTests();
            populateMultipleRangesTestsDropdown();

            // Initialize the app
            initApp();


        });
        document.getElementById('addNewTestBtn').addEventListener('click', function () {
            document.getElementById('manualTestNameInput').style.display = 'none';
            document.getElementById('test_name').style.display = '';
            document.getElementById('manualTestNameInput').value = '';
        });
        //***************************** edit parameters of special tests ******************************//
        // In your DOMContentLoaded or after the DOM is ready:
        document.getElementById('test_name').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const model = selectedOption.getAttribute('data-model');
            // Only clear the correct containers!
            document.getElementById('maleRangesContainer').innerHTML = '';
            document.getElementById('femaleRangesContainer').innerHTML = '';
            document.getElementById('maleParametersEditor').innerHTML = '';
            document.getElementById('femaleParametersEditor').innerHTML = '';

            const selectedName = this.value;
            if (selectedName) {
                document.getElementById('manualTestNameInput').value = selectedName;
                document.getElementById('manualTestNameInput').style.display = '';
                this.style.display = 'none';
                // Optionally hide search label, etc.
            }
            if (model === 'pathologic') {
                const selectedTest = pathologicTests.find(t => t.name === this.value);
                if (selectedTest) {
                    document.getElementById('testModel').value = 'Pathologic';
                    document.getElementById('testDepartment').value = selectedTest.department || ''; // <-- Add here

                    document.getElementById('test_id').value = selectedTest.test_id || '';
                    document.getElementById('testGroup').value = selectedTest.group || '';
                    document.getElementById('sample_type').value = selectedTest.sample_type || '';
                    document.getElementById('unit').value = '';
                    document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                    document.getElementById('precautions').value = selectedTest.precautions || '';
                    document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                        ? selectedTest.questions.join('\n')
                        : (selectedTest.questions || '');



                    // If there are reference_ranges, use them; otherwise, create default ranges with parameters
                    const ranges = (selectedTest.reference_ranges && selectedTest.reference_ranges.length)
                        ? selectedTest.reference_ranges
                        : [
                            {
                                gender: "Male",
                                age_from: '',
                                age_to: '',
                                age_type: 'years',
                                parameters: (selectedTest.parameters || []).map(p => ({ name: p.name, value: '' }))
                            },
                            {
                                gender: "Female",
                                age_from: '',
                                age_to: '',
                                age_type: 'years',
                                parameters: (selectedTest.parameters || []).map(p => ({ name: p.name, value: '' }))
                            }
                        ];

                    ranges.forEach(range => {
                        if (range.gender === 'Male') {
                            addPathologicMaleRange(range, selectedTest.parameters);
                        } else if (range.gender === 'Female') {
                            addPathologicFemaleRange(range, selectedTest.parameters);
                        }
                    });
                }
                return;
            }
            if (model === 'compatibility') {
                const selectedTest = compatibilityTests.find(t => t.name === this.value);
                if (selectedTest) {
                    document.getElementById('testModel').value = 'Compatibility';
                    document.getElementById('testDepartment').value = selectedTest.department || '';
                    document.getElementById('testGroup').value = selectedTest.group || '';
                    document.getElementById('sample_type').value = selectedTest.sample_type || '';
                    document.getElementById('test_id').value = selectedTest.test_id || '';
                    document.getElementById('unit').value = '';
                    document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                    document.getElementById('precautions').value = selectedTest.precautions || '';
                    document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                        ? selectedTest.questions.join('\n')
                        : (selectedTest.questions || '');

                    // If there are reference_ranges, use them; otherwise, create default ranges with parameters
                    const ranges = (selectedTest.reference_ranges && selectedTest.reference_ranges.length)
                        ? selectedTest.reference_ranges
                        : [
                            {
                                gender: "Male",
                                age_from: '',
                                age_to: '',
                                age_type: 'years',
                                parameters: (selectedTest.parameters || []).map(p => ({ name: p.name, value: '' }))
                            },
                            {
                                gender: "Female",
                                age_from: '',
                                age_to: '',
                                age_type: 'years',
                                parameters: (selectedTest.parameters || []).map(p => ({ name: p.name, value: '' }))
                            }
                        ];

                    ranges.forEach(range => {
                        if (range.gender === 'Male') {
                            addCompatibilityMaleRange(range, selectedTest.parameters);
                        } else if (range.gender === 'Female') {
                            addCompatibilityFemaleRange(range, selectedTest.parameters);
                        }
                    });
                }
                return;
            }

            if (model === 'culture') {
                const selectedTest = culturesTests.find(t => t.name === this.value);
                if (selectedTest) {
                    document.getElementById('testModel').value = 'Culture';
                    document.getElementById('testDepartment').value = selectedTest.department || '';
                    document.getElementById('test_id').value = selectedTest.test_id || '';
                    document.getElementById('testGroup').value = selectedTest.group || '';
                    document.getElementById('sample_type').value = selectedTest.sample_type || '';
                    document.getElementById('unit').value = '';
                    document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                    document.getElementById('precautions').value = selectedTest.precautions || '';
                    document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                        ? selectedTest.questions.join('\n')
                        : (selectedTest.questions || '');

                    // Populate reference ranges (parameters) for each gender
                    // Assuming you have selectedTest as the current test object
                    selectedTest.reference_ranges.forEach(range => {
                        if (range.gender === 'Male') {
                            addCultureMaleRange(range, selectedTest.main_parameters);
                        } else if (range.gender === 'Female') {
                            addCultureFemaleRange(range, selectedTest.main_parameters);
                        }
                    });
                }


                return;
            }

            if (model === 'multiple_ranges') {
                const selectedTest = multipleRangesTests.find(t => t.name === this.value);
                if (selectedTest) {
                    document.getElementById('testModel').value = 'Multiple Ranges';
                    document.getElementById('testDepartment').value = selectedTest.department || '';
                    document.getElementById('test_id').value = selectedTest.test_id || '';
                    document.getElementById('testGroup').value = selectedTest.group || '';
                    document.getElementById('sample_type').value = selectedTest.sample_type || '';
                    document.getElementById('unit').value = selectedTest.unit || '';
                    document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                    document.getElementById('precautions').value = selectedTest.precautions || '';
                    document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                        ? selectedTest.questions.join('\n')
                        : (selectedTest.questions || '');
                    // Populate reference ranges
                    selectedTest.reference_ranges.forEach(range => {
                        if (range.gender === "Male") {
                            addMultipleMaleRange(range); // from multiple_ranges.js
                        } else if (range.gender === "Female") {
                            addMultipleFemaleRange(range); // from multiple_ranges.js
                        }
                    });
                }
                return; // Stop further processing
            }

            if (model === 'special') {
                const selectedTest = specialTests.find(t => t.name === this.value);
                if (selectedTest) {
                    document.getElementById('testModel').value = 'Special';
                    document.getElementById('testDepartment').value = selectedTest.department || '';
                    document.getElementById('test_id').value = selectedTest.test_id || '';
                    document.getElementById('testGroup').value = selectedTest.group || '';
                    document.getElementById('sample_type').value = selectedTest.sample_type || '';
                    document.getElementById('unit').value = selectedTest.parameters?.[0]?.unit || '';
                    document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                    document.getElementById('precautions').value = selectedTest.precautions || '';
                    document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                        ? selectedTest.questions.join('\n')
                        : (selectedTest.questions || '');

                    // Use flattenParameters here!
                    maleParameters = flattenParameters(selectedTest.parameters || []);
                    femaleParameters = flattenParameters(selectedTest.parameters || []);

                    renderParametersEditor('maleParametersEditor', maleParameters, () => {
                        renderParametersEditor('maleParametersEditor', maleParameters, () => rerenderAgeGroups('male', selectedTest));
                        rerenderAgeGroups('male', selectedTest);
                    });

                    renderParametersEditor('femaleParametersEditor', femaleParameters, () => {
                        renderParametersEditor('femaleParametersEditor', femaleParameters, () => rerenderAgeGroups('female', selectedTest));
                        rerenderAgeGroups('female', selectedTest);
                    });



                    selectedTest.reference_ranges.forEach(range => {
                        if (range.gender === "Male") {
                            addSpecialMaleRange(range);
                        } else if (range.gender === "Female") {
                            addSpecialFemaleRange(range);
                        }
                    });
                } else if (model === 'regular') {
                    const selectedTest = regularTests.find(t => t.name === this.value);
                    if (selectedTest) {
                        // Populate regular test fields
                        document.getElementById('testModel').value = 'Regular';
                        document.getElementById('testDepartment').value = selectedTest.department || '';
                        document.getElementById('testGroup').value = selectedTest.group || '';
                        document.getElementById('test_id').value = selectedTest.test_id || '';
                        document.getElementById('sample_type').value = selectedTest.sample_type || '';
                        document.getElementById('unit').value = selectedTest.unit || '';
                        document.getElementById('abbreviation').value = selectedTest.abbreviation || '';
                        document.getElementById('precautions').value = selectedTest.precautions || '';
                        document.getElementById('questions').value = Array.isArray(selectedTest.questions)
                            ? selectedTest.questions.join('\n')
                            : (selectedTest.questions || '');

                        // Populate reference ranges for regular test
                        selectedTest.reference_ranges.forEach(range => {
                            if (range.gender === "Male") {
                                addMaleRange(range); // from regular_tests.js
                            } else if (range.gender === "Female") {
                                addFemaleRange(range); // from regular_tests.js
                            }
                        });
                    }
                }
            } else {
                // Clear all fields if nothing selected
                document.getElementById('testModel').value = '';
                document.getElementById('testGroup').value = '';
                document.getElementById('sample_type').value = '';
                document.getElementById('unit').value = '';
                document.getElementById('abbreviation').value = '';
            }
        });



        // change model header color 


        document.getElementById('test_name').addEventListener('change', function () {

        });



        // Export table to PDF
        function exportTestsTableToPDF() {
            // Get table headers
            const headers = [];
            document.querySelectorAll('#testsTable thead th').forEach(th => {
                headers.push(th.textContent.trim());
            });

            // Get table rows
            const rows = [];
            document.querySelectorAll('#testsTable tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach((td, idx) => {
                    // Skip the last column (Actions)
                    if (idx < headers.length - 1) {
                        row.push(td.textContent.trim());
                    }
                });
                rows.push(row);
            });

            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Laboratory Tests List", 14, 14);
            doc.autoTable({
                head: [headers.slice(0, headers.length - 1)], // Exclude Actions column
                body: rows,
                startY: 20,
                styles: { fontSize: 9 }
            });

            doc.save("tests_list.pdf");
        }

        // Add event listener
        document.getElementById('exportPdfBtn').addEventListener('click', exportTestsTableToPDF);

        // price test model


        // Modal references
        const priceListModal = new bootstrap.Modal(document.getElementById('priceListModal'));
        const addPriceListBtn = document.getElementById('addPriceListBtn');
        const priceListTableBody = document.getElementById('priceListTableBody');
        const applyGlobalChange = document.getElementById('applyGlobalChange');
        const globalChangeInputGroup = document.getElementById('globalChangeInputGroup');
        const applyGlobalChangeBtn = document.getElementById('applyGlobalChangeBtn');
        const saveAllPricesBtn = document.getElementById('saveAllPricesBtn');

        // Show modal on button click
        addPriceListBtn.addEventListener('click', () => {
            loadBranchesForPriceList();
            loadTestsForPriceChange();
            priceListModal.show();
        });


        async function loadTestsForPriceChange() {
            priceListTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading tests...</td></tr>';
            const selectedBranch = document.getElementById('branchPriceListSelect').value;

            // Fetch all tests from the single document
            const doc = await db.collection('tests_list').doc('Tests.html').get();
            const testsObj = doc.exists ? doc.data() : {};
            const testsArr = Object.entries(testsObj).map(([id, test]) => ({ id, ...test }));

            let normalPrices = {};
            let minPrices = {};

            if (selectedBranch) {
                // Fetch all prices from the single 'prices' document for the branch
                const [normalPricesDoc, minPricesDoc] = await Promise.all([
                    db.collection('branches').doc(selectedBranch).collection('normal_price_list').doc('prices').get(),
                    db.collection('branches').doc(selectedBranch).collection('min_price_list').doc('prices').get()
                ]);
                normalPrices = normalPricesDoc.exists ? normalPricesDoc.data() : {};
                minPrices = minPricesDoc.exists ? minPricesDoc.data() : {};
            }

            priceListTableBody.innerHTML = '';
            if (testsArr.length === 0) {
                priceListTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No tests found</td></tr>';
                return;
            }
            testsArr.forEach(test => {
                const normalPrice = normalPrices[test.id];
                const minPrice = minPrices[test.id];
                const priceToShow = normalPrice !== undefined ? normalPrice : test.price;
                const minPriceToShow = minPrice !== undefined ? minPrice : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${test.test_name}</td>
            <td>${test.test_id || ''}</td>
            <td>
                ${priceToShow !== undefined ? Number(priceToShow).toFixed(2) : '0.00'} EGP
            </td>
            <td>
                <input type="number" class="form-control test-new-price" 
                    data-test-id="${test.id}" 
                    value="${priceToShow !== undefined ? Number(priceToShow).toFixed(2) : '0.00'}" 
                    min="0" step="0.01">
            </td>
            <td>
                <input type="number" class="form-control test-min-price" 
                    data-test-id="${test.id}" 
                    value="${minPriceToShow !== undefined ? Number(minPriceToShow).toFixed(2) : '0.00'}" 
                    min="0" step="0.01">
            </td>
            <td>
                <button class="btn btn-success btn-sm save-price-btn" data-test-id="${test.id}" title="Save Price">
                    <i class="fas fa-save"></i>
                </button>
            </td>
        `;
                priceListTableBody.appendChild(row);
            });
        }

        document.getElementById('priceListTableBody').addEventListener('click', async function (e) {
            if (e.target.closest('.save-price-btn')) {
                const btn = e.target.closest('.save-price-btn');
                const testId = btn.getAttribute('data-test-id');
                const selectedBranch = document.getElementById('branchPriceListSelect').value;
                if (!selectedBranch) {
                    alert('Please select a branch to save prices.');
                    return;
                }
                // Find the row for this test
                const row = btn.closest('tr');
                const newPriceInput = row.querySelector('.test-new-price');
                const minPriceInput = row.querySelector('.test-min-price');
                const newPrice = parseFloat(newPriceInput.value);
                const minPrice = parseFloat(minPriceInput.value);

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    // Update the single prices document for normal price
                    await db.collection('branches').doc(selectedBranch)
                        .collection('normal_price_list').doc('prices').set({
                            [testId]: newPrice,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                    // Update the single prices document for min price
                    await db.collection('branches').doc(selectedBranch)
                        .collection('min_price_list').doc('prices').set({
                            [testId]: minPrice,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                    await logTestSystemAction('save_price', { test_id: testId, branch: selectedBranch, price: newPrice, min_price: minPrice });

                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                        btn.disabled = false;
                    }, 1000);
                } catch (error) {
                    alert('Error saving price. Please try again.');
                    btn.innerHTML = '<i class="fas fa-save"></i>';
                    btn.disabled = false;
                }
            }
        });



        document.getElementById('branchPriceListSelect').addEventListener('change', loadTestsForPriceChange);
        // Toggle between new price and min price application
        document.getElementById('applyToNewPrice').addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('applyToMinPrice').checked = false;
            }
        });

        document.getElementById('applyToMinPrice').addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('applyToNewPrice').checked = false;
            }
        });
        // Global change checkbox event
        applyGlobalChange.addEventListener('change', (e) => {
            globalChangeInputGroup.style.display = e.target.checked ? 'flex' : 'none';
        });


        // Apply global change button
        applyGlobalChangeBtn.addEventListener('click', () => {
            const changeType = document.getElementById('changeType').value;
            const changeValue = parseFloat(document.getElementById('globalChangeValue').value);
            const applyToNewPrice = document.getElementById('applyToNewPrice').checked;
            const applyToMinPrice = document.getElementById('applyToMinPrice').checked;

            if (isNaN(changeValue)) {
                alert('Please enter a valid number');
                return;
            }

            if (!applyToNewPrice && !applyToMinPrice) {
                alert('Please select at least one price type to apply changes to');
                return;
            }

            if (applyToNewPrice) {
                const priceInputs = document.querySelectorAll('.test-new-price');
                priceInputs.forEach(input => {
                    const currentPrice = parseFloat(input.value);
                    let newPrice = currentPrice;
                    if (changeType === 'percentage') {
                        newPrice = currentPrice * (1 + (changeValue / 100));
                    } else {
                        newPrice = currentPrice + changeValue;
                    }
                    input.value = Math.max(0, newPrice).toFixed(2);
                });
            }

            if (applyToMinPrice) {
                const minPriceInputs = document.querySelectorAll('.test-min-price');
                minPriceInputs.forEach(input => {
                    const currentPrice = parseFloat(input.value);
                    let newPrice = currentPrice;
                    if (changeType === 'percentage') {
                        newPrice = currentPrice * (1 + (changeValue / 100));
                    } else {
                        newPrice = currentPrice + changeValue;
                    }
                    input.value = Math.max(0, newPrice).toFixed(2);
                });
            }
        });
        // Save all prices button

        saveAllPricesBtn.addEventListener('click', async () => {
            const priceInputs = document.querySelectorAll('.test-new-price');
            const minPriceInputs = document.querySelectorAll('.test-min-price');
            const selectedBranch = document.getElementById('branchPriceListSelect').value;

            if (!selectedBranch) {
                alert('Please select a branch to save prices.');
                return;
            }

            // Build price objects for all tests
            const normalPrices = {};
            priceInputs.forEach(input => {
                const test_id = input.getAttribute('data-test-id');
                const newPrice = parseFloat(input.value);
                if (!isNaN(newPrice)) {
                    normalPrices[test_id] = newPrice;
                }
            });

            const minPrices = {};
            minPriceInputs.forEach(input => {
                const test_id = input.getAttribute('data-test-id');
                const minPrice = parseFloat(input.value);
                if (!isNaN(minPrice)) {
                    minPrices[test_id] = minPrice;
                }
            });

            if (Object.keys(normalPrices).length === 0 && Object.keys(minPrices).length === 0) {
                alert('No changes to save');
                return;
            }

            saveAllPricesBtn.disabled = true;
            saveAllPricesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // Save all normal prices in one document
                await db.collection('branches').doc(selectedBranch)
                    .collection('normal_price_list').doc('prices').set({
                        ...normalPrices,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                // Save all min prices in one document
                await db.collection('branches').doc(selectedBranch)
                    .collection('min_price_list').doc('prices').set({
                        ...minPrices,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                await logTestSystemAction('save_all_prices', { branch: selectedBranch });

                alert('All prices updated successfully for branch: ' + selectedBranch);
                priceListModal.hide();
            } catch (error) {
                alert("Error updating some prices. Please check the console for details.");
                console.error(error);
            } finally {
                saveAllPricesBtn.disabled = false;
                saveAllPricesBtn.innerHTML = '<i class="fas fa-save"></i> Save All Changes';
            }
        });

        document.getElementById('refreshTestModalBtn').addEventListener('click', function () {
            // Reset form and containers as when opening the modal
            document.getElementById('testForm').reset();
            document.getElementById('maleRangesContainer').innerHTML = '';
            document.getElementById('femaleRangesContainer').innerHTML = '';
            document.getElementById('maleParametersEditor').innerHTML = '';
            document.getElementById('femaleParametersEditor').innerHTML = '';
            document.getElementById('testModalLabel').textContent = 'Add New Test';
            populateAllTestsDropdown();

            // --- Reset manual/normal test name input layout ---
            const manualTestNameInput = document.getElementById('manualTestNameInput');

            const test_id = document.getElementById('test_id');
            const testNameSelect = document.getElementById('test_name');
            const testNameSearchLabel = document.getElementById('testNameSearchLabel');
            const testNamelabel = document.getElementById('testNamelabel');
            const testNameSearch = document.getElementById('testNameSearch');

            // Show dropdown and search, hide manual input
            if (manualTestNameInput) manualTestNameInput.style.display = 'none';

            if (testNameSelect) testNameSelect.style.display = '';
            if (testNameSearchLabel) testNameSearchLabel.style.display = '';
            if (testNamelabel) testNamelabel.style.display = '';
            if (testNameSearch) testNameSearch.style.display = '';

            // Add one default range for each gender
            if (typeof addMaleRange === 'function') addMaleRange();
            if (typeof addFemaleRange === 'function') addFemaleRange();


        });







        document.getElementById('searchInput').addEventListener('input', function () {
            const searchValue = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll('#testsTableBody tr');
            rows.forEach(row => {
                const testNameCell = row.children[1]; // Test Name
                const testIdCell = row.children[2];   // Test ID
                const modelCell = row.children[3];    // Model
                const groupCell = row.children[4];    // Group
                const abbreviationCell = row.children[7]; // Abbreviation

                const testName = testNameCell ? testNameCell.textContent.trim().toLowerCase() : '';
                const testId = testIdCell ? testIdCell.textContent.trim().toLowerCase() : '';
                const model = modelCell ? modelCell.textContent.trim().toLowerCase() : '';
                const group = groupCell ? groupCell.textContent.trim().toLowerCase() : '';
                const abbreviation = abbreviationCell ? abbreviationCell.textContent.trim().toLowerCase() : '';

                // Show if any field matches search
                const match =
                    (testName.startsWith(searchValue)) ||
                    (testId.includes(searchValue)) ||
                    (model.includes(searchValue)) ||
                    (group.includes(searchValue)) ||
                    (abbreviation.includes(searchValue));

                row.style.display =
                    searchValue && match
                        ? ''
                        : (searchValue ? 'none' : '');
            });
        });
        // Optional: still allow search button to trigger the same filter
        document.getElementById('searchBtn').addEventListener('click', function () {
            document.getElementById('searchInput').dispatchEvent(new Event('input'));
        });

        /////////////// delete all tests functionality ///////////////


        document.getElementById('deleteAllTestsBtn').addEventListener('click', async function () {
            // Get all checked checkboxes
            const checked = Array.from(document.querySelectorAll('.test-row-checkbox:checked'));
            if (checked.length === 0) {
                alert('Please select at least one test to delete.');
                return;
            }
            if (!confirm(`Are you sure you want to delete ${checked.length} selected test(s)? This action cannot be undone.`)) {
                return;
            }

            // Collect test IDs to delete
            const idsToDelete = checked.map(cb => cb.getAttribute('data-id'));
            const updates = {};
            idsToDelete.forEach(id => {
                updates[id] = firebase.firestore.FieldValue.delete();
            });

            try {
                await db.collection('tests_list').doc('Tests.html').update(updates);
                await logTestSystemAction('delete_all_tests', { count: idsToDelete.length });
                alert('Selected tests deleted!');
                loadTests(true);
            } catch (error) {
                console.error('Error deleting selected tests:', error);
                alert('Error deleting selected tests. Please try again.');
            }
        });
        /////////////// bulk function to add tests at once ///////////////

        document.getElementById('bulkAddTestsBtn').addEventListener('click', function () {
            var bulkModal = new bootstrap.Modal(document.getElementById('bulkAddModal'));
            bulkModal.show();
            populateBulkTestsList();
        });

        async function populateBulkTestsList() {
            const tableBody = document.getElementById('bulkTestsTableBody');
            const stats = document.getElementById('bulkTestsStats');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading tests...</td></tr>';

            // Gather all tests from arrays
            let allTests = [
                ...regularTests.map(t => ({ ...t, model: 'Regular' })),
                ...specialTests.map(t => ({ ...t, model: 'Special' })),
                ...multipleRangesTests.map(t => ({ ...t, model: 'Multiple Ranges' })),
                ...culturesTests.map(t => ({ ...t, model: 'Culture' })),
                ...compatibilityTests.map(t => ({ ...t, model: 'Compatibility' })),
                ...pathologicTests.map(t => ({ ...t, model: 'Pathologic' }))
            ];
            allTests.sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));


            // --- Get already added test IDs from the single tests document ---
            const testsDoc = await db.collection('tests_list').doc('Tests.html').get();
            const testsObj = testsDoc.exists ? testsDoc.data() : {};
            let existingTestIds = new Set(Object.keys(testsObj));

            // Helper to render table rows
            function renderBulkTableRows(sortedTests) {
                let addedCount = 0, notAddedCount = 0;
                const rowsHtml = sortedTests.map(test => {
                    const isAdded = existingTestIds.has(test.test_id);
                    if (isAdded) addedCount++; else notAddedCount++;
                    return `
<tr>
    <td>
        <input type="checkbox" class="test-checkbox" data-model="${test.model}" 
            data-name="${test.name}" data-group="${test.group || ''}" 
            data-sample="${test.sample_type || ''}" data-test-id="${test.test_id}"
            ${isAdded ? 'data-added="1"' : 'data-added="0"'}
            ${isAdded ? 'disabled style="accent-color: red;"' : ''}>
    </td>
    <td>${test.name}</td>
    <td>${test.model}</td>
    <td>${test.group || ''}</td>
    <td>${test.sample_type || ''}</td>
</tr>
`;
                }).join('');
                tableBody.innerHTML = rowsHtml;
                stats.textContent = `Total: ${sortedTests.length} | Added: ${addedCount} | Not Added: ${notAddedCount}`;
            }

            // Initial render (default order)
            renderBulkTableRows(allTests);

            // Checkbox logic (unchanged)
            const showAddedChk = document.getElementById('showAddedTestsChk');
            showAddedChk.checked = false;
            showAddedChk.onchange = function () {
                document.querySelectorAll('.test-checkbox[data-added="1"]').forEach(cb => {
                    cb.checked = showAddedChk.checked;
                });
            };

            const addNotAddedChk = document.getElementById('addNotAddedTestsChk');
            addNotAddedChk.checked = false;
            addNotAddedChk.onchange = function () {
                if (addNotAddedChk.checked) {
                    // Move not added tests to top
                    const notAdded = allTests.filter(t => !existingTestIds.has(t.test_id));
                    const added = allTests.filter(t => existingTestIds.has(t.test_id));
                    renderBulkTableRows([...notAdded, ...added]);
                    // Check all not added
                    document.querySelectorAll('.test-checkbox[data-added="0"]:not(:disabled)').forEach(cb => {
                        cb.checked = true;
                    });
                } else {
                    // Restore original order
                    renderBulkTableRows(allTests);
                }
                // Re-apply showAddedChk state if checked
                if (showAddedChk.checked) {
                    document.querySelectorAll('.test-checkbox[data-added="1"]').forEach(cb => {
                        cb.checked = true;
                    });
                }
            };

            // Select all checkbox logic
            const selectAll = document.getElementById('selectAllTests');
            if (selectAll) {
                selectAll.addEventListener('change', function (e) {
                    document.querySelectorAll('.test-checkbox:not(:disabled)').forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                });
            }
        }

        document.getElementById('saveBulkTestsBtn').addEventListener('click', async function () {
            const selectedTests = Array.from(document.querySelectorAll('.test-checkbox:checked'));
            if (selectedTests.length === 0) {
                alert('Please select at least one test to add.');
                return;
            }

            if (!confirm(`Are you sure you want to add ${selectedTests.length} tests?`)) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Tests...';

            // Create progress indicator
            const progress = document.createElement('div');
            progress.className = 'text-center my-3';
            progress.innerHTML = `Adding tests: <span id="bulkProgress">0</span>/${selectedTests.length}`;
            document.querySelector('#bulkAddModal .modal-body').appendChild(progress);

            try {
                // Get next available ID
                let maxId = 0;
                const snapshot = await db.collection('tests_list').get();

                snapshot.forEach(doc => {
                    const test = doc.data();
                    if (test.test_id && !isNaN(parseInt(test.test_id))) {
                        const idNum = parseInt(test.test_id);
                        if (idNum > maxId) maxId = idNum;
                    }
                });

                // Process each test
                for (let i = 0; i < selectedTests.length; i++) {
                    const testCheckbox = selectedTests[i];
                    const testName = testCheckbox.dataset.name;
                    const testModel = testCheckbox.dataset.model;

                    // Update progress
                    document.getElementById('bulkProgress').textContent = i + 1;

                    // Prepare test data based on model type
                    let testData;
                    if (testModel === 'Regular') {
                        testData = prepareRegularTestData(testName, maxId + i + 1);
                    } else if (testModel === 'Special') {
                        testData = prepareSpecialTestData(testName, maxId + i + 1);
                    } else if (testModel === 'Multiple Ranges') {
                        testData = prepareMultipleRangesTestData(testName, maxId + i + 1);
                    } else if (testModel === 'Culture') {
                        testData = prepareCultureTestData(testName, maxId + i + 1);
                    } else if (testModel === 'Compatibility') {
                        testData = prepareCompatibilityTestData(testName, maxId + i + 1);
                    } else if (testModel === 'Pathologic') {
                        testData = preparePathologicTestData(testName, maxId + i + 1);
                    }


                    await db.collection('tests_list').doc('Tests.html').set({
                        [testData.test_id]: testData
                    }, { merge: true });


                }
                await logTestSystemAction('bulk_add_tests', { count: selectedTests.length });

                alert(`${selectedTests.length} tests added successfully!`);
                $('#bulkAddModal').modal('hide');
                loadTests(true);
            } catch (error) {
                console.error("Error adding bulk tests:", error);
                alert("Error adding some tests. Please check console for details.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-2"></i> Save All Tests';
            }
        });

        // Helper functions to prepare test data for each model type

        function prepareRegularTestData(testName, testId) {
            const test = regularTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName || '',

                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Regular',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: test.unit || '',
                abbreviation: test.abbreviation || '',
                price: typeof test.price === 'number' ? test.price : 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                reference_ranges: reference_ranges || [],
                createdBy: currentUser.email || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }
        // Repeat similar for all other prepare*TestData functions:
        function prepareSpecialTestData(testName, testId) {
            const test = specialTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName || '',
                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Special',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: test.parameters?.[0]?.unit || '',
                abbreviation: test.abbreviation || '',
                price: typeof test.price === 'number' ? test.price : 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                parameters: {
                    male: flattenParameters(test.parameters || []),
                    female: flattenParameters(test.parameters || [])
                },
                reference_ranges: reference_ranges || [],
                createdBy: currentUser.email || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        function prepareMultipleRangesTestData(testName, testId) {
            const test = multipleRangesTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName,
                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Multiple Ranges',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: test.unit || '',
                abbreviation: test.abbreviation || '',
                price: test.price || 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                reference_ranges, // use patched array
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        function prepareCultureTestData(testName, testId) {
            const test = culturesTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName,
                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Culture',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: '',
                abbreviation: '',
                price: test.price || 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                parameters: test.main_parameters || [],
                reference_ranges, // use patched array
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        function prepareCompatibilityTestData(testName, testId) {
            const test = compatibilityTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName,
                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Compatibility',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: '',
                abbreviation: '',
                price: test.price || 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                parameters: test.parameters || [],
                reference_ranges, // use patched array
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        function preparePathologicTestData(testName, testId) {
            const test = pathologicTests.find(t => t.name === testName) || {};
            const reference_ranges = (test.reference_ranges || []).map(r => ({
                ...r,
                unit: r.unit || "years"
            }));
            return {
                test_name: testName,
                test_id: test.test_id ? test.test_id.toString() : '', // Use test_id from the test object

                model: 'Pathologic',
                department: test.department || '',
                group: test.group || '',
                sample_type: test.sample_type || '',
                unit: '',
                abbreviation: '',
                price: test.price || 0,
                precautions: test.precautions || '',
                questions: Array.isArray(test.questions) ? test.questions.join('\n') : (test.questions || ''),
                parameters: test.parameters || [],
                reference_ranges, // use patched array
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }


        async function deleteTest(testId) {
            if (!confirm('Are you sure you want to delete this test?')) return;
            try {
                await db.collection('tests_list').doc('Tests.html').update({
                    [testId]: firebase.firestore.FieldValue.delete()
                });
                await logTestSystemAction('delete_test', { test_id: testId });
                alert('Test deleted successfully!');
                loadTests(true);
            } catch (error) {
                console.error('Error deleting test:', error);
                alert('Error deleting test. Please try again.');
            }
        }
        document.getElementById('bulkSearchInput').addEventListener('input', function () {
            const searchValue = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll('#bulkTestsTableBody tr');
            rows.forEach(row => {
                // Get test name, model, group, and test id from columns or data attributes
                const tds = row.querySelectorAll('td');
                // Defensive: check if columns exist
                const testName = tds[1]?.textContent?.toLowerCase() || '';
                const model = tds[2]?.textContent?.toLowerCase() || '';
                const group = tds[3]?.textContent?.toLowerCase() || '';
                const sampleType = tds[4]?.textContent?.toLowerCase() || '';
                // Try to get test id from data attribute if available
                const testId = row.querySelector('.test-checkbox')?.getAttribute('data-test-id')?.toLowerCase() || '';

                // Match if any field contains the search value
                const match =
                    testName.includes(searchValue) ||
                    model.includes(searchValue) ||
                    group.includes(searchValue) ||
                    sampleType.includes(searchValue) ||
                    testId.includes(searchValue);

                row.style.display = match ? '' : 'none';
            });
        });


        // Optional: clear search button for bulk modal
        document.getElementById('bulkClearSearch').addEventListener('click', function () {
            const input = document.getElementById('bulkSearchInput');
            input.value = '';
            input.dispatchEvent(new Event('input'));
        });



        function loadBranchesForPriceList() {
            const branchSelect = document.getElementById('priceBranchSelect');
            const sourceBranchSelect = document.getElementById('copyFromBranchSelect');
            branchSelect.innerHTML = '<option value="">-- All Branches --</option>';
            sourceBranchSelect.innerHTML = '<option value="">-- Copy From Branch --</option>';
            db.collection('branches').orderBy('branchName').get().then(snapshot => {
                snapshot.forEach(doc => {
                    const branch = doc.data();
                    const option1 = document.createElement('option');
                    option1.value = branch.branchName;
                    option1.textContent = branch.branchName;
                    branchSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = branch.branchName;
                    option2.textContent = branch.branchName;
                    sourceBranchSelect.appendChild(option2);
                });
            });
        }


        document.getElementById('fetchPricesBtn').addEventListener('click', async function () {
            const targetBranch = document.getElementById('priceBranchSelect').value;
            const sourceBranch = document.getElementById('copyFromBranchSelect').value;
            const btn = this;
            const originalBtnHtml = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Fetching...';

            const tbody = document.getElementById('priceListTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="py-5 text-center"><div class="spinner-border text-info mb-2"></div><p class="mb-0 fw-bold">Synchronizing price databases ...</p></td></tr>';

            try {
                // Fetch all tests from single document
                const testsDoc = await db.collection('tests_list').doc('Tests.html').get();
                let testsObj = testsDoc.exists ? testsDoc.data() : {};

                // Fallback to medicalTests if Firestore is empty
                if (Object.keys(testsObj).length === 0 && typeof medicalTests !== 'undefined') {
                    console.log('Firestore tests_list/Tests.html is empty. Falling back to medicalTests.');
                    Object.keys(medicalTests).forEach(key => {
                        testsObj[key] = {
                            test_name: medicalTests[key].name,
                            test_id: key,
                            price: medicalTests[key].price || 0,
                            min_price: (medicalTests[key].price || 0) * 0.8 // Dummy min price
                        };
                    });
                }

                // Fetch prices from selected branch (targetBranch)
                let normalPrices = {};
                let minPrices = {};

                if (targetBranch) {
                    const [normalPricesDoc, minPricesDoc] = await Promise.all([
                        db.collection('branches').doc(targetBranch).collection('normal_price_list').doc('prices').get(),
                        db.collection('branches').doc(targetBranch).collection('min_price_list').doc('prices').get()
                    ]);
                    normalPrices = normalPricesDoc.exists ? normalPricesDoc.data() : {};
                    minPrices = minPricesDoc.exists ? minPricesDoc.data() : {};
                }

                let activePrices = normalPrices;
                let activeMinPrices = minPrices;

                if (sourceBranch) {
                    const [sNormalPricesDoc, sMinPricesDoc] = await Promise.all([
                        db.collection('branches').doc(sourceBranch).collection('normal_price_list').doc('prices').get(),
                        db.collection('branches').doc(sourceBranch).collection('min_price_list').doc('prices').get()
                    ]);
                    activePrices = sNormalPricesDoc.exists ? sNormalPricesDoc.data() : {};
                    activeMinPrices = sMinPricesDoc.exists ? sMinPricesDoc.data() : {};
                }

                const testsEntries = Object.entries(testsObj).sort((a, b) => {
                    const aName = (a[1].test_name || '').toLowerCase();
                    const bName = (b[1].test_name || '').toLowerCase();
                    return aName.localeCompare(bName);
                });

                tbody.innerHTML = '';
                if (testsEntries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-5 text-center"><p class="text-muted">No tests found in the catalog.</p></td></tr>';
                    return;
                }

                testsEntries.forEach(([docId, test]) => {
                    const priceToShow = activePrices[docId] !== undefined ? activePrices[docId] : (test.price || 0);
                    const minPriceToShow = activeMinPrices[docId] !== undefined ? activeMinPrices[docId] : (test.min_price || 0);
                    const currentPrice = targetBranch ? (normalPrices[docId] || test.price || 0) : (test.price || 0);

                    const row = document.createElement('tr');
                    row.className = 'price-row animate-fade';
                    row.style.transition = 'all 0.3s ease';
                    row.innerHTML = `
                        <td class="px-3">
                            <div class="fw-bold text-dark">${test.test_name || ''}</div>
                            <small class="text-muted">Catalog Item</small>
                        </td>
                        <td class="px-3"><code class="bg-light px-2 py-1 rounded text-primary">${test.test_id || docId}</code></td>
                        <td class="px-3 current-price fw-bold text-secondary">${Number(currentPrice).toFixed(2)} EGP</td>
                        <td class="px-3">
                            <input type="number" class="form-control form-control-sm test-new-price border-info-subtle" 
                                data-test-id="${docId}" 
                                value="${Number(priceToShow).toFixed(2)}" 
                                min="0" step="1" onfocus="this.select()" oninput="this.closest('tr').style.backgroundColor = 'rgba(0, 188, 212, 0.05)'">
                        </td>
                        <td class="px-3">
                            <input type="number" class="form-control form-control-sm test-min-price border-warning-subtle" 
                                data-test-id="${docId}" 
                                value="${Number(minPriceToShow).toFixed(2)}" 
                                min="0" step="1" onfocus="this.select()" oninput="this.closest('tr').style.backgroundColor = 'rgba(0, 188, 212, 0.05)'">
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Error fetching branch prices:', err);
                tbody.innerHTML = `<tr><td colspan="5" class="py-5 text-center text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Error fetching prices. Please check Firestore connection.</td></tr>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        });

        // Search in price list table
        document.getElementById('searchPriceTestInput').addEventListener('input', function () {
            const searchValue = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll('#priceListTableBody .price-row');
            rows.forEach(row => {
                const testName = row.cells[0].textContent.toLowerCase();
                const testId = row.cells[1].textContent.toLowerCase();
                row.style.display = (testName.includes(searchValue) || testId.includes(searchValue)) ? '' : 'none';
            });
        });

        // Save price changes logic refined to respect checkboxes
        document.getElementById('savePriceChangesBtn').addEventListener('click', async function () {
            const targetBranch = document.getElementById('priceBranchSelect').value;
            const applyAll = document.getElementById('applyAllTests').checked;
            const applyNew = document.getElementById('applyNewPrice').checked;
            const applyMin = document.getElementById('applyMinPrice').checked;
            const btn = this;

            if (!applyNew && !applyMin) {
                alert('Please select at least one price type to apply (New Price or Minimum Price).');
                return;
            }

            const rows = document.querySelectorAll('#priceListTableBody .price-row');
            if (rows.length === 0 || rows[0].querySelector('input') === null) {
                alert('No test data available to save. Please Fetch data first.');
                return;
            }

            const normalUpdates = {};
            const minUpdates = {};
            let count = 0;

            rows.forEach(row => {
                const newPriceInput = row.querySelector('.test-new-price');
                const minPriceInput = row.querySelector('.test-min-price');
                if (!newPriceInput || !minPriceInput) return;

                const docId = newPriceInput.getAttribute('data-test-id');
                if (applyNew) normalUpdates[docId] = parseFloat(newPriceInput.value) || 0;
                if (applyMin) minUpdates[docId] = parseFloat(minPriceInput.value) || 0;
                count++;
            });

            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';

            try {
                if (targetBranch) {
                    // Save to specific branch
                    const promises = [];
                    if (applyNew) promises.push(db.collection('branches').doc(targetBranch).collection('normal_price_list').doc('prices').set(normalUpdates, { merge: true }));
                    if (applyMin) promises.push(db.collection('branches').doc(targetBranch).collection('min_price_list').doc('prices').set(minUpdates, { merge: true }));
                    await Promise.all(promises);
                } else if (applyAll) {
                    // Save to ALL branches
                    const branchesSnap = await db.collection('branches').get();
                    const batch = db.batch();
                    branchesSnap.forEach(branchDoc => {
                        const branchId = branchDoc.id;
                        if (applyNew) batch.set(db.collection('branches').doc(branchId).collection('normal_price_list').doc('prices'), normalUpdates, { merge: true });
                        if (applyMin) batch.set(db.collection('branches').doc(branchId).collection('min_price_list').doc('prices'), minUpdates, { merge: true });
                    });

                    // Also update main tests document as default prices
                    const testsUpdate = {};
                    Object.keys(normalUpdates).forEach(docId => {
                        testsUpdate[docId] = {};
                        if (applyNew) testsUpdate[docId].price = normalUpdates[docId];
                        if (applyMin) testsUpdate[docId].min_price = minUpdates[docId];
                        testsUpdate[docId].updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    });
                    batch.set(db.collection('tests_list').doc('Tests.html'), testsUpdate, { merge: true });

                    await batch.commit();
                } else {
                    // Update main tests document only (default prices)
                    const testsUpdate = {};
                    Object.keys(normalUpdates).forEach(docId => {
                        testsUpdate[docId] = {};
                        if (applyNew) testsUpdate[docId].price = normalUpdates[docId];
                        if (applyMin) testsUpdate[docId].min_price = minUpdates[docId];
                        testsUpdate[docId].updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    });
                    await db.collection('tests_list').doc('Tests.html').set(testsUpdate, { merge: true });
                }

                // Visual success feedback
                btn.classList.replace('btn-success', 'btn-info');
                btn.innerHTML = '<i class="fas fa-check me-1"></i> Success!';

                setTimeout(() => {
                    btn.classList.replace('btn-info', 'btn-success');
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 2000);

                alert(`Successfully updated prices for ${count} tests!`);
            } catch (err) {
                console.error('Error saving prices:', err);
                alert('Error saving prices. See console.');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });


        document.getElementById('testsTableBody').addEventListener('change', async function (e) {
            if (e.target.classList.contains('turnaround-time-dropdown')) {
                const docId = e.target.getAttribute('data-id');
                const value = e.target.value;
                try {
                    await db.collection('tests_list').doc(docId).set({

                        turnaround_time: value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Optionally show a toast or alert
                    // alert('Turnaround Time updated!');
                } catch (err) {
                    alert('Failed to save Turnaround Time');
                }
            }
        });







        // 1. Turnaround Time Options (reuse your dropdown options)
        const turnaroundTimeOptions = [
            "15 minutes", "30 minutes", "1 Hour",
            "1 Hour 30 minutes", "2 Hours", "6 Hours", "10 Hours", "16 Hours", "20 Hours", "1 Day", "2 Days", "3 Days", "4 Days", "5 Days", "6 Days", "7 Days",
            "8 Days", "9 Days", "10 Days", "11 Days", "12 Days", "13 Days", "14 Days",
            "2 Weeks", "3 Weeks", "4 Weeks", "1 Month", "2 Months", "3 Months", "4 Months", "5 Months", "6 Months", "7 Months", "8 Months", "9 Months", "10 Months", "11 Months", "12 Months"
        ];


        document.getElementById('editTurnaroundTimeBtn').addEventListener('click', async function () {
            const btn = this;
            if (btn.dataset.loading) return; // prevent double open
            btn.dataset.loading = '1';
            try {
                const modalEl = document.getElementById('turnaroundTimeModal');
                const modal = new bootstrap.Modal(modalEl);

                // Show modal immediately with a loading spinner while we fetch & render
                const tbody = document.getElementById('turnaroundTimeTableBody');
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5"><i class="fas fa-spinner fa-spin"></i> Loading tests...</td></tr>`;
                modal.show();

                // Populate bulk select quickly
                const bulkSelect = document.getElementById('bulkTurnaroundTimeSelect');
                bulkSelect.innerHTML = `<option value="">-- Set Turnaround Time for All --</option>` +
                    turnaroundTimeOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');

                // Ensure apply controls exist (only once)
                if (!document.getElementById('turnaroundApplyControls')) {
                    const container = document.createElement('div');
                    container.id = 'turnaroundApplyControls';
                    container.className = 'd-flex align-items-center gap-2 ms-2';
                    container.innerHTML = `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="applyToNormalChk" checked>
                    <label class="form-check-label" for="applyToNormalChk">Apply to Normal</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="applyToUrgentChk">
                    <label class="form-check-label" for="applyToUrgentChk">Apply to Urgent</label>
                </div>
            `;
                    const controlsRow = document.querySelector('#turnaroundTimeModal .modal-body .mb-3.d-flex.align-items-center');
                    if (controlsRow) controlsRow.appendChild(container);
                }

                // Fetch tests document (may be large)
                const doc = await db.collection('tests_list').doc('Tests.html').get();
                const testsObj = doc.exists ? doc.data() : {};

                // Build rows in a fragment for performance
                const frag = document.createDocumentFragment();
                Object.entries(testsObj).forEach(([testId, test]) => {
                    const normalVal = (typeof test.normal_turnaround_time !== 'undefined' && test.normal_turnaround_time !== '')
                        ? test.normal_turnaround_time
                        : ((test.turnaround_time && !test.urgent_turnaround_time) ? test.turnaround_time : '');
                    const urgentVal = (typeof test.urgent_turnaround_time !== 'undefined') ? test.urgent_turnaround_time : '';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td style="width:110px">${test.test_id || ''}</td>
                <td>${test.test_name || ''}</td>
                <td>
                    <div class="turnaround-cell-inner">
                        <input type="text" class="form-control turnaround-time-input" data-id="${testId}" data-type="normal" value="${normalVal || ''}" list="turnaroundTimeDatalist" placeholder="Normal">
                        <button class="btn btn-success btn-sm save-turnaround-time-btn" data-id="${testId}" data-type="normal" title="Save Normal">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <div class="turnaround-cell-inner">
                        <input type="text" class="form-control turnaround-time-input" data-id="${testId}" data-type="urgent" value="${urgentVal || ''}" list="turnaroundTimeDatalist" placeholder="Urgent">
                        <button class="btn btn-success btn-sm save-turnaround-time-btn" data-id="${testId}" data-type="urgent" title="Save Urgent">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </td>
            `;
                    frag.appendChild(row);
                });

                // Render datalist if missing
                if (!document.getElementById('turnaroundTimeDatalist')) {
                    const datalist = document.createElement('datalist');
                    datalist.id = 'turnaroundTimeDatalist';
                    turnaroundTimeOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        datalist.appendChild(option);
                    });
                    document.body.appendChild(datalist);
                }

                // Replace tbody contents atomically
                tbody.innerHTML = '';
                tbody.appendChild(frag);

                // Attach delegated click handler once to tbody to avoid re-attaching on each open
                if (!tbody._delegationInitialized) {
                    tbody.addEventListener('click', async function (e) {
                        const btn = e.target.closest('.save-turnaround-time-btn');
                        if (!btn) return;
                        const docId = btn.getAttribute('data-id');
                        const type = btn.getAttribute('data-type'); // 'normal' | 'urgent'
                        const input = tbody.querySelector(`.turnaround-time-input[data-id="${docId}"][data-type="${type}"]`);
                        const value = input ? input.value : '';

                        btn.disabled = true;
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        try {
                            const testUpdate = {
                                [docId]: {
                                    [type === 'normal' ? 'normal_turnaround_time' : 'urgent_turnaround_time']: value,
                                    // use client timestamp to avoid many server transforms
                                    updatedAt: new Date().toISOString()
                                }
                            };
                            await db.collection('tests_list').doc('Tests.html').set(testUpdate, { merge: true });
                            await logTestSystemAction('set_turnaround_time', { test_id: docId, type, value });

                            btn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                btn.innerHTML = originalHtml;
                                btn.disabled = false;
                            }, 700);
                        } catch (err) {
                            console.error(err);
                            btn.innerHTML = originalHtml;
                            btn.disabled = false;
                            alert('Error saving Turnaround Time.');
                        }
                    });
                    tbody._delegationInitialized = true;
                }

            } catch (err) {
                console.error('Error opening Turnaround modal:', err);
                alert('Failed to load Turnaround Time editor. See console.');
            } finally {
                delete btn.dataset.loading;
            }
        });



        function filterturnaroundTimeTable() {
            const searchValue = document.getElementById('turnaroundTimeSearchInput').value.trim().toLowerCase();
            document.querySelectorAll('#turnaroundTimeTableBody tr').forEach(row => {
                const testId = row.children[0].textContent.toLowerCase();
                const testName = row.children[1].textContent.toLowerCase();
                // Show row if search is empty or matches name/id
                row.style.display = (!searchValue || testId.includes(searchValue) || testName.includes(searchValue)) ? '' : 'none';
            });
        }

        document.getElementById('turnaroundTimeSearchBtn').addEventListener('click', filterturnaroundTimeTable);
        document.getElementById('turnaroundTimeSearchInput').addEventListener('input', filterturnaroundTimeTable);


        // 4. Apply to all
        document.getElementById('applyTurnaroundTimeToAllBtn').addEventListener('click', function () {
            const value = document.getElementById('bulkTurnaroundTimeSelect').value;
            if (!value) return;
            const applyNormal = document.getElementById('applyToNormalChk')?.checked;
            const applyUrgent = document.getElementById('applyToUrgentChk')?.checked;

            if (!applyNormal && !applyUrgent) {
                alert('Please check at least one target (Normal or Urgent) to apply to.');
                return;
            }

            if (applyNormal) {
                document.querySelectorAll('.turnaround-time-input[data-type="normal"]').forEach(input => {
                    input.value = value;
                });
            }
            if (applyUrgent) {
                document.querySelectorAll('.turnaround-time-input[data-type="urgent"]').forEach(input => {
                    input.value = value;
                });
            }
        });


        document.getElementById('saveTurnaroundTimesBtn').addEventListener('click', async function () {
            const tbody = document.getElementById('turnaroundTimeTableBody');
            if (!tbody) {
                alert('Turnaround table not loaded.');
                return;
            }

            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) {
                alert('No tests to save.');
                return;
            }

            const updates = {};
            const clientNow = new Date().toISOString(); // client timestamp (not a server transform)

            rows.forEach(row => {
                const normalInput = row.querySelector('.turnaround-time-input[data-type="normal"]');
                const urgentInput = row.querySelector('.turnaround-time-input[data-type="urgent"]');
                const docId = normalInput ? normalInput.getAttribute('data-id') : (urgentInput ? urgentInput.getAttribute('data-id') : null);
                if (!docId) return;

                const normalVal = normalInput ? normalInput.value : undefined;
                const urgentVal = urgentInput ? urgentInput.value : undefined;

                // only include fields that we actually want to set (avoid unnecessary writes)
                const payload = {};
                if (typeof normalVal !== 'undefined') payload.normal_turnaround_time = normalVal;
                if (typeof urgentVal !== 'undefined') payload.urgent_turnaround_time = urgentVal;

                // store client timestamp instead of serverTimestamp to avoid transform count
                payload.updatedAt = clientNow;

                updates[docId] = payload;
            });

            if (Object.keys(updates).length === 0) {
                alert('Nothing to save.');
                return;
            }

            try {
                // Add a single server-side timestamp once to mark the bulk save
                updates.__turnaround_last_saved = firebase.firestore.FieldValue.serverTimestamp();

                // Merge the grouped objects into the single tests document
                await db.collection('tests_list').doc('Tests.html').set(updates, { merge: true });

                await logTestSystemAction('save_all_turnaround_times', { count: Object.keys(updates).length - 1 }); // subtract metadata key

                alert('Turnaround times saved.');
                loadTests(true);
            } catch (err) {
                console.error(err);
                alert('Error saving Turnaround Times.');
            }
        });



        async function logTestSystemAction(actionType, details = {}) {
            const today = new Date();
            const dateKey = today.toISOString().split('T')[0]; // e.g., "2025-09-11"
            const user = currentUser?.email || "unknown";
            await db.collection('system_actions')
                .doc('Tests.html')
                .collection(dateKey)
                .add({
                    action: actionType,
                    details,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    user: user
                });
        }



        /////////////////////////

        /*document.getElementById('downloadBranchPriceExcelBtn').addEventListener('click', async function () {
            const selectedBranch = document.getElementById('branchPriceListSelect').value;
            if (!selectedBranch) {
                alert('Please select a branch to download prices.');
                return;
            }
        
            // Fetch all normal prices and min prices from branch (each test is a document)
            const normalPricesSnap = await db.collection('branches').doc(selectedBranch)
                .collection('normal_price_list').get();
            const minPricesSnap = await db.collection('branches').doc(selectedBranch)
                .collection('min_price_list').get();
        
            // Build price maps
            const normalPrices = {};
            normalPricesSnap.forEach(doc => {
                const data = doc.data();
                if (data && data.price !== undefined) {
                    normalPrices[doc.id] = data.price;
                }
            });
            const minPrices = {};
            minPricesSnap.forEach(doc => {
                const data = doc.data();
                if (data && data.price !== undefined) {
                    minPrices[doc.id] = data.price;
                }
            });
        
            // Prepare Excel data: only tests present in branch price lists
            const excelData = [
                ["test_id", "N.price", "Min.price"]
            ];
            Object.keys(normalPrices).forEach(testId => {
                excelData.push([
                    testId,
                    normalPrices[testId] !== undefined ? normalPrices[testId] : "",
                    minPrices[testId] !== undefined ? minPrices[testId] : ""
                ]);
            });
        
            // Create and download Excel file
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Prices");
            XLSX.writeFile(wb, `Branch_${selectedBranch}_Test_Prices.xlsx`);
        });
          
        
        */


        document.getElementById('downloadBranchPriceExcelBtn').addEventListener('click', async function () {
            const selectedBranch = document.getElementById('branchPriceListSelect').value;
            if (!selectedBranch) {
                alert('Please select a branch to download prices.');
                return;
            }

            // Fetch all normal prices and min prices from branch (single 'prices' document)
            const normalPricesDoc = await db.collection('branches').doc(selectedBranch)
                .collection('normal_price_list').doc('prices').get();
            const minPricesDoc = await db.collection('branches').doc(selectedBranch)
                .collection('min_price_list').doc('prices').get();

            const normalPrices = normalPricesDoc.exists ? normalPricesDoc.data() : {};
            const minPrices = minPricesDoc.exists ? minPricesDoc.data() : {};

            // Fetch all tests to get test_name
            const testsDoc = await db.collection('tests_list').doc('Tests.html').get();
            const testsObj = testsDoc.exists ? testsDoc.data() : {};

            // Prepare Excel data: test_id, test_name, N.price, Min.price
            const excelData = [
                ["test_id", "test_name", "N.price", "Min.price"]
            ];
            Object.keys(normalPrices).forEach(testId => {
                const testName = testsObj[testId]?.test_name || "";
                excelData.push([
                    testId,
                    testName,
                    normalPrices[testId] !== undefined ? normalPrices[testId] : "",
                    minPrices[testId] !== undefined ? minPrices[testId] : ""
                ]);
            });

            // Create and download Excel file
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Prices");
            XLSX.writeFile(wb, `Branch_${selectedBranch}_Test_Prices.xlsx`);
        });
        // ...existing code...

        document.getElementById('exportTurnaroundPdfBtn').addEventListener('click', function () {
            const rows = Array.from(document.querySelectorAll('#turnaroundTimeTableBody tr'));
            const data = rows.map(row => {
                const testId = row.children[0].textContent.trim();
                const testName = row.children[1].textContent.trim();
                const normal = row.querySelector('.turnaround-time-input[data-type="normal"]')?.value || '';
                const urgent = row.querySelector('.turnaround-time-input[data-type="urgent"]')?.value || '';
                return [testId, testName, normal, urgent];
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Turnaround Time List", 14, 14);
            doc.autoTable({
                head: [["Test ID", "Test Name", "Normal TAT", "Urgent TAT"]],
                body: data,
                startY: 20,
                styles: { fontSize: 9 }
            });
            doc.save("turnaround_time_list.pdf");
        });


        ////////////////////////////////// department population for test edit modal
        // ...existing code...
        function getAllDepartments() {
            const depts = new Set();
            [
                ...(regularTests || []),
                ...(specialTests || []),
                ...(multipleRangesTests || []),
                ...(culturesTests || []),
                ...(compatibilityTests || []),
                ...(pathologicTests || [])
            ].forEach(test => {
                if (test.department) depts.add(test.department);
            });
            return Array.from(depts).sort();
        }

        function populateDepartmentDropdown() {
            const deptSelect = document.getElementById('testDepartment');
            deptSelect.innerHTML = '<option value="">Select Department</option>';
            getAllDepartments().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
        }


        // Download Prices Excel
        document.getElementById('downloadPricesExcelBtn').addEventListener('click', function () {
            const rows = document.querySelectorAll('#priceListTableBody .price-row');
            const data = [["Test Name", "Test ID", "Current Price", "New Price", "Minimum Price"]];

            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const testName = row.cells[0].textContent;
                    const testId = row.cells[1].textContent;
                    const currentPrice = row.cells[2].textContent;
                    const newPrice = row.querySelector('.test-new-price').value;
                    const minPrice = row.querySelector('.test-min-price').value;
                    data.push([testName, testId, currentPrice, newPrice, minPrice]);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PriceList");
            XLSX.writeFile(wb, "Test_Prices_Update.xlsx");
        });

        // Upload Prices Excel
        document.getElementById('uploadPricesBtn').addEventListener('click', function () {
            const fileInput = document.getElementById('uploadPricesInput');
            if (!fileInput.files.length) {
                alert('Please select an Excel file first.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // Track how many we matched
                let matched = 0;
                jsonData.forEach(item => {
                    const testId = item["Test ID"] || item["test_id"];
                    const newPrice = item["New Price"] || item["new_price"] || item["Price"] || item["price"];
                    const minPrice = item["Minimum Price"] || item["min_price"];

                    if (testId) {
                        const row = document.querySelector(`#priceListTableBody .test-new-price[data-test-id="${testId}"]`)?.closest('tr');
                        if (row) {
                            if (newPrice !== undefined) row.querySelector('.test-new-price').value = newPrice;
                            if (minPrice !== undefined) row.querySelector('.test-min-price').value = minPrice;
                            matched++;
                        }
                    }
                });

                alert(`Uploaded successfully! Matched ${matched} tests.`);
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('addPriceListBtn').addEventListener('click', function () {
            const modalEl = document.getElementById('priceListModal');
            const modal = new bootstrap.Modal(modalEl);
            loadBranchesForPriceList();

            // Auto-fetch if first time or empty
            const tbody = document.getElementById('priceListTableBody');
            if (tbody.children.length <= 1) {
                setTimeout(() => {
                    document.getElementById('fetchPricesBtn').click();
                }, 500);
            }

            modal.show();
        });

        document.addEventListener('DOMContentLoaded', populateDepartmentDropdown);

        document.getElementById('addDepartmentManually').addEventListener('click', function () {
            document.getElementById('manualDepartmentInput').style.display = '';
            document.getElementById('testDepartment').style.display = 'none';
            document.getElementById('manualDepartmentInput').value = '';
        });

        document.getElementById('manualDepartmentInput').addEventListener('blur', function () {
            if (this.value.trim()) {
                // Add to dropdown if not exists
                const deptSelect = document.getElementById('testDepartment');
                const newDept = this.value.trim();
                let exists = false;
                for (let i = 0; i < deptSelect.options.length; i++) {
                    if (deptSelect.options[i].value.toLowerCase() === newDept.toLowerCase()) {
                        exists = true;
                        break;
                    }
                }
                if (!exists) {
                    const option = document.createElement('option');
                    option.value = newDept;
                    option.textContent = newDept;
                    deptSelect.appendChild(option);
                }
                deptSelect.value = newDept;
            }
            this.style.display = 'none';
            document.getElementById('testDepartment').style.display = '';
        });

        document.getElementById('editDepartmentBtn').addEventListener('click', function () {
            const deptSelect = document.getElementById('testDepartment');
            const manualInput = document.getElementById('manualDepartmentInput');
            const selectedOption = deptSelect.options[deptSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a department to edit.');
                return;
            }
            manualInput.value = selectedOption.value;
            manualInput.style.display = '';
            deptSelect.style.display = 'none';
            manualInput.onblur = function () {
                const newValue = manualInput.value.trim();
                if (newValue && newValue !== selectedOption.value) {
                    selectedOption.value = newValue;
                    selectedOption.textContent = newValue;
                    deptSelect.value = newValue;
                }
                manualInput.style.display = 'none';
                deptSelect.style.display = '';
            };
        });

    </script>
</body>

</html>