<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Report - Al-Gomhouria Lab</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --report-blue: #e0f2fe;
            --text-dark: #1e293b;
            --border-color: #cbd5e1;
        }

        body {
            background-color: #f1f5f9;
            font-family: 'Noto Kufi Arabic', sans-serif;
            color: var(--text-dark);
            margin: 0;
            padding: 40px 20px;
        }

        .action-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .btn-report {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            color: white;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-pdf {
            background: #e11d48;
        }

        .btn-print {
            background: #2563eb;
        }

        .btn-home {
            background: #0891b2;
        }

        .btn-whatsapp {
            background: #22c55e;
        }

        .report-paper {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 50px;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            min-height: 1200px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .report-paper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: url('gomhouria_lab_logo.png') no-repeat center;
            background-size: contain;
            opacity: 0.03;
            pointer-events: none;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .header-left {
            text-align: right;
            line-height: 1.4;
        }

        .header-left h3 {
            color: #b91c1c;
            margin: 0;
            font-size: 1.4rem;
        }

        .header-center {
            text-align: center;
        }

        .header-center img {
            width: 100px;
        }

        .header-right {
            text-align: left;
            line-height: 1.4;
        }

        .header-right h2 {
            margin: 0;
            font-size: 1.8rem;
            color: #1e3a8a;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 4px;
        }

        .info-label {
            font-weight: 700;
            width: 120px;
            color: #334155;
        }

        .info-value {
            flex: 1;
            font-family: 'Amiri', serif;
            font-weight: 700;
        }

        .cat-name {
            font-size: 1.3rem;
            font-weight: 800;
            margin: 30px 0 15px;
            color: #000;
            border-bottom: 2px solid #334155;
            display: inline-block;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .results-table th {
            background: #f0f9ff;
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            text-align: right;
            font-size: 0.9rem;
            color: #1e3a8a;
        }

        .results-table td {
            border: 1px solid #f1f5f9;
            padding: 10px 12px;
            font-size: 1rem;
        }

        .result-val {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }

            .action-bar {
                display: none;
            }

            .report-paper {
                box-shadow: none;
                border: none;
                width: 100%;
                margin: 0;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="action-bar">
        <button class="btn-report btn-whatsapp" onclick="shareOnWhatsApp()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
            </svg>
            WhatsApp
        </button>
        <button class="btn-report btn-pdf" onclick="saveAsPDF()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z" />
            </svg>
            PDF
        </button>
        <button class="btn-report btn-print" onclick="window.print()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z" />
                <path
                    d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z" />
            </svg>
            Print
        </button>
        <button class="btn-report btn-home" onclick="location.href='dashboard.html'">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path
                    d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L8.707 1.5Z" />
                <path d="M7.5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H8a.5.5 0 0 1-.5-.5v-3Z" />
            </svg>
            Home
        </button>
    </div>

    <div class="report-paper" id="reportPaper">
        <header class="report-header">
            <div class="header-left">
                <h3>Ø¯/ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ù†Ø§ØµØ± Ø¨Ù„ÙŠØº</h3>
                <p>Ø¯ÙƒØªÙˆØ±Ø§Ù‡ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠÙˆÙ„ÙˆØ¬ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ù„ÙŠØ©</p>
                <p>Ø¬Ø§Ù…Ø¹Ø© Ø¹ÙŠÙ† Ø´Ù…Ø³</p>
            </div>
            <div class="header-center">
                <img src="gomhouria_lab_logo.png" alt="Logo">
            </div>
            <div class="header-right" dir="ltr">
                <h2 style="text-align: right;">Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ©</h2>
                <p style="text-align: right; color: #b91c1c; font-weight: 700;">Ù„Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ©</p>
                <div id="qrcode"
                    style="background:white; padding:5px; border-radius:5px; border:1px solid #eee; margin-top: 10px;">
                </div>
                <div style="font-size: 0.7rem; color: #64748b; margin-top: 5px; text-align: center;">ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø±Ù‚Ù…ÙŠ
                </div>
            </div>
        </header>

        <section class="info-grid">
            <div>
                <div class="info-row"><span class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</span><span class="info-value"
                        id="pName">---</span></div>
                <div class="info-row"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</span><span class="info-value"
                        id="pId">---</span></div>
                <div class="info-row"><span class="info-label">Ø§Ù„Ø¹Ù…Ø± / Ø§Ù„Ù†ÙˆØ¹:</span><span class="info-value"
                        id="pAgeSex">---</span></div>
                <div class="info-row"><span class="info-label">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:</span><span class="info-value"
                        id="pReferrer">---</span></div>
            </div>
            <div>
                <div class="info-row"><span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span><span class="info-value"
                        id="pOrderId">---</span></div>
                <div class="info-row"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span><span class="info-value"
                        id="pRegTime">---</span></div>
                <div class="info-row"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø­Ø¨:</span><span class="info-value"
                        id="pCollTime">---</span></div>
                <div class="info-row"><span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</span><span class="info-value"
                        id="pAuthTime">---</span></div>
                <div class="info-row"><span class="info-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="info-value"
                        id="rDate">---</span></div>
                <div class="info-row"><span class="info-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (TAT):</span> <span class="info-value"
                        id="rTAT" style="color:#10b981;">---</span></div>
            </div>
        </section>

        <main id="resultsContainer"><!-- Results dynamically injected --></main>
    </div>

    <script src="tests-data.js"></script>
    <script>
        const pId = new URLSearchParams(window.location.search).get('id');
        let currentPatientData = null;

        document.addEventListener('DOMContentLoaded', () => {
            const db = JSON.parse(localStorage.getItem('patientsDatabase')) || [];
            const patient = db.find(p => p.id === pId);
            if (!patient) {
                alert("Patient not found!");
                return;
            }
            currentPatientData = patient;

            // Header Info
            document.getElementById('pName').textContent = patient.name || "---";
            document.getElementById('pId').textContent = patient.id || "---";

            document.getElementById('pReferrer').textContent = 'Prof:-';
            document.getElementById('pOrderId').textContent = patient.id ? `REC-\${patient.id.split('-')[1] || patient.id}` : "---";
            document.getElementById('pRegTime').textContent = (patient.date || '') + " 10:00 AM";
            document.getElementById('pCollTime').textContent = (patient.date || '') + " 10:15 AM";
            document.getElementById('pAuthTime').textContent = new Date().toLocaleString('en-GB');

            renderResults(patient);
        });

        function renderResults(patient) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            const results = patient.results || {};
            if (Object.keys(results).length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 50px; color:#94a3b8; font-weight:700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø¹Ø¯.</div>';
                return;
            }

            // Grouping logic: Use patient.tests (which are group IDs) to find parameters
            // Fallback to searching all groups if patient.tests is missing
            const testGroups = patient.tests || Object.keys(medicalTests);
            const groupedDisplay = {};

            Object.entries(results).forEach(([paramId, value]) => {
                let foundParam = null;
                let foundCat = "General Studies";
                let foundMethod = "-";

                // Search in patient's selected groups first
                for (const groupId of testGroups) {
                    const group = medicalTests[groupId];
                    if (!group) continue;
                    const param = group.parameters.find(p => p.id === paramId);
                    if (param) {
                        foundParam = param;
                        foundCat = group.name; // Use Group Name for title
                        foundMethod = group.method || "-";
                        break;
                    }
                }

                if (!groupedDisplay[foundCat]) groupedDisplay[foundCat] = [];
                groupedDisplay[foundCat].push({
                    name: foundParam ? foundParam.name : paramId,
                    val: value,
                    unit: foundParam ? foundParam.unit : "-",
                    range: foundParam ? getRefRange(foundParam, patient) : "-",
                    method: foundMethod
                });
            });

            for (const [catName, params] of Object.entries(groupedDisplay)) {
                let html = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #334155; margin: 30px 0 10px;">
                        <div class="cat-name" style="border:none; margin:0;">${catName}</div>
                        <div style="font-size:0.7rem; color:#64748b; font-family:'Outfit';">Method: ${params[0].method}</div>
                    </div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Test Description</th>
                                <th style="text-align: center; width: 20%;">Result</th>
                                <th style="text-align: center; width: 15%;">Unit</th>
                                <th style="text-align: center; width: 30%;">Reference Range</th>
                            </tr>
                        </thead>
                        <tbody>`;

                params.forEach(r => {
                    html += `
                        <tr>
                            <td style="font-weight: 700; color:#1e3a8a;">${r.name}</td>
                            <td class="result-val" style="text-align: center; font-size:1.1rem;">${r.val}</td>
                            <td style="text-align: center; font-family:'Outfit'; font-size:0.9rem;">${r.unit}</td>
                            <td style="text-align: center; font-size: 0.85rem; color:#475569; font-family:'Outfit';">
                                ${r.range}
                            </td>
                        </tr>`;
                });

                html += `</tbody></table>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        }

        function getRefRange(param, patient) {
            if (typeof param.range === 'string') return param.range;
            if (typeof param.range === 'object') {
                const gender = (patient.gender || 'Male').toLowerCase();
                return param.range[gender] || param.range.male || "---";
            }
            return "---";
        }

        async function saveAsPDF() {
            if (!currentPatientData) return;
            const element = document.getElementById('reportPaper');
            const opt = {
                margin: 0,
                filename: `Report_${currentPatientData.name.replace(/ /g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            return html2pdf().set(opt).from(element).save();
        }

        async function shareOnWhatsApp() {
            if (!currentPatientData) return;

            // 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let phone = currentPatientData.mobile || "";
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('0')) cleanPhone = '2' + cleanPhone;
            if (!cleanPhone.startsWith('2')) cleanPhone = '2' + cleanPhone;

            const messageText = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\nØ£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø¹Ù…ÙŠÙ„ Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø²ÙŠØ²: Ø£/ ${currentPatientData.name}.\nÙ†ÙˆØ¯ Ø¥Ø®Ø·Ø§Ø±ÙƒÙ… Ø¨Ø£Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ… Ø£ØµØ¨Ø­Øª Ø¬Ø§Ù‡Ø²Ø©. ØªØ¬Ø¯ÙˆÙ† Ø·ÙŠÙ‡ ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.\n\nğŸ’¡ (Ù„Ù‚Ø¯ ØªÙ… Ù†Ø³Ø® ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹Ø› Ø¨Ù…Ø¬Ø±Ø¯ ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ø¶ØºØ· Ctrl+V Ù„Ù„ØµÙ‚Ù‡Ø§ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§)`;
            const waUrl = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(messageText)}`;
            const element = document.getElementById('reportPaper');

            // 2. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            try {
                const toast = document.createElement('div');
                toast.id = "waReportToast";
                toast.style = "position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#1e3a8a; color:white; padding:40px; border-radius:30px; z-index:11000; font-weight:900; box-shadow:0 20px 80px rgba(0,0,0,0.6); text-align:center; direction:rtl; border:3px solid #3b82f6; font-family:sans-serif;";
                toast.innerHTML = `<div style="font-size:3rem; margin-bottom:20px;">âš¡</div>Ø¬Ø§Ø±ÙŠ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨...<br>Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©...`;
                document.body.appendChild(toast);

                if (!navigator.clipboard || !window.ClipboardItem) throw new Error("Clipboard API not supported");

                const imageBlobPromise = new Promise(async (resolve, reject) => {
                    try {
                        const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff", useCORS: true });
                        canvas.toBlob(blob => resolve(blob), 'image/png');
                    } catch (e) { reject(e); }
                });

                const clipboardItem = new ClipboardItem({ "image/png": imageBlobPromise });
                await navigator.clipboard.write([clipboardItem]);

                toast.style.background = "#15803d";
                toast.innerHTML = `<div style="font-size:3rem; margin-bottom:20px;">âœ…</div>ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!<br>Ø³ÙŠÙØªØ­ Ø§Ù„Ø¢Ù†.. Ø§Ø¶ØºØ· <b>Ctrl + V</b> Ù„Ù„Ø¥Ø±Ø³Ø§Ù„`;

                setTimeout(() => {
                    window.location.href = waUrl;
                    setTimeout(() => { if (document.getElementById('waReportToast')) document.getElementById('waReportToast').remove(); }, 3000);
                }, 1500);
            } catch (err) {
                console.error("WhatsApp Share Error:", err);
                window.location.href = waUrl;
                if (document.getElementById('waReportToast')) document.getElementById('waReportToast').remove();
            }
        }
    </script>
</body>

</html>