<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient & Order Request - DataLab.M.S Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary-blue: #0ea5e9;
            --dark-blue: #0369a1;
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --border: #d1d5db;
            --text-main: #111827;
            --text-muted: #64748b;
        }

        body {
            background-color: var(--main-bg);
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Nav Wrapper */
        .top-navbar {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .btn-back-link {
            background: #f59e0b;
            color: black;
            border: none;
            padding: 4px 15px;
            border-radius: 4px;
            font-weight: 800;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main Wrapper */
        .main-container {
            padding: 20px 40px 60px;
            flex: 1;
        }

        /* Blue Banner */
        .banner-blue {
            background: #2563eb;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .banner-blue h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-green-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Search Area */
        .search-area-grid {
            background: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            border: 1px solid var(--border);
        }

        .search-field label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .search-input-group {
            display: flex;
        }

        .search-input-group input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 6px 0 0 6px;
            padding: 10px 15px;
            outline: none;
        }

        .search-input-group button {
            border: none;
            padding: 10px 15px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-yellow-search {
            background: #f59e0b;
            color: black;
            border-radius: 0 6px 6px 0;
        }

        .btn-blue-search {
            background: #2563eb;
            color: white;
            border-radius: 0 6px 6px 0;
        }

        /* Form Card */
        .form-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .form-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .form-header-row h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inner-search-box {
            display: flex;
            gap: 10px;
        }

        .inner-search-box input {
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 300px;
        }

        .btn-cancel-grey {
            background: #64748b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Form Grids */
        .field-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .field-grid.age-row {
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
        }

        .field-grid.bottom-row {
            grid-template-columns: 1fr 1.2fr 1.5fr 1.2fr 1fr;
        }

        .label-field {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: #334155;
        }

        .input-field,
        .select-field {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            box-sizing: border-box;
            background: #fff;
        }

        .input-field[readonly] {
            background: #f8fafc;
            color: #64748b;
        }

        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 15px;
        }

        .btn-action {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-red-clear {
            background: #ef4444;
            color: white;
        }

        .btn-green-save {
            background: #10b981;
            color: white;
        }

        /* Bottom Status */
        .bottom-status-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 0.75rem;
            z-index: 200;
        }

        .speed-tag {
            color: #10b981;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .barcode-icon {
            opacity: 0.6;
            cursor: pointer;
        }

        /* Pregnancy Field Toggle */
        #pregStatusRow {
            display: none;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="top-navbar">
        <div style="display: flex; gap: 20px; align-items: center;">
            <button class="btn-back-link" onclick="location.href='dashboard.html'">‚Üê Back</button>
            <span style="font-weight: 800;">DataLab.M.S Pro</span>
            <span onclick="location.href='cash-tally.html'" style="cursor:pointer; font-weight:700;">üí∞ Cash
                Tally</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="zoom-controls"
                style="display: flex; gap: 5px; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 20px;">
                <button onclick="changeZoom(-0.1)"
                    style="background:none; color:white; font-size:1.2rem; font-weight:bold; padding:0 5px;">-</button>
                <span id="zoomLevel" style="font-weight:bold; min-width:45px; text-align:center;">100%</span>
                <button onclick="changeZoom(0.1)"
                    style="background:none; color:white; font-size:1.2rem; font-weight:bold; padding:0 5px;">+</button>
            </div>
            <button class="btn-back-link" style="background:#10b981; color:white;"
                onclick="location.href='Tests.html'">üß™ Manage Tests</button>
            <span>üè¢ Branch: Al-Gomhouria</span>
            <svg width="18" height="18" fill="white" viewBox="0 0 16 16" style="cursor: pointer;">
                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                <path fill-rule="evenodd"
                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
            </svg>
        </div>
    </div>

    <div class="main-container">
        <div class="banner-blue">
            <h1>Patient & Order Request</h1>
            <button class="btn-green-add">üë§ Add New Patient</button>
        </div>

        <section class="search-area-grid">
            <div class="search-field">
                <label>Search by Order ID</label>
                <div class="search-input-group">
                    <input type="text" placeholder="Auto-generated">
                    <button class="btn-yellow-search">üîç Search Order</button>
                </div>
            </div>
            <div class="search-field">
                <label>Global Search (Name, ID, Mobile)</label>
                <div class="search-input-group">
                    <input type="text" placeholder="Search by name, ID, or mobile...">
                    <button class="btn-blue-search">üîç Search</button>
                </div>
            </div>
        </section>

        <form class="form-card" id="patientForm">
            <div class="form-header-row">
                <h3>üë§ Add New Patient</h3>
                <div class="inner-search-box">
                    <input type="text" placeholder="Search on patients to update details">
                    <button type="button" class="btn-cancel-grey" onclick="location.href='dashboard.html'">‚úï
                        Cancel</button>
                </div>
            </div>

            <!-- Row 1 -->
            <div class="field-grid">
                <div>
                    <span class="label-field">Patient ID *</span>
                    <input type="text" id="pId" class="input-field" readonly>
                </div>
                <div>
                    <span class="label-field">Medical Number</span>
                    <input type="text" placeholder="Enter Medical Number" class="input-field">
                </div>
                <div>
                    <span class="label-field">Creation Date *</span>
                    <input type="datetime-local" id="creationDate" class="input-field">
                </div>
                <div>
                    <span class="label-field">Last Update *</span>
                    <input type="text" value="undefined" readonly class="input-field">
                </div>
            </div>

            <!-- Row 2 -->
            <div class="field-grid">
                <div>
                    <span class="label-field">Title *</span>
                    <select class="select-field">
                        <option>Select</option>
                        <option>Mr.</option>
                        <option>Mrs.</option>
                        <option>Ms.</option>
                        <option>Dr.</option>
                    </select>
                </div>
                <div>
                    <span class="label-field">First Name *</span>
                    <input type="text" id="firstName" placeholder="1st Name" class="input-field" required>
                </div>
                <div>
                    <span class="label-field">Second Name *</span>
                    <input type="text" id="secondName" placeholder="2nd Name" class="input-field">
                </div>
                <div>
                    <span class="label-field">Third Name *</span>
                    <input type="text" id="thirdName" placeholder="3rd , .. Names" class="input-field">
                </div>
            </div>

            <!-- Row 3 (6 columns) -->
            <div class="field-grid age-row">
                <div>
                    <span class="label-field">Mobile Number *</span>
                    <input type="text" id="mobile" placeholder="Enter Mobile Number" class="input-field" required>
                </div>
                <div>
                    <span class="label-field">Birth Date *</span>
                    <input type="date" id="birthDate" class="input-field" oninput="calculateAge()">
                </div>
                <div>
                    <span class="label-field">Age (Years) *</span>
                    <input type="number" id="ageY" placeholder="Age by years" class="input-field">
                </div>
                <div>
                    <span class="label-field">Age (Months)</span>
                    <input type="number" id="ageM" placeholder="Age by months" class="input-field">
                </div>
                <div>
                    <span class="label-field">Age (Days)</span>
                    <input type="number" id="ageD" placeholder="Age by days" class="input-field">
                </div>
                <div>
                    <span class="label-field">Gender *</span>
                    <select id="gender" class="select-field" onchange="togglePregnancy()">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
            </div>

            <!-- Row 4 -->
            <div class="field-grid bottom-row">
                <div>
                    <span class="label-field">ÿßÿ≥ŸÖ ŸÖŸàÿ∏ŸÅ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ *</span>
                    <input type="text" id="registeredBy" placeholder="ÿ•ÿ≥ŸÖ ŸÖÿØÿÆŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™" class="input-field" required
                        value="ÿØ. ŸÖÿ≠ŸÖÿØ">
                </div>
                <div>
                    <span class="label-field">ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿπÿßŸÑÿ¨ (ÿ•ÿÆÿ™Ÿäÿßÿ±Ÿä)</span>
                    <input type="text" id="referralDoctor" placeholder="ÿ•ÿ≥ŸÖ ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿ≠ŸàŸÑ ŸÑŸÑÿ≠ÿßŸÑÿ©" class="input-field">
                </div>
                <div>
                    <span class="label-field">ÿ¨Ÿáÿ© ÿßŸÑÿ™ÿπÿßŸÇÿØ / ÿßŸÑÿ¥ÿ±ŸÉÿ©</span>
                    <select id="corporateContract" class="select-field">
                        <option value="ŸÜŸÇÿØŸä">ŸÜŸÇÿØŸä (Cash)</option>
                        <option value="ÿßŸÑŸÖŸáŸÜÿØÿ≥ŸäŸÜ">ŸÜŸÇÿßÿ®ÿ© ÿßŸÑŸÖŸáŸÜÿØÿ≥ŸäŸÜ</option>
                        <option value="ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ">ŸÜŸÇÿßÿ®ÿ© ÿßŸÑŸÖÿπŸÑŸÖŸäŸÜ</option>
                        <option value="ŸÖÿµÿ± ŸÑŸÑÿ™ÿ£ŸÖŸäŸÜ">ÿ¥ÿ±ŸÉÿ© ŸÖÿµÿ± ŸÑŸÑÿ™ÿ£ŸÖŸäŸÜ</option>
                        <option value="ÿ£ÿÆÿ±Ÿâ">ÿ£ÿÆÿ±Ÿâ...</option>
                    </select>
                </div>
                <div>
                    <span class="label-field">ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© *</span>
                    <input type="text" id="autoPass" readonly class="input-field">
                </div>
                <div>
                    <span class="label-field">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</span>
                    <input type="email" placeholder="ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä" class="input-field">
                </div>
                <div>
                    <span class="label-field">ÿßŸÑÿπŸÜŸàÿßŸÜ</span>
                    <input type="text" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ±Ÿäÿ∂" class="input-field">
                </div>
            </div>

            <div class="field-grid bottom-row" style="grid-template-columns: 1.5fr 1fr 1fr;">
                <div>
                    <span class="label-field">ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä</span>
                    <input type="text" placeholder="ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä" class="input-field">
                </div>
                <div>
                    <span class="label-field">ŸÅÿµŸäŸÑÿ© ÿßŸÑÿØŸÖ</span>
                    <select class="select-field">
                        <option>ÿßÿÆÿ™ÿ±</option>
                        <option>A+</option>
                        <option>A-</option>
                        <option>B+</option>
                        <option>B-</option>
                        <option>O+</option>
                        <option>O-</option>
                        <option>AB+</option>
                        <option>AB-</option>
                    </select>
                </div>
            </div>

            <div id="pregStatusRow">
                <div style="width: 25%;">
                    <span class="label-field">Pregnancy Status *</span>
                    <select id="isPregnant" class="select-field">
                        <option value="No">Non Pregnant</option>
                        <option value="Yes">Pregnant</option>
                    </select>
                </div>
            </div>

            <div class="form-footer">
                <button type="reset" class="btn-action btn-red-clear">‚úï Clear</button>
                <button type="button" class="btn-action btn-green-save" onclick="savePatient()">üíæ Save Patient</button>
            </div>
        </form>

        <!-- Test Selection Part (Keep it as user needs to select tests) -->
        <section class="form-card" style="margin-top: 30px;">
            <h3 style="font-weight: 800; margin-bottom: 20px;">üß™ Select Requested Tests</h3>
            <div id="testCategories"
                style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;"></div>
            <div id="testItems" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
        </section>
    </div>

    <div class="bottom-status-bar">
        <div class="speed-tag">Speed: 4.8 Mbps - 4G</div>
        <div class="barcode-icon">
            <svg width="40" height="24" viewBox="0 0 40 24">
                <rect width="2" height="24" fill="black" />
                <rect x="4" width="1" height="24" fill="black" />
                <rect x="7" width="3" height="24" fill="black" />
                <rect x="12" width="1" height="24" fill="black" />
                <rect x="15" width="2" height="24" fill="black" />
                <rect x="18" width="4" height="24" fill="black" />
                <rect x="24" width="1" height="24" fill="black" />
                <rect x="27" width="2" height="24" fill="black" />
                <rect x="31" width="3" height="24" fill="black" />
                <rect x="36" width="1" height="24" fill="black" />
                <rect x="38" width="2" height="24" fill="black" />
            </svg>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script src="tests-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto IDs
            const year = new Date().getFullYear();
            const rand = Math.floor(1000 + Math.random() * 9000);
            document.getElementById('pId').value = `DMS-${year}-${rand}`;
            document.getElementById('autoPass').value = 'dms_gk' + Math.floor(100 + Math.random() * 900);

            // Time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('creationDate').value = now.toISOString().slice(0, 16);

            initTests();
        });

        function calculateAge() {
            const val = document.getElementById('birthDate').value;
            if (!val) return;
            const birth = new Date(val);
            const today = new Date();

            let y = today.getFullYear() - birth.getFullYear();
            let m = today.getMonth() - birth.getMonth();
            let d = today.getDate() - birth.getDate();

            if (d < 0) {
                m--;
                d += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
            }
            if (m < 0) {
                y--;
                m += 12;
            }

            document.getElementById('ageY').value = y;
            document.getElementById('ageM').value = m;
            document.getElementById('ageD').value = d;
        }

        function togglePregnancy() {
            const gender = document.getElementById('gender').value;
            document.getElementById('pregStatusRow').style.display = (gender === 'Female') ? 'block' : 'none';
        }

        let selectedTestIds = [];
        let dynamicTests = {};

        // Firebase Config (Placeholder - should match your project)
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "hamadaaboalhaj-a636c.firebaseapp.com",
            projectId: "hamadaaboalhaj-a636c",
            storageBucket: "hamadaaboalhaj-a636c.appspot.com",
            messagingSenderId: "338243610996",
            appId: "1:338243610996:web:0f785bc10134449842f6e6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function initTests() {
            try {
                // Fetch dynamic tests from Tests.html manager
                const doc = await db.collection('tests_list').doc('Tests.html').get();
                if (doc.exists) {
                    const testsObj = doc.data();
                    // Convert to our medicalTests format
                    Object.entries(testsObj).forEach(([id, data]) => {
                        dynamicTests[id] = {
                            name: data.test_name,
                            category: data.department || "Other",
                            price: data.price || 0,
                            id: data.test_id
                        };
                    });
                }
            } catch (e) {
                console.warn("Could not load dynamic tests, using defaults", e);
            }

            const allTests = { ...medicalTests, ...dynamicTests };
            const cats = ["All Tests", ...new Set(Object.values(allTests).map(t => t.category))];
            const catDiv = document.getElementById('testCategories');
            catDiv.innerHTML = cats.map(c => `<button type="button" class="btn-cancel-grey" style="background:#f1f5f9; color:#475569; white-space:nowrap; margin-bottom:5px;" onclick="renderTests('${c}')">${c}</button>`).join('');
            renderTests("All Tests");
        }

        function renderTests(cat) {
            const grid = document.getElementById('testItems');
            const allTests = { ...medicalTests, ...dynamicTests };
            let filtered = Object.entries(allTests);
            if (cat !== "All Tests") filtered = filtered.filter(([id, t]) => t.category === cat);

            grid.innerHTML = filtered.map(([id, t]) => `
                <div onclick="toggleTest('${id}', this)" style="padding:10px; border:1px solid ${selectedTestIds.includes(id) ? '#2563eb' : '#e2e8f0'}; background:${selectedTestIds.includes(id) ? '#eff6ff' : 'white'}; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:700;">
                    ${t.name}
                </div>
            `).join('');
        }

        function toggleTest(id, el) {
            if (selectedTestIds.includes(id)) {
                selectedTestIds = selectedTestIds.filter(x => x !== id);
                el.style.borderColor = '#e2e8f0';
                el.style.background = 'white';
            } else {
                selectedTestIds.push(id);
                el.style.borderColor = '#2563eb';
                el.style.background = '#eff6ff';
            }
        }

        function savePatient() {
            const fname = document.getElementById('firstName').value;
            const mob = document.getElementById('mobile').value;
            if (!fname || !mob) return alert("First Name and Mobile are required!");

            const db = JSON.parse(localStorage.getItem('patientsDatabase')) || [];
            const patient = {
                id: document.getElementById('pId').value,
                name: `${fname} ${document.getElementById('secondName').value} ${document.getElementById('thirdName').value}`.trim(),
                mobile: mob,
                ageY: document.getElementById('ageY').value,
                ageM: document.getElementById('ageM').value,
                ageD: document.getElementById('ageD').value,
                gender: document.getElementById('gender').value,
                isPregnant: document.getElementById('isPregnant').value,
                registeredBy: document.getElementById('registeredBy').value || 'ÿØ. ŸÖÿ≠ŸÖÿØ',
                referralDoctor: document.getElementById('referralDoctor').value || 'ŸÑÿß ŸäŸàÿ¨ÿØ',
                corporate: document.getElementById('corporateContract').value || 'ŸÜŸÇÿØŸä',
                date: new Date().toLocaleDateString('en-CA'),
                tests: selectedTestIds,
                testsCount: selectedTestIds.length,
                status: 'Waiting',
                samplingTime: new Date().toISOString(), // ŸÑÿ®ÿØÿßŸäÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÄ TAT
                results: {}
            };

            db.push(patient);
            localStorage.setItem('patientsDatabase', JSON.stringify(db));
            alert("‚úÖ Patient Registered Successfully!");
            location.href = 'dashboard.html';
        }

        let currentZoom = 1;
        function changeZoom(delta) {
            currentZoom = Math.min(Math.max(0.5, currentZoom + delta), 2);
            document.body.style.setProperty('--app-zoom', currentZoom);
            document.body.classList.add('zoomed');
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';

            // For mobile compatibility
            if (currentZoom === 1) {
                document.body.classList.remove('zoomed');
            }
        }
    </script>
</body>

</html>