<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLab.M.S Pro - Laboratory Management System</title>
    <link rel="icon" href="images/datalab_icon3.ico" type="image/x-icon">
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add this with other script links in head -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <!-- Add Chart.js CDN in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .branches-shifts-float-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #212529 !important;
            display: none;
        }

        .branches-shifts-float-btn i {
            font-size: 30px;
            font-weight: bold;
        }

        .ai-float-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background-color: #c6c5d4 !important;
            border-color: #4907ff !important;
            color: #212529 !important;
        }

        .ai-float-btn i {
            font-size: 30px;
            font-weight: bold;
        }

        #dmsShopBtn,

        #refreshBtn {
            background-color: #ffc107 !important;
            color: #0d6efd !important;

            font-weight: bold;
        }

        .stat-chart {
            height: 50px;
            margin-top: 5px;
        }

        .stat-chart canvas {
            width: 100% !important;
            height: 50px !important;
        }


        /* Special Survey Overlay Styles */
        #surveyOverlay.notification-overlay {
            background: rgba(66, 133, 244, 0.15);
            /* Light info blue overlay */
            z-index: 2100;
        }



        #surveyOverlay .notification-header {
            background: #fbbc05;
            color: #fff;
        }

        #surveyOverlay .notification-header h3 i {
            color: #fff;
        }

        #surveyOverlay .notification-body {
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        #surveyOverlay .notification-footer {
            background: #e8f0fe;
            border-top: 1px solid #4285f4;
        }

        #surveyOverlay .btn-info {
            background: #fbbc05;
            border: none;
            color: #fff;
            font-weight: 600;
        }

        #surveyOverlay .btn-info:hover {
            background: #3367d6;
            color: #fff;
        }

        :root {
            --primary: #1a73e8;
            --primary-light: #e8f0fe;
            --secondary: #34a853;
            --secondary-light: #e6f4ea;
            --danger: #ea4335;
            --danger-light: #fce8e6;
            --warning: #fbbc05;
            --warning-light: #fef7e0;
            --info: #4285f4;
            --info-light: #e8f0fe;
            --success: #0f9d58;
            --success-light: #e6f4ea;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
            --light-gray: #f1f3f4;
            --sidebar-width: 280px;
        }

        .disabled-menu {
            opacity: 0.5;
            pointer-events: auto;
            /* allow click for JS, but not navigation */
            cursor: not-allowed;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
        }

        body[dir="rtl"] {
            direction: rtl;
        }

        body[dir="rtl"] .sidebar-menu a.active::before {
            right: 0;
            left: auto;
            border-radius: 4px 0 0 4px;
        }

        #scrollingMarquee {
            display: block;
            width: 100%;
            white-space: nowrap;
        }

        body[dir="rtl"] .sidebar-menu a {
            border-radius: 25px 0 0 25px;
        }

        body[dir="rtl"] .breadcrumb {
            direction: ltr;
            justify-content: flex-end;
        }

        body[dir="rtl"] .order-actions-icons {
            margin-left: 0;
            margin-right: auto;
        }

        body[dir="rtl"] .menu-badge {
            margin-left: 0;
            margin-right: auto;
        }

        header {
            background-color: white;
            color: var(--dark);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* General setup for the link wrapper */
        .logo-link {
            text-decoration: none;
            /* Removes the default underline from the link */
            color: inherit;
            /* Makes the text inherit its color from the parent */
            display: inline-block;
            /* Ensures proper spacing and hover effects */
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            /* Slightly increased gap for better breathing room */
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
            /* Modern, clean font stack */

            /* Semi-bold is often smoother than full bold */
            color: #2c29e7;
            letter-spacing: 0.5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            -webkit-box-reflect: below -13px linear-gradient(transparent, rgba(255, 255, 255, 0.2));

            /* A slightly softer, more professional dark color than pure black */
            cursor: pointer;
            /* Changes the cursor to a pointer on hover */
            transition: transform 0.3s ease-in-out, color 0.3s ease;
            /* Smooth transition for hover effects */
        }

        .logo:hover {
            transform: scale(1.03);
            /* Slightly enlarges the logo on hover */
            color: #3498db;
            /* Changes color on hover - use your primary color variable here */
        }

        .logo-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            /* Adds slightly rounded corners to the image */
        }

        #welcomeTitle:hover {
            color: #1a73e8;
        }

        /* Add this to your CSS section */
        @media (max-width: 768px) {
            #welcomeBackText {
                display: block;
                width: 100%;
                margin-bottom: 4px;
            }

            .welcome-title {
                align-content: center;
            }



            #loggedInEmployeesBtn {
                max-width: 200px;

                margin: auto;
            }

            /* Add label for the button */
            #loggedInEmployeesBtn::after {
                content: "Logged in Users";
                font-size: 0.95em;
                font-weight: 500;
                margin-left: 8px;
                color: #333;
            }

            #loggedInEmployeesBtn:hover {
                color: #ffffff !important;
            }

            #loggedInEmployeesBtn:hover::after {
                color: #fff;
            }

            .quick-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
            }

            .quick-action-btn {
                flex: 1 1 45%;
                min-width: 120px;
                margin-bottom: 8px;
                color: #dddddd !important;
            }

            .quick-action-btn:hover {
                color: #ffffff !important;
            }

            .welcome-banner {
                align-content: center;
                justify-content: center;
                align-items: center;
                text-align: center;
            }

            #employeeInfoPanel {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            #employeeInfoPanel .branch-badge {
                flex: 1 1 45%;
                min-width: 120px;
                margin-bottom: 8px;
            }

            #gaharStandardBtn,
            #datalabAiAnalysisBtn,
            #medicalDiagnosticBtn,
            #dmsChatAIBtn {
                display: none !important;
            }




            #mobileActionRow {
                display: flex !important;
                flex-direction: row;
                gap: 8px;
                margin-top: 10px;
                margin-bottom: 10px;
                width: 100%;
                justify-content: center;
                color: #fff !important;
            }

            body[dir="rtl"] #mobileActionRow {
                justify-content: flex-start;
            }

            #refreshBtnMobile,
            #sidebarToggleMobile {
                display: none !important;
            }

            nav ul {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;

            }

            nav ul li {
                margin-bottom: 0 !important;
                flex: 0 0 auto !important;
                width: auto !important;
            }

            #buyRequestsLink,
            #employeeRequestsLink,
            #notificationLink,
            #receivedNotificationLink {
                display: flex !important;
                align-items: center;
                padding: 0 6px;
                margin-bottom: 0 !important;
            }
        }

        @media (min-width: 769px) {
            #mobileActionRow {
                display: none !important;
            }
        }

        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
            gap: 1rem;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            color: var(--gray);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }

        nav ul li a:hover {
            background-color: var(--light-gray);
            color: var(--primary);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-profile:hover {
            background-color: var(--light-gray);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 72px);
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem 0;
            position: sticky;
            top: 72px;
            height: calc(100vh - 72px);
            overflow-y: auto;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--gray);
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .language-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .language-toggle:hover {
            background-color: var(--light-gray);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.25rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            border-radius: 0 25px 25px 0;
            transition: all 0.3s;
            gap: 12px;
            position: relative;
        }

        .sidebar-menu a:hover {
            background-color: var(--light-gray);
            color: var (--primary);
        }

        .sidebar-menu a.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
        }

        .sidebar-menu a.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--primary);
            border-radius: 0 4px 4px 0;
        }

        .menu-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .menu-badge {
            margin-left: auto;
            background-color: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            background-color: #f9fafb;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var (--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title-icon {
            color: var(--primary);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .breadcrumb a {
            color: var(--gray);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: var (--primary);
            text-decoration: underline;
        }

        .breadcrumb-separator {
            opacity: 0.6;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.65rem 1.25rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background-color: #0d5bba;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #d33426;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #0c8749;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .card-title {
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .card-footer {
            padding: 0.75rem 1.25rem;
            background-color: var(--light-gray);
            border-top: 1px solid var(--light-gray);
            font-size: 0.85rem;
        }

        .card-footer a {
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }







        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .stat-change.up {
            color: var(--success);
        }

        .stat-change.down {
            color: var(--danger);
        }

        .recent-activity {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .activity-list {
            list-style: none;
            margin-top: 1rem;
        }

        .activity-item {
            padding: 1rem 0;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            gap: 1rem;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }



        .activity-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .activity-description {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        footer {
            text-align: center;
            padding: 1.0rem;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--light-gray);
            height: 50px;
        }

        /* Color coding for menu items */
        .patients-menu {
            color: #4285f4;
            background-color: #e8f0fe;
        }

        .requests-menu {
            color: #ea4335;
            background-color: #fce8e6;
        }

        .pricing-menu {
            color: #fbbc05;
            background-color: #fef7e0;
        }

        .tests-menu {
            color: #34a853;
            background-color: #e6f4ea;
        }

        .results-menu {
            color: #673ab7;
            background-color: #f3e5f5;
        }

        .iso-menu {
            color: #00bcd4;
            background-color: #e0f7fa;
        }

        .lab-exchange-menu {
            color: #ff5722;
            background-color: #fbe9e7;
        }

        .inventory-menu {
            color: #607d8b;
            background-color: #eceff1;
        }

        .all-patients-menu {
            color: #9c27b0;
            background-color: #f3e5f5;
        }

        .cash-menu {
            color: #4caf50;
            background-color: #e8f5e9;
        }

        .doctors-menu {
            color: #3f51b5;
            background-color: #e8eaf6;
        }

        .house-visit-menu {
            color: #795548;
            background-color: #efebe9;
        }



        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 72px;
                z-index: 999;
                height: calc(100vh - 72px);
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .menu-toggle {
                display: block;
            }
        }

        /* Main banner container */
        .welcome-banner {
            background: #ffffff;
            padding: 20px 25px;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        /* Row layout (name + buttons + employee info) */
        .welcome-row {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Title + icons row */
        .welcome-row>div:first-child {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Welcome title */
        .welcome-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #333;
            margin: 0;
            text-decoration: none;
        }

        .welcome-title a {
            font-size: 1.6rem;
            font-weight: 700;
            color: #333;
            margin: 0;
            text-decoration: none;
        }



        #loggedInEmployeesBtn:hover {
            transform: scale(1.08);
        }




        /* Employee info badges */
        #employeeInfoPanel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-top: 5px;


        }

        .branch-badge {
            background: #f1f3f5;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
            border: 1px solid #e3e6e8;
        }

        /* Assigned quizzes box */
        #assignedQuizzesInfo {
            background: #fff3cd;
            color: #856404;
            border-radius: 14px;
            padding: 10px 18px;
            margin-top: 10px;
            font-weight: 600;
            border: 1px solid #ffeeba;
        }

        /* Welcome message */
        .welcome-message {
            margin-top: 12px;
            font-size: 1.1rem;
            color: #444;
        }

        /* Quick actions layout */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }

        /* Quick action buttons */
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 12px 18px;
            border-radius: 14px;
            background: #007bff;
            border: none;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, transform 0.15s;
        }

        .quick-action-btn:hover {
            background: #0069d9;
            transform: translateY(-2px);
        }

        /* Small icon spacing */
        .quick-action-btn i {
            font-size: 1.1rem;
        }

        /* Responsive handling */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 1.4rem;
            }

            .quick-action-btn {
                flex: 1 1 calc(50% - 12px);
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .quick-action-btn {
                flex: 1 1 100%;
            }
        }

        .network-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .network-badge.online {
            background: #ecfdf5;
            color: #10b981;
            border-color: #34d399;
        }

        .network-badge.offline {
            background: #fef2f2;
            color: #ef4444;
            border-color: #fca5a5;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .welcome-banner {
                text-align: center;
            }


        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Sidebar toggle button */
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }

        @media (max-width: 992px) {
            .sidebar-toggle {
                display: inline-block;
            }
        }

        /* Add this to the existing styles */
        #searchResultsNav {
            display: none;
            border: 1px solid #dee2e6;
        }

        #searchResultsNav .list-group-item {
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        #searchResultsNav .list-group-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-highlight {
            background-color: yellow;
            font-weight: bold;
        }

        .order-actions-icons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .order-actions-icons a {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .order-actions-icons a:hover {
            color: #1a73e8;
        }

        /* Styling for the search bar */
        #globalSearchNav {
            border: 1px solid #ced4da;
            border-radius: 15px;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 2;
            width: 250px;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.075);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #globalSearchNav:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #globalSearchNavBtn {
            border: 1px solid #ced4da;
            border-left: none;

            clip-path: path('M0,0 Q20,25 0,50 Q20,75 0,100 L100,100 Q100,50 100,0 Z');

            border-radius: 0 1.5rem 1.5rem 0 !important;
            box-shadow: inset 20px 0 20px -15px #fffbe7;
            padding: 10px 15px;
            font-size: 1rem;
            line-height: 1.5;
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #212529;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;

            display: none;
        }



        #globalSearchNavBtn:hover {
            background-color: #dee2e6;
        }

        #globalSearchNavBtn:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #searchResultsNav {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1050;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 0.25rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.175);
        }

        #searchResultsNav .list-group-item {
            padding: 0.75rem 1.25rem;
            border: none;
            color: #495057;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        #searchResultsNav .list-group-item:hover {
            background-color: #f8f9fa;
        }

        #searchResultsNav .search-result-highlight {
            background-color: #ffc107;
            font-weight: bold;
            color: #212529;
        }

        /* RTL specific styles */
        body[dir="rtl"] .sidebar {
            right: 0;
            left: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        }

        body[dir="rtl"] .sidebar.active {
            right: 0;
            left: auto;
        }

        body[dir="rtl"] .sidebar-toggle {
            margin-right: 0;
            margin-left: 0.5rem;
        }

        body[dir="rtl"] .quick-actions {
            justify-content: flex-end;
        }

        body[dir="rtl"] .card-footer a i {
            transform: rotate(180deg);
        }

        /* Enhanced Notification Modal Styles */
        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Add this to your <style> section or a CSS file */
        #receivedNotificationOverlay .notification-header {
            background-color: #198754 !important;
            /* Bootstrap green, or any color you want */
        }

        .notification-header {
            background-color: #198754 !important;
        }

        .notification-dialog {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .notification-overlay.active .notification-dialog {
            transform: translateY(0);
        }

        .notification-header {
            padding: 1.5rem;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .notification-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: all 0.2s;
        }

        .notification-item.unread {
            background-color: white;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .notification-content {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .notification-meta {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            justify-content: space-between;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }

        .notification-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .notification-btn.mark-read {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .notification-btn.mark-read:hover {
            background-color: var(--primary);
            color: white;
        }

        .notification-btn.view-details {
            background-color: var(--light-gray);
            color: var(--dark);
        }

        .notification-btn.view-details:hover {
            background-color: var(--gray);
            color: white;
        }

        .notification-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
        }

        .no-notifications {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        .notification-badge.pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(234, 67, 53, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(234, 67, 53, 0);
            }
        }

        /* Responsive notification dialog */
        @media (max-width: 768px) {
            .notification-dialog {
                width: 95%;
                max-height: 85vh;
            }

            .notification-header h3 {
                font-size: 1.2rem;
            }

            .notification-item {
                padding: 0.75rem;
            }

            .notification-actions {
                flex-direction: column;
                gap: 5px;
            }

            .notification-btn {
                width: 100%;
            }
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Responsive styles for navbar */
        @media (max-width: 992px) {

            /* Show mobile toggle button */
            .mobile-toggle {
                display: block;
            }

            /* Hide main nav by default on mobile */
            nav {
                position: fixed;
                top: 72px;
                right: -100%;
                width: 280px;
                height: calc(100vh - 72px);
                background-color: white;
                box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
                transition: right 0.3s ease;
                overflow-y: auto;
                z-index: 1000;
            }

            /* Show nav when active */
            nav.active {
                right: 0;
            }

            /* Adjust nav items for mobile */
            nav ul {
                flex-direction: column;
                padding: 1rem;
            }

            nav ul li {
                margin-bottom: 0.5rem;
            }

            nav ul li a {
                padding: 0.75rem;
                border-radius: 6px;
            }

            /* Adjust search bar for mobile */
            .nav-item.me-2 .input-group {
                width: 100%;
            }

            #searchResultsNav {
                width: 100%;
            }
        }

        /* For RTL languages */
        body[dir="rtl"] nav {
            right: auto;
            left: -100%;
        }

        body[dir="rtl"] nav.active {
            left: 0;
            right: auto;
        }

        /* ...existing code... */
        @media (max-width: 992px) {

            /* ...existing code... */
            .gahar-btn-text,
            .ai-analysis-btn-text,
            .medical-diagnostic-btn-text {
                display: none;
            }

            #gaharStandardBtn::after {
                content: "Gahar.html";
                display: inline;
                font-weight: 500;
                margin-left: 8px;
            }

            #datalabAiAnalysisBtn::after {
                content: "AI Agent";
                display: inline;
                font-weight: 500;
                margin-left: 8px;
            }

            #medicalDiagnosticBtn::after {
                content: "Diagnose";
                display: inline;
                font-weight: 500;
                margin-left: 8px;
            }
        }

        @media (min-width: 993px) {

            #gaharStandardBtn::after,
            #datalabAiAnalysisBtn::after,
            #medicalDiagnosticBtn::after {
                display: none;
            }

            .gahar-btn-text,
            .ai-analysis-btn-text,
            .medical-diagnostic-btn-text {
                display: inline;
            }
        }


        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-enhanced {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }

        .btn-enhanced i {
            font-size: 1.1em;
        }

        .btn-text {
            white-space: nowrap;
        }

        /* Specific button colors */
        #datalabAiAnalysisBtn {
            color: #0d6efd;
        }

        #gaharStandardBtn {
            color: #fd7e14;
        }

        #medicalDiagnosticBtn {
            color: #dc3545;
        }

        #sidebarToggle {
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .button-group {
                gap: 8px;
            }

            .btn-text {
                display: none;
            }

            .btn-enhanced {
                padding: 10px;
                border-radius: 50%;
            }
        }

        /* ...existing code... */
        #loggedInEmployeesModal .table {
            border: 2px solid #0d6efd;
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
        }

        #loggedInEmployeesModal .table th,
        #loggedInEmployeesModal .table td {
            border: 1.5px solid #dee2e6;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }

        #loggedInEmployeesModal .table thead th {
            background: #e8f0fe;
            color: #0d6efd;
            font-weight: bold;
            border-bottom: 2px solid #0d6efd;
        }

        #loggedInEmployeesModal .table-hover tbody tr:hover {
            background-color: #f1f7ff;
        }

        /* Center the table horizontally in the modal */
        #loggedInEmployeesModal .notification-body {
            display: flex;
            justify-content: center;
            /* align-items: center; <-- Remove or comment this out */
            min-height: unset;
            /* Remove if you don't want vertical centering */
            padding: 0;
            margin-top: 5px;
        }

        #loggedInEmployeesModal .table-responsive {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Responsive: Welcome Banner & Quick Actions */
        @media (max-width: 768px) {
            .sidebar .sidebar-close-btn {
                display: block;
                position: absolute;
                top: 16px;
                right: 16px;
                background: none;
                border: none;
                color: #888;
                font-size: 1.5rem;
                z-index: 1100;
                cursor: pointer;
                transition: color 0.2s;
            }

            .sidebar .sidebar-close-btn:hover {
                color: #ea4335;
            }

            .welcome-banner .welcome-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px;
            }

            .welcome-banner .welcome-title {
                font-size: 1.2rem !important;
                margin-bottom: 8px !important;
            }

            .welcome-banner .branch-badge {
                font-size: 0.9rem !important;
                margin-left: 0 !important;
                margin-bottom: 4px !important;
            }



            .quick-actions .quick-action-btn {
                flex: 1 1 45%;
                min-width: 120px;
                margin-bottom: 8px;
                font-size: 0.95rem;
                padding: 8px 0;
            }

            /* Hide desktop action row in mobile */
            .desktop-action-row {
                display: none !important;
            }

            /* Show mobile action row for AI, GAHAR, Diagnose */
            .mobile-action-row {
                display: flex !important;
                flex-direction: row;
                gap: 8px;
                margin-bottom: 10px;
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
            }

            .mobile-action-row .btn-enhanced {
                flex: 1 1 0;
                min-width: 0;
                padding: 10px 0;
                border-radius: 8px;
                font-size: 0.95rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-action-row {
                display: none !important;
            }

            .desktop-action-row {
                display: flex !important;
            }
        }

        @media (min-width: 576px) {
            .sidebar-close-btn {
                display: none;
            }
        }

        /* ...existing code... */
        .dashboard-row-custom {
            display: flex;
            gap: 24px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .dashboard-row-custom>div {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        @media (max-width: 900px) {
            .dashboard-row-custom {
                flex-direction: column;
                gap: 16px;
            }
        }

        /* Add to your CSS or inject via JS */
        .tat-table-enhanced {
            font-size: 0.92em;
            border-collapse: collapse;
            width: 100%;
            background: #f8fafd;
        }

        .tat-table-enhanced th,
        .tat-table-enhanced td {
            padding: 4px 8px;
            line-height: 1.2;
            border: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .tat-table-enhanced th {
            background: #e3eafc;
            font-weight: 600;
            color: #234;
            font-size: 0.98em;
            letter-spacing: 0.01em;
        }

        .tat-table-enhanced tr {
            min-height: 24px;
        }

        .tat-table-enhanced tbody tr:nth-child(even) {
            background: #f3f6fb;
        }

        .tat-status-badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.88em;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .tat-on-time {
            background: #e6f9e6;
            color: #218838;
        }

        .tat-exceeded {
            background: #ffeaea;
            color: #c82333;
        }

        .tat-faster {
            background: #eaf4ff;
            color: #005cbf;
        }

        .footerText {

            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ffffff;
            color: #202020;
            font-family: "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", sans-serif;
            box-shadow: 0 -1px 6px rgba(0, 0, 0, 0.04);
            z-index: 9999;
        }

        /* ...existing code... */
        .department-count-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.92em;
            margin-bottom: 0;
            background: #f8fafd;
        }

        .department-count-table th,
        .department-count-table td {
            border: 1px solid #e0e0e0;
            padding: 2px 8px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.95em;
            font-weight: 500;
        }

        .department-count-table th {
            background: #e3eafc;
            color: #234;
            font-weight: 600;
            font-size: 0.98em;
            letter-spacing: 0.01em;
        }

        .department-count-table tr {
            min-height: 20px;
        }

        .department-count-table tbody tr:nth-child(even) {
            background: #f3f6fb;
        }
    </style>


</head>

<body>
    <header>
        <div class="logo">
            <img src="images/datalab_icon3.ico" alt="Logo" class="logo-image" width="50" height="50">
            <span id="header-logo-text">
                DataLab.M.S Pro<span style="font-size: 0.6em; vertical-align: super;">AI</span>
            </span>
        </div>



        <button class="mobile-toggle" id="mobileToggle">
            <i class="fas fa-bars"></i>
        </button>
        <nav id="mainNav">
            <ul>
                <!-- add icon for subscription.html page-->
                <li>
                    <a href="Subscription.html" id="subscriptionLink">
                        <i class="fas fa-id-badge" aria-hidden="true"></i>
                        <span id="subscriptionText">Billing</span>
                    </a>
                </li>
                <li class="nav-item me-2">
                    <div class="input-group " style="width: 250px;">
                        <input type="text" class="form-control search-bar" id="globalSearchNav"
                            placeholder="Global Search"><i class="fas fa-barcode btn btn-outline-light"
                            id="globalSearchNavBtn"></i>
                    </div>
                    <!-- Place after globalSearchNav input in your navbar -->
                    <div class="mobile-action-row" id="mobileActionRow">

                        <button class="btn " id="dmsChatAIBtnMobile">
                            <i class="fas fa-robot "></i>
                        </button>
                        <button class="btn " id="gaharStandardBtnMobile">
                            <i class="fas fa-award "></i>
                        </button>
                        <button class="btn " id="medicalDiagnosticBtnMobile">
                            <i class="fas fa-stethoscope "></i>
                        </button>

                    </div>
                    <div id="searchResultsNav" class="position-absolute bg-white shadow rounded mt-1"
                        style="display: none; width: 400px; z-index: 1000; max-height: 400px; overflow-y: auto;">
                        <div class="list-group" id="resultsListNav"></div>
                    </div>
                </li>


                <li>
                    <a href="#" id="employeeRequestsLink" title="Employee Requests">
                        <i class="fas fa-users" style="color: #2196F3;"></i>
                        <span class="notification-badge" id="employeeRequestsCount"
                            style="display: none; background: #2196F3;">0</span>
                    </a>
                </li>
                <li>
                    <a href="Notification.html" id="notificationLink" title="Notification">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </li>






                <li id="userProfile" class="user-profile">
                    <span class="user-profile">

                        <div class="user-avatar" id="userAvatar">B</div>
                        <span id="userBranchName">name</span>
                    </span>
                </li>


                <li>

                    <button class="whoWeAre btn btn-primary" id="whoWeAreBtn" title="Who We Are">
                        <i class="fas fa-info-circle"></i>
                        <span id="whoWeAreText">About Us</span>
                    </button>
                </li>
                <li>
                    <a href="#" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="mainMenuText">Main Menu</div>
                <button class="language-toggle" id="languageToggle">
                    <i class="fas fa-language"></i>
                    <!----> <span id="languageText"></span>
                </button>
                <!-- Dark mode toggle button -->

                <button class="sidebar-close-btn" id="sidebarCloseBtn" title="Close Sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="sidebar-menu">


                <!--  CEO Dashboard -->
                <li id="ceoDashboardMenuItem">
                    <a href="CEO.html">
                        <div class="menu-icon all-patients-menu">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <span id="ceoDashboardText">CEO Dashboard</span>
                    </a>
                </li>


                <!-- Privacy & Policy item -->
                <li>
                    <a href="Privacy-Policy.html">
                        <div class="menu-icon" style="color: #1976d2; background-color: #e3f2fd;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span id="privacyPolicyText">Privacy & Policy</span>
                    </a>
                </li>






                <li>
                    <a href="Patient-Request.html">
                        <div class="menu-icon requests-menu">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <span id="patientsRequestsText">New Patient Record</span>
                        <span class="menu-badge" id="requestsBadge">0</span>
                    </a>
                </li>

                <li>
                    <a href="bulk_entry/bulk_entry.html">
                        <div class="menu-icon requests-menu">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <span id="bulkEntryText">New Bulk Entry</span>
                        <span class="menu-badge" id="requestsBadge">0</span>
                    </a>
                </li>


                <li>
                    <a href="Global-Search.html">
                        <div class="menu-icon patients-menu">
                            <i class="fas fa-search"></i>
                        </div>
                        <span id="globalSearchText">Global Search</span>
                    </a>
                </li>
                <li>
                    <a href="Results.html">
                        <div class="menu-icon results-menu">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <span id="resultsText">Results</span>
                        <span class="menu-badge" id="resultsBadge">0</span>
                    </a>
                </li>
                <li>
                    <a href="Price-Query.html">
                        <div class="menu-icon pricing-menu">
                            <i class="fas fa-tag"></i>
                        </div>
                        <span id="priceQueryText">Price Query</span>
                    </a>
                </li>
                <li>
                    <a href="All-Patients.html" id="allPatientsBtn">
                        <div class="menu-icon all-patients-menu">
                            <i class="fas fa-users"></i>
                        </div>
                        <span id="allPatientsText">All Patients</span>
                    </a>
                </li>

                <li>
                    <a href="Tests.html">
                        <div class="menu-icon tests-menu">
                            <i class="fas fa-vial"></i>
                        </div>
                        <span id="testsText">Tests</span>
                    </a>
                </li>
                <li>
                    <a href="Contracts.html">
                        <div class="menu-icon lab-exchange-menu">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span id="contractsText">Contracts</span>
                    </a>
                </li>
                <!-- lab to lab -->
                <li>
                    <a href="LabToLab.html">
                        <div class="menu-icon lab-exchange-menu">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span id="labToLabText">Lab to Lab</span>
                    </a>
                </li>

                <li>
                    <a href="Packages.html">
                        <div class="menu-icon all-patients-menu">
                            <i class="fas fa-database "></i>
                        </div>
                        <span id="packagesText">Packages</span>
                    </a>
                </li>
                <li>
                    <a href="HouseVisit.html">
                        <div class="menu-icon house-visit-menu">
                            <i class="fas fa-home"></i>
                        </div>
                        <span id="houseVisitText">House Visit Reservation</span>
                    </a>
                </li>
                <li>
                    <a href="DMSAiDiagnostics.html">
                        <div class="menu-icon doctors-menu">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <span id="medicalDiagnosticText">Medical Diagnostic</span>
                    </a>
                </li>
                <li>
                    <a href="Profiles.html">
                        <div class="menu-icon tests-menu">
                            <i class="fas fa-tag"></i>
                        </div>
                        <span id="testsProfilesText">Tests Profiles</span>
                    </a>
                </li>

                <li>
                    <a href="Precautions.html">
                        <div class="menu-icon tests-menu">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <span id="testPrecautionText">Test Precaution</span>
                    </a>
                </li>


                <li>
                    <a href="DMS-Ai-Tools.html">
                        <div class="menu-icon patients-menu">
                            <i class="fas fa-flask"></i>
                        </div>
                        <span id="aiAnalysisText">DMS Microscope AI Analysis</span>
                    </a>
                </li>



                <li>
                    <a href="Calculations.html">
                        <div class="menu-icon all-patients-menu">
                            <i class="fas fa-clipboard-check "></i>
                        </div>
                        <span id="manualCalculationsText">Manual Calculations</span>
                    </a>
                </li>
                <li>
                    <a href="Iso.html">
                        <div class="menu-icon iso-menu">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <span id="isoStandardText">ISO Standard</span>
                    </a>
                </li>
                <li>
                    <a href="Inventory.html">
                        <div class="menu-icon inventory-menu">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <span id="inventoryManagementText">Inventory Management</span>
                    </a>
                </li>




                <li>
                    <a href="Cash-Tally.html">
                        <div class="menu-icon cash-menu">
                            <i class="fas fa-cash-register"></i>
                        </div>
                        <span id="cashTallyText">Cash Tally</span>
                    </a>

                </li>






                <li>
                    <a href="Services-Report.html">
                        <div class="menu-icon all-patients-menu">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <span id="serviceReportText">Service Report</span>
                    </a>
                </li>




                <li>
                    <a href="Employee-Profile.html">
                        <div class="menu-icon doctors-menu">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <span id="doctorProfileText">Doctor Profile</span>
                        <span class="menu-badge" id="doctorQuizBadge" style="display:none; margin-left:8px;">0</span>
                    </a>
                </li>



            </ul>
        </aside>

        <main class="main-content">
            <div id="scrollingMarqueeContainer" style=" display:none;">
                <marquee id="scrollingMarquee" direction="right"
                    style="color:#198754; font-weight:bold; font-size:1.1rem;"></marquee>
            </div>
            <div class="page-header">
                <div>

                    <h1 class="page-title">
                        <i class="fas fa-tachometer-alt page-title-icon"></i>
                        <span id="dashboardTitleText">Dashboard</span>
                    </h1>


                </div>
                <div class="button-group">

                    <button class="btn" id="refreshBtn" title="Refresh Data">
                        <i class="fas fa-sync-alt text-warning" style="font-size: 20px; font-weight: bold;"></i>
                    </button>
                    <!--
  <button class="btn btn-enhanced" id="datalabAiAnalysisBtn">
                        <i class="fas fa-brain text-primary"></i>
                        <span class="btn-text">AI Lab Analysis</span>
                    </button>
-->

                    <!-- DMS Chat AI -->
                    <button class="btn  text-dark" id="dmsChatAIBtn">
                        <i class="fas fa-robot text-dark"></i>
                        <span class="btn-text">DMS Chat AI Zone</span>
                    </button>


                    <button class="btn btn-enhanced" id="gaharStandardBtn">
                        <i class="fas fa-award text-warning"></i>
                        <span class="btn-text">GAHAR</span>
                    </button>



                    <button class="btn btn-enhanced" id="medicalDiagnosticBtn">
                        <i class="fas fa-stethoscope text-danger"></i>
                        <span class="btn-text">Diagnostics</span>
                    </button>


                    <button class="btn btn-enhanced sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-sliders-h"></i>
                        <span class="btn-text"></span>
                    </button>

                </div>


            </div>

            <div class="welcome-banner">

                <div class="welcome-row">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h2 class="welcome-title"><span id="welcomeBackText">Welcome Back,</span><a
                                    href="Employee-Profile.html"><span id="welcomeTitle">Dr. John Doe!</span></a>
                            </h2>
                            <span class="branch-badge" id="workingRoleSpan">
                                <span id="workingRoleLabel">Role:</span>
                                <span id="workingRoleValue">--</span>
                            </span>
                            <span class="branch-badge" id="subscriptionCounterDashboard"
                                style="display:none; margin-left:10px; background:linear-gradient(135deg,#ff6a00 0%,#ee0979 100%);color:#fff;font-weight:600; font-size: 13px;">
                                <span id="subscriptionCounterDashboardValue">Loading...</span>
                            </span>
                            <span id="roleCountdownAvatar" style="display:inline-block;vertical-align:middle;">
                                <span id="roleCountdownCircle"
                                    style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:#fbbc05;color:#fff;font-weight:bold;font-size:1.1em;">5</span>
                            </span>
                        </div>
                        <button class="quick-action-btn " id="loggedInEmployeesBtn" title="Logged-in Employees"
                            style="display:none;">
                            <i class="fas fa-user-check"></i>
                        </button>
                    </div>

                    <div id="employeeInfoPanel">
                        <span class="branch-badge" id="employeeCodeSpan">
                            <span id="employeeCodeLabel">Employee Code:</span>
                            <span id="employeeCodeValue">--</span>
                        </span>

                        <span class="branch-badge" id="loginAtSpan">
                            <span id="loginAtLabel">Login At:</span>
                            <span id="loginAtValue">--</span>
                        </span>
                        <span class="branch-badge" id="workingHoursSpan">
                            <span id="workingHoursLabel">Daily Total:</span>
                            <span id="workingHoursValue">--</span>
                        </span>
                        <span class="branch-badge" id="shiftTotalSpan">
                            <span id="shiftTotalLabel">Shift's Today:</span>
                            <span id="shiftTotalValue">--</span>
                        </span>
                    </div>
                </div>

                <div id="assignedQuizzesInfo" style="display:none;"></div>

                <p class="welcome-message" id="welcomeMessage">
                    <span id="welcomeMessagePart1">You have</span>
                    <span id="pendingTestsCount">0</span>
                    <span id="welcomeMessagePart2">pending test requests and</span>
                    <span id="welcomeMessagePart3">results ready for review.</span>
                    <span id="welcomeMessagePart4">The lab is currently processing</span>
                    <span id="processingTestsCount">0</span>
                    <span id="welcomeMessagePart5">tests today.</span>
                </p>

                <div class="header-actions">
                    <div id="networkStatus" class="network-badge me-3" onclick="configServerIP()">
                        <i class="fas fa-network-wired"></i>
                        <span id="statusText">Checking Network...</span>
                    </div>
                    <button class="quick-action-btn" id="addPatientOrderBtn">
                        <i class="fas fa-plus"></i>
                        <span id="newPatientOrderBtnText">New Patient Record</span>
                    </button>


                    <button class="quick-action-btn" id="recordResultsBtn">
                        <i class="fas fa-file-medical"></i>
                        <span id="recordResultsBtnText">Record Results</span>
                    </button>

                    <button class="quick-action-btn" id="newUpdates">
                        <i class="fas fa-database"></i>
                        <span id="newUpdatesBtnText">New Updates</span>
                    </button>

                    <button class="quick-action-btn" id="sendOutBtn">
                        <i class="fas fa-paper-plane"></i>
                        <span id="sendOutBtnText">Send Out</span>
                    </button>
                    <button class="quick-action-btn help-btn" onclick="openHelpPage()">
                        <i class="fas fa-question-circle"></i>
                        <span>Help</span>
                    </button>
                    <div id="network-speed-container"></div>
                </div>

            </div>


            <!-- Updated Stats Grid Section -->
            <div class="stats-grid">
                <!-- Find this block: -->
                <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                    <div class="stat-icon patients-menu">
                        <i class="fas fa-procedures"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title" id="todayPatientsText">Today's Patients</div>
                        <div class="stat-value" id="todayPatientsCount">0</div>
                        <!-- ADD THIS LINE BELOW -->
                        <div class="stat-change" id="patientsChange"></div>
                        <div class="stat-chart">
                            <canvas id="patientsChart" height="50"></canvas>
                        </div>
                    </div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                    <div class="stat-icon tests-menu">
                        <i class="fas fa-vial"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title" id="testsTodayText">Tests Today</div>
                        <div class="stat-value" id="todayTestsCount">0</div>
                        <div class="stat-chart">
                            <canvas id="testsChart" height="50"></canvas>
                        </div>
                    </div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                    <div class="stat-icon requests-menu">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title" id="pendingRequestsText">Pending Requests</div>
                        <div class="stat-value" id="pendingRequestsCount">0</div>
                        <div class="stat-chart">
                            <canvas id="requestsChart" height="50"></canvas>
                        </div>
                    </div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.4s;">
                    <div class="stat-icon results-menu">
                        <i class="fas fa-file-medical"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-title" id="resultsReadyText">Results Ready</div>
                        <div class="stat-value" id="readyResultsCountStat">0</div>
                        <div class="stat-chart">
                            <canvas id="resultsChart" height="50"></canvas>
                        </div>
                    </div>
                </div>


            </div>


            <!-- Add this table below stats-grid -->
            <div class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 style="font-size:1.1rem;">Today's Tests by Department</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="department-count-table" id="testsByDepartmentTable">
                            <thead>
                                <tr id="deptHeaderRow"></tr>
                            </thead>
                            <tbody>
                                <tr id="deptCountRow"></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>





            <div class="card-grid">
                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <div class="card-icon patients-menu">
                            <i class="fas fa-procedures"></i>
                        </div>
                        <h3 class="card-title" id="recentPatientsText">Recent Patients</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-value" id="recentPatientsCount">0 New Today</div>
                        <p class="card-description" id="recentPatientsDescription">0 walk-ins and 0 doctor referrals
                            added to the system.</p>
                    </div>
                    <div class="card-footer">
                        <a href="All-Patients.html">
                            <span id="viewAllPatientsText">View All Patients</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <div class="card fade-in" style="animation-delay: 0.2s;">
                    <div class="card-header">
                        <div class="card-icon tests-menu">
                            <i class="fas fa-vial"></i>
                        </div>
                        <h3 class="card-title" id="popularTestsText">Popular Tests</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-value" id="popularTestsCount">0</div>
                        <p class="card-description" id="popularTestsList">Loading popular tests...</p>
                    </div>
                    <div class="card-footer">
                        <a href="Global-Search.html">
                            <span id="viewAllTestsText">View All Tests</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <div class="card fade-in" style="animation-delay: 0.3s;">
                    <div class="card-header">
                        <div class="card-icon inventory-menu">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h3 class="card-title" id="inventoryAlertText">Inventory Alert</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-value" id="inventoryAlertCount">0 Items Low</div>
                        <p class="card-description" id="inventoryAlertItems">Loading inventory status...</p>
                    </div>
                    <div class="card-footer">
                        <a href="Inventory.html">
                            <span id="manageInventoryText">Manage Inventory</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="dashboard-row-custom" style="display: flex; gap: 24px; margin-bottom: 2rem;">
                <div class="recent-activity fade-in" style="flex: 1; min-width: 280px; max-width: 400px;">
                    <h3 id="recentActivityText">Recent Activity</h3>
                    <ul class="activity-list" id="activityList">
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="activity-content">
                                <h4 class="activity-title" id="loadingActivitiesText">Loading activities...</h4>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="tat-periodization fade-in" style="flex: 2; min-width: 320px;">
                    <h3 id="tatPeriodizationTitle">Today's TAT Periodization</h3>
                    <div id="tatPeriodizationTableContainer" style="max-height: 600px; overflow-y: auto;"></div>

                    <!-- TAT table will be loaded here by recent_tat.js -->
                </div>
            </div>
    </div>
    </main>
    </div>



    <!-- Add this before </main> -->

    <!-- Employees Currently Logged In Overlay -->
    <div class="notification-overlay " id="loggedInEmployeesModal">
        <div class="notification-dialog" style="max-width:900px; min-width:400px; min-height:480px;">
            <div class="notification-header  text-white">
                <h3>
                    <i class="fas fa-user-check"></i>
                    <span id="loggedInEmployeesModalLabel">Employees Currently Logged In</span>
                </h3>
                <button class="close-btn" id="loggedInEmployeesModalCloseBtn" style="color:#fff;">&times;</button>
            </div>
            <div class="notification-body" style="min-height:350px;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover ">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Employee Code</th>
                                <th>Working Role</th>
                                <th>Last Login</th>

                                <th>Daily Total</th>
                                <th>City</th>
                                <th>Street</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="loggedInEmployeesTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p id="footerText">&copy; 2023 All rights reserved. DataLab Management System Pro v1.06- Lab Management
            Platform.
        </p>
    </footer>

    <!-- Notification Overlay -->
    <div class="notification-overlay" id="notificationOverlay">
        <div class="notification-dialog">
            <div class="notification-header">
                <h3><i class="fas fa-bell"></i> <span id="notificationDialogTitle">Notifications</span></h3>
                <button class="close-btn" id="notificationCloseBtn">&times;</button>
            </div>
            <div class="notification-body" id="notificationDialogBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="notification-footer">
                <button class="btn btn-outline" id="markAllReadBtn">
                    <i class="fas fa-check-circle"></i> <span id="markAllReadText">Mark All as Read</span>
                </button>
            </div>
        </div>
    </div>


    <div class="notification-overlay" id="surveyOverlay">
        <div class="notification-dialog" style="max-width:900px; min-width:400px; min-height:480px;">
            <div class="notification-header bg-warning">
                <h3>
                    <i class="fas fa-clipboard-list"></i>
                    <span id="surveyOverlayTitle">Survey</span>
                    <span
                        style="margin-left:10px; font-size:1rem; background:#fff; color:#198754; border-radius:6px; padding:2px 8px;">Special
                        Survey</span>
                </h3>
                <button class="close-btn" id="surveyOverlayCloseBtn" style="color:#fff;">&times;</button>
            </div>
            <div class="notification-body" id="surveyOverlayBody" style="min-height:350px;">
                <div class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="notification-footer">
                <button class="btn btn-warning w-100" id="surveyOverlaySubmitBtn">
                    <i class="fas fa-check-circle"></i> <span id="surveyOverlaySubmitText">Submit Survey</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Buy Requests Overlay -->
    <div class="notification-overlay" id="buyRequestsOverlay">
        <div class="notification-dialog" style="max-width:900px; min-width:400px; min-height:480px;">
            <div class="notification-header" style="background-color: #ff5722;">
                <h3>
                    <i class="fas fa-shopping-cart"></i>
                    <span id="buyRequestsTitle">Buy Requests</span>
                </h3>
                <button class="close-btn" id="buyRequestsCloseBtn" style="color:#fff;">&times;</button>
            </div>
            <div class="notification-body" id="buyRequestsBody" style="min-height:350px;">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="notification-footer">
                <button class="btn btn-success w-100" id="markAllAsPaidBtn">
                    <i class="fas fa-check-circle"></i>
                    <span id="markAllAsPaidText">Mark All as Paid</span>
                </button>
            </div>
        </div>
    </div>





    <div class="notification-overlay" id="employeeRequestsModal">
        <div class="notification-dialog" style="max-width:900px; min-width:400px; min-height:480px;">
            <div class="notification-header" style="background:#2196F3;">
                <h3>
                    <i class="fas fa-users"></i>
                    <span>Employee Requests</span>
                </h3>
                <button class="close-btn" id="employeeRequestsModalCloseBtn" style="color:#fff;">&times;</button>
            </div>
            <div class="notification-body" id="employeeRequestsModalBody" style="min-height:350px;">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a class="btn btn-primary ai-float-btn">
        <i class="fas fa-robot"></i>
    </a>

    <a class="btn btn-warning branches-shifts-float-btn" id="branchesShifts">
        <i class="fas fa-calendar-days"></i>
    </a>

    <!-- Medical Tip Toast Notification -->
    <div id="medical-tip-toast"
        style="display:none; position:fixed; bottom:30px; right:30px; z-index:3000; min-width:280px; max-width:350px; background:#fffbe7; color:#333; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.18); padding:18px 22px; font-size:1.1rem; border:2px solid #ffc107; transition:all 0.4s; opacity:0;">
    </div> <!-- Firebase SDK -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="firebase_config.js"></script>


    <script src="permissions.js"></script>

    <script src="homepage_features_js/floating_images_hpage.js"></script>


    <script src="homepage_features_js/logedin_employees.js"></script>

    <script src="homepage_features_js/medical_tips.js"></script>

    <script src="homepage_features_js/homepage_ai.js"></script>


    <script src="homepage_features_js/branches_shifts.js"></script>
    <script src="homepage_features_js/register_device_auth.js"></script>

    <script src="homepage_features_js/recent_tat.js"></script>


    <script src="logout.js"></script>
    <script src="global_files/upgrade.js"></script>
    <script src="global_files/errors_handled.js"> </script>
    <script src="global_files/global_api_ai.js"></script>

    <script src="global_files/global_whatsapp.js"></script>
    <script>

        // Add this to homepage.html
        document.addEventListener('DOMContentLoaded', function () {
            document.body.classList.add('page-slide-in');

            // Remove the class after animation completes
            setTimeout(() => {
                document.body.classList.remove('page-slide-in');
            }, 600);
        });
        function fetchUserProfile(email) {
            if (localStorage.getItem('isPersonalUse') === 'true' && email === 'personal@datalab.ms') {
                const userData = {
                    fullName: 'Master Admin',
                    branch: 'Main Branch',
                    employee_branchCode: 'MB001',
                    employeeCode: '123',
                    working_role: 'admin'
                };
                window.currentUserBranch = userData.branch;
                document.getElementById('userBranchName').textContent = `${userData.branch} (${userData.employee_branchCode})`;
                document.getElementById('welcomeTitle').textContent = `Dr. ${userData.fullName}!`;
                document.getElementById('employeeCodeValue').textContent = userData.employeeCode;
                document.getElementById('workingRoleValue').textContent = userData.working_role;
                document.getElementById('userAvatar').textContent = 'MA';
                if (typeof showAdminMenus === 'function') showAdminMenus(userData.working_role);
                if (typeof showBranchManagerMenus === 'function') showBranchManagerMenus(userData.working_role);
                const floatBtn = document.querySelector('.branches-shifts-float-btn');
                if (floatBtn) floatBtn.style.display = 'flex';
                return Promise.resolve();
            }
            return db.collection('employees').doc(email).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        window.currentUserBranch = userData.branch || null;
                        const fullName = userData.fullName || 'User';

                        const branchName = userData.branch || 'N/A';
                        const branchCode = userData.employee_branchCode || 'N/A';

                        document.getElementById('userBranchName').textContent = `${branchName} (${branchCode})`;

                        document.getElementById('welcomeTitle').textContent = `Dr. ${fullName}!`;

                        // Update static spans in employeeInfoPanel
                        document.getElementById('employeeCodeValue').textContent = userData.employeeCode || '--';
                        document.getElementById('workingRoleValue').textContent = userData.working_role || '--';

                        // Set user avatar initials or image
                        const userAvatarDiv = document.getElementById('userAvatar');
                        if (userData.profile_image) {
                            userAvatarDiv.innerHTML = `<img src="${userData.profile_image}" alt="Avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">`;
                        } else {
                            const nameParts = fullName.trim().split(/\s+/);
                            let initials = '';
                            if (nameParts.length >= 2) {
                                initials = (nameParts[0][0] || '') + (nameParts[1][0] || '');
                            } else if (nameParts.length === 1) {
                                initials = (nameParts[0][0] || '') + (nameParts[0][1] || '');
                            } else {
                                initials = fullName.substring(0, 2);
                            }
                            userAvatarDiv.textContent = initials.toUpperCase();
                        }

                        // Update login info and shift info
                        updateLoginInfo(email);

                        // Show/hide admin menus
                        showAdminMenus(userData.working_role);
                        showBranchManagerMenus(userData.working_role);
                        showAssignedQuizzes(email);

                        // Float button for admin
                        const floatBtn = document.querySelector('.branches-shifts-float-btn');
                        if (floatBtn) {
                            floatBtn.style.display = (userData.working_role === 'admin') ? 'flex' : 'none';
                        }
                    } else {
                        console.log("No profile data found");
                    }
                })
                .catch((error) => {
                    console.error("Error fetching user profile:", error);
                });
        }

        // Update login info and shift info in spans
        async function updateLoginInfo(email) {
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            const monthStr = todayKey.slice(0, 7);
            const employeeRef = db.collection('employees').doc(email.toLowerCase());

            // Get today's total working hours from Firestore
            const totalHoursDoc = await employeeRef.collection('total_working_hours').doc(monthStr).get();
            let totalHoursStr = "0h 0m";
            if (totalHoursDoc.exists && totalHoursDoc.data()[todayKey]) {
                totalHoursStr = totalHoursDoc.data()[todayKey];
            }
            document.getElementById('workingHoursValue').textContent = totalHoursStr;

            // Get first login time for today
            const startOfDay = new Date(todayKey + 'T00:00:00');
            const endOfDay = new Date(todayKey + 'T23:59:59');
            const historySnap = await employeeRef.collection('login_history')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                .orderBy('timestamp')
                .get();

            let firstLogin = null;
            historySnap.forEach(doc => {
                const entry = doc.data();
                if (entry.action === 'Login.html' && !firstLogin) {
                    firstLogin = entry.timestamp.toDate();
                }
            });

            const loginAtText = firstLogin ? firstLogin.toLocaleTimeString() : 'N/A';
            document.getElementById('loginAtValue').textContent = loginAtText;

            await showTodayShift(email);
        }

        async function showTodayShift(email) {
            const now = new Date();
            const dateKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const monthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const doc = await db.collection('shifts_timetable')
                .doc(window.currentUserBranch)
                .collection('months')
                .doc(monthYear)
                .collection('days')
                .doc(dateKey)
                .get();

            let shiftText = 'No shift assigned today';
            if (doc.exists && Array.isArray(doc.data().shifts)) {
                const shifts = doc.data().shifts;
                const empShift = shifts.find(s => s.employeeId === email || s.employee === email);
                if (empShift) {
                    shiftText = `${empShift.name} (${empShift.time})`;
                }
            }
            document.getElementById('shiftTotalValue').textContent = shiftText;
        }

        // Add near your sidebar JS logic
        document.getElementById('sidebarCloseBtn').addEventListener('click', function () {
            document.querySelector('.sidebar').classList.remove('active');
        });
        window.addEventListener('DOMContentLoaded', function () {
            const globalSearchNavInput = document.getElementById('globalSearchNav');
            if (globalSearchNavInput) {
                globalSearchNavInput.focus();
            }
        });
        function loadScrollingMarquee() {
            db.collection('scrolling_marquee')
                .where('status', '==', 'active')
                .orderBy('createdAt', 'desc')
                .get()
                .then((snapshot) => {

                    const marqueeContainer = document.getElementById('scrollingMarqueeContainer');
                    const marquee = document.getElementById('scrollingMarquee');
                    if (!snapshot.empty) {
                        //       |
                        const messages = snapshot.docs.map(doc => doc.data().message).filter(Boolean);
                        marquee.textContent = messages.join('  |  ');
                        marqueeContainer.style.display = 'block';
                    } else {
                        marquee.textContent = '';
                        marqueeContainer.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error("Error loading marquee:", error);
                });
        }
        document.addEventListener('DOMContentLoaded', function () {
            loadScrollingMarquee();
        });
        //
        const translations = {
            en: {
                // Header
                "header-logo-text": "DataLab.M.S Pro<sup>AI</sup>",
                "whoWeAreText": "About Us",
                "subscriptionText": "Billing",

                // Sidebar
                "mainMenuText": "Main Menu",
                "languageText": "",
                "adminPanelText": "Admin Panel",
                "ceoDashboardText": "CEO Dashboard",
                "branchManagerText": "Branch Manager",
                "privacyPolicyText": "Privacy & Policy",
                "patientsText": "Patients",
                "patientsRequestsText": "New Patient Record",
                "globalSearchText": "Global Search",
                "resultsText": "Results",
                "priceQueryText": "Price Query",
                "allPatientsText": "All Patients",
                "testsText": "Tests",
                "contractsText": "Contracts",
                "labToLabText": "Lab to Lab",
                "packagesText": "Packages",
                "houseVisitText": "House Visit Reservation",
                "medicalDiagnosticText": "Medical Diagnostic",
                "testsProfilesText": "Tests Profiles",
                "testPrecautionText": "Test Precaution",
                "aiAnalysisText": "DMS Microscope AI Analysis",
                "manualCalculationsText": "Manual Calculations",
                "isoStandardText": "ISO Standard",
                "inventoryManagementText": "Inventory Management",
                "cashTallyText": "Cash Tally",
                "serviceReportText": "Service Report",
                "doctorProfileText": "Doctor Profile",

                // Dashboard
                "dashboardTitleText": "Dashboard",

                "welcomeMessagePart1": "You have",
                "welcomeMessagePart2": "pending test requests and",
                "welcomeMessagePart3": "results ready for review.",
                "welcomeMessagePart4": "The lab is currently processing",
                "welcomeMessagePart5": "tests today.",
                "newPatientBtnText": "New Patient",
                "newPatientOrderBtnText": "New Patient Record",
                "houseVisitBtnText": "Book House Visit",
                "newUpdatesBtnText": "New Updates",
                "sendOutBtnText": "Send Out (Mega Lab)",

                // Stats
                "todayPatientsText": "Today's Patients",
                "testsTodayText": "Tests Today",
                "pendingRequestsText": "Pending Results",
                "resultsReadyText": "Results Ready",

                // Cards
                "recentPatientsText": "Recent Patients",
                "viewAllPatientsText": "View All Patients",
                "popularTestsText": "Popular Tests",
                "viewAllTestsText": "View All Tests",
                "inventoryAlertText": "Inventory Alert",
                "manageInventoryText": "Manage Inventory",

                // Activity
                "recentActivityText": "Recent Activity",
                "loadingActivitiesText": "Loading activities...",

                // Footer


                // Notifications
                "notificationDialogTitle": "Notifications",
                "markAllReadText": "Mark All as Read",
                "noNotificationsText": "No new notifications",
                "loggedInEmployeesModalLabel": "Employees Currently Logged In",

                // Buy Requests
                "buyRequestsTitle": "Buy Requests",
                "markAllAsPaidText": "Mark All as Paid",

                // Survey
                "surveyOverlayTitle": "Survey",
                "surveyOverlaySubmitText": "Submit Survey",
                "employeeCodeLabel": "Employee Code:",
                "workingRoleLabel": "Role:",
                "loginAtLabel": "Login At:",
                "workingHoursLabel": "Daily Total:",
                "shiftTotalLabel": "Shift's Today:"

            },
            ar: {
                // Header
                "header-logo-text": "  ",
                "whoWeAreText": " ",
                "subscriptionText": "",

                // Sidebar
                "mainMenuText": " ",
                "languageText": "English",
                "adminPanelText": " ",
                "ceoDashboardText": "  ",
                "branchManagerText": " ",
                "privacyPolicyText": " ",
                "patientsText": "",
                "patientsRequestsText": " ",
                "globalSearchText": " ",
                "resultsText": "",
                "priceQueryText": " ",
                "allPatientsText": " ",
                "testsText": "",
                "contractsText": "",
                "labToLabText": " ",
                "packagesText": "",
                "houseVisitText": "  ",
                "medicalDiagnosticText": " ",
                "testsProfilesText": " ",
                "testPrecautionText": " ",
                "aiAnalysisText": "   ",
                "manualCalculationsText": " ",
                "isoStandardText": "  ",
                "inventoryManagementText": " ",
                "cashTallyText": "  ",
                "serviceReportText": "  ",
                "doctorProfileText": " ",

                // Dashboard
                "dashboardTitleText": " ",

                "welcomeMessagePart1": "",
                "welcomeMessagePart2": "    ",
                "welcomeMessagePart3": "  .",
                "welcomeMessagePart4": "  ",
                "welcomeMessagePart5": " .",
                "newPatientBtnText": " ",
                "newPatientOrderBtnText": "  ",
                "houseVisitBtnText": "  ",
                "newUpdatesBtnText": " ",
                "sendOutBtnText": " ",

                // Stats
                "todayPatientsText": " ",
                "testsTodayText": " ",
                "pendingRequestsText": "   ",
                "resultsReadyText": "  ",

                // Cards
                "recentPatientsText": " ",
                "viewAllPatientsText": "  ",
                "popularTestsText": " ",
                "viewAllTestsText": "  ",
                "inventoryAlertText": " ",
                "manageInventoryText": " ",

                // Activity
                "recentActivityText": " ",
                "loadingActivitiesText": "  ...",

                // Footer
                "footerText": " 2023      .   .",

                // Notifications
                "notificationDialogTitle": "",
                "markAllReadText": "  ",
                "noNotificationsText": "   ",
                "loggedInEmployeesModalLabel": "  ",

                // Buy Requests
                "buyRequestsTitle": " ",
                "markAllAsPaidText": "  ",

                // Survey
                "surveyOverlayTitle": "",
                "surveyOverlaySubmitText": " ",
                "employeeCodeLabel": " :",
                "workingRoleLabel": " :",
                "loginAtLabel": " :",
                "workingHoursLabel": " :",
                "shiftTotalLabel": " :",
                "welcomeBackText": "  . "
            }
        };
        function initializeLanguage() {
            const savedLanguage = localStorage.getItem('datalab-language') || 'en';
            setLanguage(savedLanguage);

            // Set up language toggle
            document.getElementById('languageToggle').addEventListener('click', () => {
                const currentLanguage = document.documentElement.lang;
                const newLanguage = currentLanguage === 'en' ? 'ar' : 'en';
                localStorage.setItem('datalab-language', newLanguage);
                location.reload(); // Reload only when toggling language
            });
        }

        // Set language
        function setLanguage(language) {
            document.documentElement.lang = language;
            document.documentElement.dir = language === 'ar' ? 'rtl' : 'ltr';

            // Update all translatable elements
            const langData = translations[language];
            for (const [key, value] of Object.entries(langData)) {
                const elements = document.querySelectorAll(`[id="${key}"]`);
                elements.forEach(el => {
                    if (el.tagName === 'INPUT') {
                        el.placeholder = value;
                    } else {
                        el.innerHTML = value; // Use innerHTML to allow HTML tags
                    }
                });
            }

            // Update language toggle text
            document.getElementById('languageText').textContent =
                language === 'en' ? '' : 'English';



        }



        // DOM elements
        const addPatientOrderBtn = document.getElementById('addPatientOrderBtn');
        const datalabAiAnalysisBtn = document.getElementById('datalabAiAnalysisBtn');
        const recordResultsBtn = document.getElementById('recordResultsBtn');
        const gaharStandardBtn = document.getElementById('gaharStandardBtn');

        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const whoWeAreBtn = document.querySelector('.whoWeAre');
        const globalSearchNav = document.getElementById('globalSearchNav');
        const globalSearchNavBtn = document.getElementById('globalSearchNavBtn');
        const searchResultsNav = document.getElementById('searchResultsNav');
        const resultsListNav = document.getElementById('resultsListNav');
        const notificationOverlay = document.getElementById('notificationOverlay');
        const notificationCloseBtn = document.getElementById('notificationCloseBtn');
        const notificationDialogBody = document.getElementById('notificationDialogBody');
        const markAllReadBtn = document.getElementById('markAllReadBtn');

        // Initialize language
        initializeLanguage();

        // Toggle sidebar on small screens
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            // For large screens, collapse/expand sidebar width
            if (window.innerWidth > 992) {
                if (sidebar.classList.contains('active')) {
                    sidebar.style.marginLeft = '0';
                    sidebar.style.width = '60px';
                } else {
                    sidebar.style.marginLeft = '';
                    sidebar.style.width = '';
                }
            }
        });

        let userPermissionsObj = null;


        auth.onAuthStateChanged(async (user) => {
            if (user || localStorage.getItem('isPersonalUse') === 'true') {
                const email = user ? user.email : 'personal@datalab.ms';

                fetchUserProfile(email).then(() => {
                    loadAllPatientsForSearch(() => {
                        fetchDashboardData();
                        updateLoginInfo(email);
                        updateDoctorQuizBadge(email);
                    });
                });

                enforceUserPermissions(email).then(perms => {
                    userPermissionsObj = perms;
                });

                if (localStorage.getItem('isPersonalUse') !== 'true') {
                    await checkLateLoginAndAddDeduction(email);
                    await checkAndSaveEmployeeAbsencesLast7Days();
                    await savePreviousDayTotalHours(email);
                }

                checkAndShowSurveyOverlay();
            } else {
                window.location.href = 'Login.html';
            }
        });

        async function updateDoctorQuizBadge(email) {
            try {
                const quizzesSnap = await db.collection('employees').doc(email).collection('quizes')
                    .where('status', '!=', 'completed').get();
                const count = quizzesSnap.size;
                const badge = document.getElementById('doctorQuizBadge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                const badge = document.getElementById('doctorQuizBadge');
                if (badge) badge.style.display = 'none';
            }
        }

        // Helper to check permission
        function hasPermission(perm) {
            if (!userPermissionsObj) return false;
            return !!userPermissionsObj[perm];
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Map hrefs to permission keys
            const permissionMap = {
                'CEO.html': 'ceo_dashboard',
                'Branch-Manager.html': 'branch_manager',

                'Privacy-Policy.html': 'privacy_policy',

                'patients.html': 'patients',
                'Patient-Request.html': 'patients_requests',
                'Global-Search.html': 'global_search',
                'Results.html': 'Results.html',
                'Price-Query.html': 'price_query',
                'Allpatients.html': 'all_patients',
                'Tests.html': 'Tests.html',
                'Contracts.html': 'contracts',
                'LabToLab.html': 'lab_to_lab',
                'Packages.html': 'packages',
                'HouseVisit.html': 'house_visit',
                'DMSAiDiagnostics.html': 'medical_diagnostic',
                'Profiles.html': 'tests_profiles',
                'Precautions.html': 'test_precaution',
                'DMS-Ai-Tools.html': 'microscope_analysis',

                'Calculations.html': 'manual_calculations',
                'Iso.html': 'iso_standard',
                'Inventory.html': 'inventory_management',
                'Cash-Tally.html': 'cash_tally',
                'Services-Report.html': 'house_visit_report',
                'Employee-Profile.html': 'doctor_profile',

                'Gahar.html': 'gahar_standard',
                'SendOut.html': 'send_out',
                'New-Updates.html': 'new_updates',

                'Smart-DMS-Ai-Chat.html': 'dms_chat_ai',

                // Add more mappings as needed

            };

            // Sidebar menu links
            document.querySelectorAll('.sidebar-menu a').forEach(function (a) {
                a.addEventListener('click', function (e) {
                    let href = a.getAttribute('href');
                    if (href && permissionMap[href]) {
                        if (!hasPermission(permissionMap[href])) {
                            e.preventDefault();
                            alert('You cannot open this function. Please contact the admin for access.');
                        }
                    }
                });
            });

            // Quick action buttons
            const quickActions = [
                { id: 'addPatientOrderBtn', perm: 'new_patient_order' },
                { id: 'housevisitbtn', perm: 'book_house_visit' },
                { id: 'recordResultsBtn', perm: 'Results.html' },


                { id: 'medicaldiadnosticbtn', perm: 'medical_diagnostic_btn' },
                { id: 'datalabAiAnalysisBtn', perm: 'microscope_analysis_btn' },

                { id: 'dmsChatAIBtn', perm: 'dms_chat_ai' },

                { id: 'gaharStandardBtn', perm: 'gahar_standard_btn' },

                { id: 'subscriptionLink', perm: 'subscription' },
                { id: 'notificationLink', perm: 'notification' },
                { id: 'sendOutBtn', perm: 'send_out' },
                { id: 'newUpdates', perm: 'new_updates' },

                { id: 'dmsChatAIBtnMobile', perm: 'dms_chat_ai' },
                { id: 'medicaldiadnosticbtnMobile', perm: 'medical_diagnostic_btn' },
                { id: 'datalabAiAnalysisBtnMobile', perm: 'microscope_analysis_btn' },

            ];
            quickActions.forEach(({ id, perm }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', function (e) {
                        if (!hasPermission(perm)) {
                            e.preventDefault();
                            alert('You cannot open this function. Please contact the admin for access.');
                        }
                    });
                }
            });
        });


        // Add these functions with other functions
        function initializeSearch() {
            // Load all patients and orders for search
            loadAllPatientsForSearch();
            loadAllOrdersForSearch();
        }

        // Show admin-only menu items if user is admin

        function showAdminMenus(working_role) {
            // Show/hide CEO Dashboard menu item only
            var ceoDashboardMenuItem = document.getElementById('ceoDashboardMenuItem');
            if (ceoDashboardMenuItem) ceoDashboardMenuItem.style.display = (working_role === 'admin') ? 'block' : 'none';
            // Show/hide Subscription in navbar
            var subscriptionLink = document.getElementById('subscriptionLink');
            if (subscriptionLink) {
                subscriptionLink.style.display = (working_role === 'admin') ? 'block' : 'none';
            }


        }



        function showBranchManagerMenus(working_role) {
            // Show/hide CEO Dashboard menu item only
            var branchManagerMenuItem = document.getElementById('branchManagerMenuItem');

            if (branchManagerMenuItem) branchManagerMenuItem.style.display =
                (working_role === 'branch_manager' || working_role === 'admin' || working_role === 'it') ? 'block' : 'none';
            // Show/hide Subscription in navbar


            var loggedInEmployeesBtn = document.getElementById('loggedInEmployeesBtn');

            if (loggedInEmployeesBtn) loggedInEmployeesBtn.style.display =
                (working_role === 'branch_manager' || working_role === 'admin' || working_role === 'it') ? 'block' : 'none';
            // Show/hide Subscription in navbar

        }


        async function showAssignedQuizzes(email) {
            const quizzesSnap = await db.collection('employees').doc(email).collection('quizes')
                .where('status', '==', 'assigned').get();
            const count = quizzesSnap.size;
            const infoDiv = document.getElementById('assignedQuizzesInfo');
            if (count > 0) {
                infoDiv.textContent = `You have ${count} assigned quiz.`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Call this inside fetchUserProfile(email) after setting the welcome title








        function fetchDashboardData() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let todayPatients = 0;
            let todayTests = 0;
            let pendingRequests = 0;
            let readyResults = 0;
            let recentPatients = 0;
            let recentWalkIns = 0;
            let recentDoctorReferrals = 0;
            let testCounts = {};

            // Use all patients, not filtered by branch
            const patients = allPatientsForSearch;

            patients.forEach(patient => {
                const ordersArr = Array.isArray(patient.orders) ? patient.orders : [];
                ordersArr.forEach(order => {
                    let orderDate;
                    if (order.order_date instanceof Date) {
                        orderDate = order.order_date;
                    } else if (order.order_date && typeof order.order_date === 'object' && typeof order.order_date.toDate === 'function') {
                        orderDate = order.order_date.toDate();
                    } else if (order.order_date) {
                        orderDate = new Date(order.order_date);
                    }
                    if (!orderDate) return;

                    // Count today's patients/orders
                    if (orderDate >= today) {
                        todayPatients++;
                        todayTests += Array.isArray(order.tests) ? order.tests.length : 0;
                        recentPatients++;
                        if (order.patient_type === 'normal') recentWalkIns++;
                        if (order.patient_type === 'packages') recentDoctorReferrals++;
                        // Count popular tests
                        if (Array.isArray(order.tests)) {
                            order.tests.forEach(test => {
                                if (test.test_name) {
                                    testCounts[test.test_name] = (testCounts[test.test_name] || 0) + 1;
                                }
                            });
                        }
                    }
                    // Pending requests
                    if (order.status === 'pending' || order.status === 'Collected.html') pendingRequests++;
                    // Ready results
                    if (order.status === 'authenticated') readyResults++;
                });
            });



            today.setHours(0, 0, 0, 0);

            const departmentCounts = {};
            allPatientsForSearch.forEach(patient => {
                const ordersArr = Array.isArray(patient.orders) ? patient.orders : [];
                ordersArr.forEach(order => {
                    let orderDate;
                    if (order.order_date instanceof Date) {
                        orderDate = order.order_date;
                    } else if (order.order_date && typeof order.order_date === 'object' && typeof order.order_date.toDate === 'function') {
                        orderDate = order.order_date.toDate();
                    } else if (order.order_date) {
                        orderDate = new Date(order.order_date);
                    }
                    if (!orderDate || orderDate < today) return;
                    if (Array.isArray(order.tests)) {
                        order.tests.forEach(test => {
                            const dept = test.department || 'Unknown';
                            departmentCounts[dept] = (departmentCounts[dept] || 0) + 1;
                        });
                    }
                });
            });

            // Fill the table horizontally
            const deptHeaderRow = document.getElementById('deptHeaderRow');
            const deptCountRow = document.getElementById('deptCountRow');
            if (deptHeaderRow && deptCountRow) {
                deptHeaderRow.innerHTML = '';
                deptCountRow.innerHTML = '';
                const departments = Object.keys(departmentCounts);
                if (departments.length === 0) {
                    deptHeaderRow.innerHTML = `<th>No departments</th>`;
                    deptCountRow.innerHTML = `<td class="text-muted">No tests done today</td>`;
                } else {
                    departments.forEach(dept => {
                        deptHeaderRow.innerHTML += `<th>${dept}</th>`;
                        deptCountRow.innerHTML += `<td>${departmentCounts[dept]}</td>`;
                    });
                }
            }





            // Update dashboard stats
            document.getElementById('todayPatientsCount').textContent = todayPatients;
            document.getElementById('todayTestsCount').textContent = todayTests;
            document.getElementById('pendingRequestsCount').textContent = pendingRequests;
            document.getElementById('readyResultsCount').textContent = readyResults;
            document.getElementById('readyResultsCountStat').textContent = readyResults;
            document.getElementById('pendingTestsCount').textContent = pendingRequests;
            document.getElementById('processingTestsCount').textContent = todayTests;

            // Update recent patients card
            document.getElementById('recentPatientsCount').textContent = `${recentPatients} New Today`;
            document.getElementById('recentPatientsDescription').textContent =
                `${recentWalkIns} walk-ins and ${recentDoctorReferrals} doctor referrals added to the system.`;

            // Update popular tests card
            const popularTests = Object.entries(testCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            document.getElementById('popularTestsCount').textContent = popularTests.length > 0 ? popularTests[0][1] : '0';
            document.getElementById('popularTestsList').textContent = popularTests.length > 0 ?
                popularTests.map(test => `${test[0]} (${test[1]})`).join(', ') :

                'No test data available';

            // Update menu badges
            // ...inside fetchDashboardData...
            document.getElementById('requestsBadge').textContent = document.getElementById('todayPatientsCount').textContent;
            document.getElementById('resultsBadge').textContent = readyResults;

            loadRecentActivities();
        }
        function loadRecentActivities() {
            const activitiesList = document.getElementById('activityList');
            activitiesList.innerHTML = '';

            // Use all patients, not filtered by branch
            const patients = allPatientsForSearch;
            const activities = [];

            // Collect recent orders from all patients (last 24 hours)
            patients.forEach(patient => {
                const ordersArr = Array.isArray(patient.orders) ? patient.orders : [];
                ordersArr.forEach(order => {
                    let orderDate;
                    if (order.order_date instanceof Date) {
                        orderDate = order.order_date;
                    } else if (order.order_date && typeof order.order_date === 'object' && typeof order.order_date.toDate === 'function') {
                        orderDate = order.order_date.toDate();
                    } else if (order.order_date) {
                        orderDate = new Date(order.order_date);
                    }
                    if (!orderDate) return;

                    // Only orders from last 24 hours
                    if (orderDate >= new Date(Date.now() - 24 * 60 * 60 * 1000)) {
                        activities.push({
                            type: 'order',
                            status: order.status,
                            patientName: patient.fullName,
                            orderId: order.order_id,
                            date: orderDate
                        });
                    }
                });
            });

            // Sort activities by date (newest first)
            activities.sort((a, b) => b.date - a.date);

            // Display up to 5 most recent activities
            const recentActivities = activities.slice(0, 5);

            if (recentActivities.length === 0) {
                activitiesList.innerHTML = `
            <li class="activity-item">
                <span>No recent activities found.</span>
            </li>
        `;
                return;
            }

            recentActivities.forEach(activity => {
                const activityItem = document.createElement('li');
                activityItem.className = 'activity-item';

                let icon = '<i class="fas fa-clipboard-list"></i>';
                if (activity.status === 'authenticated') icon = '<i class="fas fa-file-medical"></i>';
                else if (activity.status === 'pending') icon = '<i class="fas fa-hourglass-half"></i>';
                else if (activity.status === 'Collected.html') icon = '<i class="fas fa-vial"></i>';

                const formattedTime = formatTimeDifference(activity.date);

                activityItem.innerHTML = `
            <div class="activity-icon">${icon}</div>
            <div class="activity-content">
                <div class="activity-title">Order #${activity.orderId}</div>
                <div class="activity-description">${activity.patientName} - Status: ${activity.status}</div>
                <div class="activity-time">${formattedTime}</div>
            </div>
        `;

                activitiesList.appendChild(activityItem);
            });
        }
        function formatTimeDifference(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (document.documentElement.lang === 'en') {
                if (diffInSeconds < 60) {
                    return `${diffInSeconds} seconds ago`;
                }

                const diffInMinutes = Math.floor(diffInSeconds / 60);
                if (diffInMinutes < 60) {
                    return `${diffInMinutes} minute${diffInMinutes !== 1 ? 's' : ''} ago`;
                }

                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) {
                    return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
                }

                const diffInDays = Math.floor(diffInHours / 24);
                return `${diffInDays} day${diffInDays !== 1 ? 's' : ''} ago`;
            } else {
                if (diffInSeconds < 60) {
                    return ` ${diffInSeconds} `;
                }

                const diffInMinutes = Math.floor(diffInSeconds / 60);
                if (diffInMinutes < 60) {
                    return ` ${diffInMinutes} `;
                }

                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) {
                    return ` ${diffInHours} `;
                }

                const diffInDays = Math.floor(diffInHours / 24);
                return ` ${diffInDays} `;
            }
        }

        // Button event listeners
        // Redirect to respective pages on button clicks
        // Make sure userPermissionsObj and hasPermission are defined as in previous answers

        addPatientOrderBtn.addEventListener('click', function (e) {
            if (!hasPermission('new_patient_order')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Patient-Request.html';
        });


        document.getElementById('medicalDiagnosticBtn').addEventListener('click', function (e) {
            if (!hasPermission('medical_diagnostic_btn')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'DMSAiDiagnostics.html';
        });


        document.getElementById('recordResultsBtn').addEventListener('click', function (e) {
            if (!hasPermission('Results.html')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Collected.html';
        });

        document.getElementById('newUpdates').addEventListener('click', function (e) {

            if (!hasPermission('new_updates')) {
                e.preventDefault();
                return;
            }

            window.location.href = 'New-Updates.html';
        });
        document.getElementById('sendOutBtn').addEventListener('click', function (e) {
            if (!hasPermission('send_out')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'SendOut.html';
        });





        /*
        document.getElementById('datalabAiAnalysisBtn').addEventListener('click', function (e) {
                if (!hasPermission('microscope_analysis_btn')) {
                    e.preventDefault();
                    return;
                }
                window.location.href = 'DMS-Ai-Tools.html';
            });
    
        */
        document.getElementById('dmsChatAIBtn').addEventListener('click', function (e) {
            if (!hasPermission('dms_chat_ai')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Smart-DMS-Ai-Chat.html';
        });

        gaharStandardBtn.addEventListener('click', function (e) {
            if (!hasPermission('gahar_standard_btn')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Gahar.html';
        });


        document.getElementById('whoWeAreBtn').addEventListener('click', function (e) {

            window.open('https://datalab-system.web.app/', '_blank');
        });

        ////////////////////////////////////////////////////////////////////////
        document.getElementById('dmsChatAIBtnMobile').addEventListener('click', function (e) {
            if (!hasPermission('dms_chat_ai')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Smart-DMS-Ai-Chat.html';
        });
        document.getElementById('gaharStandardBtnMobile').addEventListener('click', function (e) {
            if (!hasPermission('gahar_standard_btn')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'Gahar.html';
        });
        document.getElementById('medicalDiagnosticBtnMobile').addEventListener('click', function (e) {
            if (!hasPermission('medical_diagnostic_btn')) {
                e.preventDefault();
                return;
            }
            window.location.href = 'DMSAiDiagnostics.html';
        });
        // Add these event listeners
        globalSearchNav.addEventListener('input', (e) => {
            performGlobalSearch(e.target.value.trim());
        });

        globalSearchNavBtn.addEventListener('click', (e) => {
            e.preventDefault();
            performGlobalSearch(globalSearchNav.value.trim());
        });

        document.addEventListener('click', (e) => {
            if (!searchResultsNav.contains(e.target) && e.target !== globalSearchNav && e.target !== globalSearchNavBtn) {
                searchResultsNav.style.display = 'none';
            }
        });

        // Initialize search when page loads
        initializeSearch();











        document.addEventListener('DOMContentLoaded', () => {
            const animatedElements = document.querySelectorAll('.fade-in');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = 1;
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            animatedElements.forEach(element => {
                observer.observe(element);
            });
        });

        function loadAllPatientsForSearch(callback) {
            allPatientsForSearch = [];
            db.collection('new_record').get()
                .then((querySnapshot) => {
                    const patientMap = {};
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (Array.isArray(data.patients)) {
                            data.patients.forEach(patientObj => {
                                Object.values(patientObj).forEach(p => {
                                    if (p.details && p.details.patient_id) {
                                        const ordersArr = Array.isArray(p.orders) ? p.orders : [];
                                        const patient = {
                                            ...p.details,
                                            id: p.details.patient_id,
                                            orders: ordersArr,
                                            fullName: [
                                                p.details.firstName || '',
                                                p.details.secondName || '',
                                                p.details.thirdName || ''
                                            ].join(' ').trim()
                                        };
                                        patientMap[p.details.patient_id] = patient;
                                    }
                                });
                            });
                        }
                    });
                    allPatientsForSearch = Object.values(patientMap);

                    // Initialize Fuse.js for patient search
                    const options = {
                        keys: [
                            'patient_id',
                            'fullName',
                            'firstName',
                            'secondName',
                            'thirdName',
                            'mobile'
                        ],
                        includeScore: true,
                        threshold: 0.4,
                        ignoreLocation: true,
                        minMatchCharLength: 2
                    };

                    fusePatients = new Fuse(allPatientsForSearch, options);

                    // Call the callback after loading
                    if (typeof callback === 'function') callback();
                })
                .catch((error) => {
                    console.error("Error loading patients for search:", error);
                    if (typeof callback === 'function') callback();
                });
        }
        function displayPatientSearchResults(results) {
            results.forEach(result => {
                const patient = result.item;
                const item = document.createElement('div');
                item.className = 'list-group-item search-result-item d-flex align-items-center';

                let displayText = `${patient.patient_id} - ${patient.fullName}`;
                if (patient.mobile) displayText += ` (${patient.mobile})`;

                item.innerHTML = highlightMatches(displayText, result.matches);

                item.addEventListener('click', () => {
                    window.location.href = `/Patient-Request?patientId=${patient.id}`;
                    searchResultsNav.style.display = 'none';
                });

                resultsListNav.appendChild(item);
            });

            if (results.length > 0) {
                searchResultsNav.style.display = 'block';
            }
        }



        function performGlobalSearch(query) {
            if (!query || query.length < 2) {
                searchResultsNav.style.display = 'none';
                return;
            }

            resultsListNav.innerHTML = '';

            // --- Exact match logic for mobile or full name ---
            let exactOrderResults = [];
            // Check if query is a mobile number (all digits, 10-15 chars)
            if (/^\d{8,15}$/.test(query)) {
                exactOrderResults = allOrdersForSearch.filter(order =>
                    order.patientData && order.patientData.mobile && order.patientData.mobile.includes(query)
                );
            } else if (query.trim().split(/\s+/).length >= 2) {
                // If query has 2+ words, treat as full name (case-insensitive)
                const q = query.trim().toLowerCase();
                exactOrderResults = allOrdersForSearch.filter(order => {
                    const fullName = (order.patientData.fullName || [
                        order.patientData.firstName || '',
                        order.patientData.secondName || '',
                        order.patientData.thirdName || ''
                    ].join(' ')).toLowerCase().replace(/\s+/g, ' ').trim();
                    return fullName === q;
                });
            }

            if (exactOrderResults.length > 0) {
                // Show only exact matches
                exactOrderResults.slice(0, 6).forEach(order => {
                    // ...copy your order result rendering code here...
                    // (see your existing orderResults.forEach block)
                    // For brevity, you can call a helper:
                    renderOrderResultItem(order);
                });
                searchResultsNav.style.display = 'block';
                return;
            }

            // --- Fallback to fuzzy search if no exact match ---
            const orderResults = fuseOrders ? fuseOrders.search(query).slice(0, 6) : [];

            if (orderResults.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'list-group-item';
                noResults.textContent = document.documentElement.lang === 'en'
                    ? 'No matching orders found'
                    : '    ';
                resultsListNav.appendChild(noResults);
                searchResultsNav.style.display = 'block';
                return;
            }

            orderResults.forEach(result => {
                renderOrderResultItem(result.item, result.matches);
            });

            searchResultsNav.style.display = 'block';
        }

        // Helper to render order result item (copy your existing code here)
        function renderOrderResultItem(order, matches) {
            const patient = order.patientData;
            let fullName = patient.fullName || [
                patient.firstName || '',
                patient.secondName || '',
                patient.thirdName || ''
            ].join(' ').trim();

            const item = document.createElement('div');
            item.className = 'list-group-item search-result-item d-flex align-items-center';

            const lastDigits = order.patientId ? order.patientId.slice(-15) : '';

            // Status color logic
            let statusColor = '#6c757d'; // default
            if (order.status === 'Registered') statusColor = '#fbbc05'; // warning
            else if (order.status === 'authenticated') statusColor = '#1a73e8'; // primary
            else if (order.status === 'completed') statusColor = '#17a2b8'; // info
            else if (order.status === 'Collected.html') statusColor = '#198754'; // success

            let statusText = '';
            if (order.status) {
                statusText = `<span style="color:${statusColor}; font-weight:bold; margin-left:8px;">${order.status}</span>`;
            }

            let displayText = document.documentElement.lang === 'en'
                ? `Order ${order.order_id} - `
                : ` ${order.order_id} - `;
            displayText += document.documentElement.lang === 'en'
                ? ` (${order.tests.length} tests)`
                : ` (${order.tests.length} )`;

            displayText += `<br><strong>${fullName}</strong>`;
            if (lastDigits) {
                displayText += ` <span style="color:#888;font-size:0.95em;">(${lastDigits})</span>`;
            }
            displayText += ` ${statusText}`;

            item.innerHTML = `
<div class="flex-grow-1">${matches ? highlightMatches(displayText, matches) : displayText}</div>
<div class="order-actions-icons">
    <a href="Printing.html?patientId=${order.patientId}&orderId=${order.id}" title="${document.documentElement.lang === 'en' ? 'Print Results' : ' '}">
        <i class="fas fa-file-medical"></i>
    </a>
    <a href="Patient-Receipt.html?patientId=${order.patientId}&orderId=${order.id}" title="${document.documentElement.lang === 'en' ? 'Print Receipt' : ' '}">
        <i class="fas fa-receipt"></i>
    </a>
    <a href="Job-Order.html?patientId=${order.patientId}&orderId=${order.id}" title="${document.documentElement.lang === 'en' ? 'Print Job Order' : '  '}">
        <i class="fas fa-file-alt"></i>
    </a>
    <a href="Barcode.html?patientId=${order.patientId}&orderId=${order.id}" title="${document.documentElement.lang === 'en' ? 'Print Barcode' : ' '}">
        <i class="fas fa-barcode"></i>
    </a>
    <a href="#" class="whatsapp-action" data-patient-id="${order.patientId}" data-order-id="${order.id}" title="WhatsApp">
        <i class="fab fa-whatsapp text-success"></i>
    </a>
    <a href="Patient-Request.html?patientId=${order.patientId}&orderId=${order.id}" 
       title="${document.documentElement.lang === 'en' ? 'View Details' : ' '}"
       class="view-details-link"
       ${!hasPermission('view_out_patient_details') && order.patientData.branch !== window.currentUserBranch ? 'tabindex="-1" aria-disabled="true" style="pointer-events:none;opacity:0.5;"' : ''}>
        <i class="fas fa-eye text-info"></i>
    </a>
        <a href="Recording.html?patientId=${order.patientId}&orderId=${order.id}" 
           title="${document.documentElement.lang === 'en' ? 'Record Results' : ' '}"
           class="record-results-link"
              ${!hasPermission('record_results') && order.patientData.branch !== window.currentUserBranch ? 'tabindex="-1" aria-disabled="true" style="pointer-events:none;opacity:0.5;"' : ''}>
                <i class="fas fa-notes-medical text-warning"></i>
        </a>

</div>
`;

            item.querySelector('.whatsapp-action').addEventListener('click', async function (e) {
                e.preventDefault();
                const patientId = this.getAttribute('data-patient-id');
                const orderId = this.getAttribute('data-order-id');

                // Fetch patient from loaded array
                const patientData = allPatientsForSearch.find(p => p.id === patientId);
                if (!patientData) {
                    alert('Patient not found');
                    return;
                }
                const mobile = patientData.mobile;
                if (!mobile) {
                    alert('Patient mobile number not found');
                    return;
                }
                // Get the password (adjust the field name if needed)
                const autoPassword = patientData.autoPassword || patientData.auto_password;
                if (!autoPassword) {
                    alert('Patient password not found');
                    return;
                }
                const resultsUrl = getResultsUrl(patientId, autoPassword);
                const message = getWhatsAppMessage(resultsUrl, patientId, autoPassword);

                const whatsappWebUrl = `https://web.whatsapp.com/send?phone=20${mobile}&text=${encodeURIComponent(message)}`;
                window.open(whatsappWebUrl, '_blank');

                // Update whats_status in Firestore (new_record)
                // Find the doc and update the order inside patients array
                const partsSnapshot = await db.collection('new_record').get();
                let updated = false;
                for (const doc of partsSnapshot.docs) {
                    const data = doc.data();
                    if (Array.isArray(data.patients)) {
                        for (let i = 0; i < data.patients.length; i++) {
                            const patientObj = data.patients[i];
                            for (const key in patientObj) {
                                const p = patientObj[key];
                                if (p.details && p.details.patient_id === patientId && Array.isArray(p.orders)) {
                                    const order = p.orders.find(o => o.order_id === orderId || o.id === orderId);
                                    if (order) {
                                        order.whatsapp_status = 'sent';
                                        await db.collection('new_record').doc(doc.id).update({
                                            patients: data.patients
                                        });
                                        updated = true;
                                        break;
                                    }
                                }
                            }
                            if (updated) break;
                        }
                    }
                    if (updated) break;
                }
            });

            item.addEventListener('click', (e) => {
                if (!e.target.closest('.order-actions-icons')) {
                    window.location.href = `/Patient-Request?patientId=${order.patientId}&orderId=${order.id}`;
                    searchResultsNav.style.display = 'none';
                }
            });

            resultsListNav.appendChild(item);
        }

        function loadAllOrdersForSearch() {
            allOrdersForSearch = [];

            // Use already loaded patients from allPatientsForSearch
            if (!Array.isArray(allPatientsForSearch) || allPatientsForSearch.length === 0) {
                setTimeout(loadAllOrdersForSearch, 500);
                return;
            }

            allPatientsForSearch.forEach(patientData => {
                const ordersArr = Array.isArray(patientData.orders) ? patientData.orders : [];
                ordersArr.forEach(order => {
                    allOrdersForSearch.push({
                        ...order,
                        id: order.order_id || order.id, // Ensure id is set
                        patientId: patientData.id,
                        patientData: patientData
                    });
                });
            });

            // Initialize Fuse.js for order search
            const options = {
                keys: [
                    'id',
                    'order_id',
                    'patientData.fullName',
                    'patientData.firstName',
                    'patientData.secondName',
                    'patientData.thirdName',
                    'patientData.mobile',
                    'patientData.patient_id'
                ],
                includeScore: true,
                threshold: 0.4,
                ignoreLocation: true,
                minMatchCharLength: 2
            };

            fuseOrders = new Fuse(allOrdersForSearch, options);
        }
        function highlightMatches(text, matches) {
            if (!matches) return text;

            const matchedIndices = new Set();
            matches.forEach(match => {
                match.indices.forEach(([start, end]) => {
                    for (let i = start; i <= end; i++) {
                        matchedIndices.add(i);
                    }
                });
            });

            let result = '';
            for (let i = 0; i < text.length; i++) {
                if (matchedIndices.has(i)) {
                    result += `<span class="search-result-highlight">${text[i]}</span>`;
                } else {
                    result += text[i];
                }
            }

            return result;
        }

        // --- Enhanced Notification System ---

        // Notification state
        let recentNotifications = [];
        let unreadNotifications = 0;

        // Helper to avoid opening dialog repeatedly
        let notificationDialogWasShown = false;

        // Toggle notification overlay
        function toggleNotificationOverlay(show) {
            if (show) {
                notificationOverlay.classList.add('active');
                loadNotifications();
            } else {
                notificationOverlay.classList.remove('active');
            }
        }

        // Load notifications
        function loadNotifications() {
            notificationDialogBody.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

            db.collection('notifications')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get()
                .then((snapshot) => {

                    recentNotifications = [];
                    unreadNotifications = 0;

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        recentNotifications.push({
                            id: doc.id,
                            ...data,
                            createdAt: data.createdAt?.toDate()
                        });

                        if (!data.isOlder) {
                            unreadNotifications++;
                        }
                    });

                    renderNotifications();
                    updateNotificationBadge();

                    // Open dialog if there are unread notifications and not already shown
                    if (unreadNotifications > 0 && !notificationDialogWasShown) {
                        toggleNotificationOverlay(true);
                        notificationDialogWasShown = true;
                    }
                })
                .catch((error) => {
                    console.error("Error loading notifications:", error);
                    notificationDialogBody.innerHTML = `
                        <div class="alert alert-danger text-center my-4">
                            ${document.documentElement.lang === 'en' ?
                            'Failed to load notifications' :
                            '  '}
                        </div>
                    `;
                });
        }

        // Render notifications in the dialog
        function renderNotifications() {
            // Only show unread (recent) notifications
            const recentOnly = recentNotifications.filter(n => !n.isOlder);

            if (recentOnly.length === 0) {
                notificationDialogBody.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash fa-3x mb-3"></i>
                        <p>${document.getElementById('noNotificationsText').textContent}</p>
                    </div>
                `;
                return;
            }

            notificationDialogBody.innerHTML = '';

            recentOnly.forEach(notif => {
                const notifElement = document.createElement('div');
                notifElement.className = `notification-item unread`;

                const timeAgo = formatTimeDifference(notif.createdAt);

                notifElement.innerHTML = `
                    <div class="notification-title">
                        <span>${notif.title || 'No Title'}</span>
                        <span class="notification-time">${timeAgo}</span>
                    </div>
                    <div class="notification-content">${notif.body || ''}</div>
                    <div class="notification-meta">
                        <span>${notif.projectId || 'System Notification'}</span>
                    </div>
                    <div class="notification-actions">
                        <button class="notification-btn mark-read" data-id="${notif.id}">
                            <i class="fas fa-check-circle"></i> ${document.documentElement.lang === 'en' ? 'Mark as Read' : ' '}
                        </button>
                    </div>
                `;

                notificationDialogBody.appendChild(notifElement);
            });

            // Add event listeners to mark as read buttons
            document.querySelectorAll('.notification-btn.mark-read').forEach(btn => {
                btn.addEventListener('click', function () {
                    const notificationId = this.getAttribute('data-id');
                    markNotificationAsRead(notificationId);
                });
            });
        }

        // Mark notification as read
        function markNotificationAsRead(notificationId) {
            db.collection('notifications').doc(notificationId).update({
                isOlder: true
            })
                .then(() => {
                    // Update local state
                    const notification = recentNotifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.isOlder = true;
                        unreadNotifications--;
                        updateNotificationBadge();
                        renderNotifications();
                    }
                    // Close the dialog after marking as read
                    toggleNotificationOverlay(false);
                    notificationDialogWasShown = false;
                })
                .catch(error => {
                    console.error("Error marking notification as read:", error);
                });
        }

        // Mark all notifications as read
        function markAllNotificationsAsRead() {
            const batch = db.batch();
            const notificationsToMark = recentNotifications.filter(n => !n.isOlder);

            if (notificationsToMark.length === 0) return;

            notificationsToMark.forEach(notif => {
                const notifRef = db.collection('notifications').doc(notif.id);
                batch.update(notifRef, { isOlder: true });
            });

            batch.commit()
                .then(() => {
                    // Update local state
                    recentNotifications.forEach(n => n.isOlder = true);
                    unreadNotifications = 0;
                    updateNotificationBadge();
                    renderNotifications();
                })
                .catch(error => {
                    console.error("Error marking all notifications as read:", error);
                });
        }

        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            badge.textContent = unreadNotifications;

            if (unreadNotifications > 0) {
                badge.style.display = 'inline-flex';
                badge.classList.add('pulse');
            } else {
                badge.style.display = 'none';
                badge.classList.remove('pulse');
            }
        }

        // Check for new notifications periodically
        function checkForNewNotifications() {
            db.collection('notifications')
                .where('isOlder', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get()
                .then((snapshot) => {

                    if (!snapshot.empty) {
                        // If there is a new unread notification, reload and open dialog
                        if (!notificationOverlay.classList.contains('active')) {
                            loadNotifications();
                        }
                    }
                })
                .catch(error => {
                    console.error("Error checking for new notifications:", error);
                });
        }

        // When dialog is closed, allow it to auto-open again if new notifications arrive
        notificationCloseBtn.addEventListener('click', () => {
            toggleNotificationOverlay(false);
            notificationDialogWasShown = false;
        });

        // Show popup for new notification
        function showNewNotificationPopup(notification) {
            // Create a temporary popup element
            const popup = document.createElement('div');
            popup.className = 'notification-popup';
            popup.innerHTML = `
                <div class="notification-popup-content">
                    <div class="notification-popup-header">
                        <i class="fas fa-bell"></i>
                        <h4>New Notification</h4>
                        <button class="notification-popup-close">&times;</button>
                    </div>
                    <div class="notification-popup-body">
                        <h5>${notification.title || 'New Notification'}</h5>
                        <p>${notification.body || ''}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                popup.classList.add('fade-out');
                setTimeout(() => popup.remove(), 300);
            }, 5000);

            // Close button
            popup.querySelector('.notification-popup-close').addEventListener('click', () => {
                popup.classList.add('fade-out');
                setTimeout(() => popup.remove(), 300);
            });

            // Click to open full notifications
            popup.addEventListener('click', () => {
                toggleNotificationOverlay(true);
                popup.remove();
            });
        }

        // Event listeners for notification UI
        notificationCloseBtn.addEventListener('click', () => {
            toggleNotificationOverlay(false);
        });




        markAllReadBtn.addEventListener('click', () => {
            markAllNotificationsAsRead();
        });

        // Close notification overlay when clicking outside
        notificationOverlay.addEventListener('click', (e) => {
            if (e.target === notificationOverlay) {
                toggleNotificationOverlay(false);
            }
        });

        // Initialize notification system
        function initializeNotificationSystem() {
            // Load initial notifications
            loadNotifications();

            // Check for new notifications every 30 seconds
            setInterval(checkForNewNotifications, 30000);
        }

        // Initialize notification system when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeNotificationSystem();
        });

        function updateInventoryAlertCard() {
            db.collection("Inventory.html").get().then((querySnapshot) => {

                let lowItems = [];
                let lowItemsNames = [];
                let reagentDetails = [];
                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    if (
                        typeof item.currentStock === "number" &&
                        typeof item.minStock === "number" &&
                        item.currentStock < item.minStock
                    ) {
                        lowItems.push(item);
                        // If item is Reagent and has test info, show test name
                        if (item.name === "Reagents" && item.testName) {
                            reagentDetails.push(`${item.testName} (ID: ${item.testId})`);
                            lowItemsNames.push(`Reagents for ${item.testName}`);
                        } else {
                            lowItemsNames.push(item.name || "Unnamed Item");
                        }
                    }
                });

                // Update card value and description
                const alertCount = document.getElementById('inventoryAlertCount');
                const alertItems = document.getElementById('inventoryAlertItems');
                const card = alertCount.closest('.card');

                if (lowItems.length > 0) {
                    alertCount.textContent = `${lowItems.length} Items Low`;
                    // Show reagent details if any

                    let detailsText;
                    if (reagentDetails.length > 0) {
                        detailsText = reagentDetails.map(d => `Reagents for ${d}`).join(', ');
                        // Add other low items (non-reagents)
                        if (lowItemsNames.length > reagentDetails.length) {
                            const nonReagentNames = lowItemsNames.filter(n => !n.startsWith('Reagents for'));
                            if (nonReagentNames.length > 0) {
                                detailsText += ', ' + nonReagentNames.join(', ');
                            }
                        }
                    } else {
                        detailsText = lowItemsNames.join(', ');
                    }
                    alertItems.textContent = detailsText;
                    alertItems.style.color = '#dc3545'; // Bootstrap danger color
                } else {
                    alertCount.textContent = document.documentElement.lang === 'en'
                        ? 'All Stocks Sufficient' : '  ';
                    alertItems.textContent = document.documentElement.lang === 'en'
                        ? 'No items are below minimum stock levels.'
                        : '  .';
                    alertItems.style.color = '#198754'; // Bootstrap success color
                }
                // Make card clickable if there are low items
                const cardFooterLink = card.querySelector('.card-footer a');
                if (lowItems.length > 0) {
                    cardFooterLink.onclick = function (e) {
                        e.preventDefault();
                        window.location.href = "Inventory.html#low.html";
                    };
                    cardFooterLink.style.pointerEvents = 'auto';
                    cardFooterLink.style.opacity = '1';
                } else {
                    cardFooterLink.onclick = null;
                    cardFooterLink.style.pointerEvents = 'none';
                    cardFooterLink.style.opacity = '0.5';
                }

            });
        }

        // Call this after dashboard loads
        fetchDashboardData = (function (orig) {
            return function () {
                orig.apply(this, arguments);
                updateInventoryAlertCard();
            };
        })(fetchDashboardData);




        // let subscriptionLink appear only when subscription status is active when it hold not appear this in page on firestore subscription collection > status: "hold"
        // the path of status is subscription > status > status: "active" or "hold"
        function checkSubscriptionStatus() {
            db.collection('subscription').doc('status').get().then((doc) => {

                if (doc.exists) {
                    const status = doc.data().status;
                    const subscriptionLink = document.getElementById('subscriptionLink');
                    if (status === 'active') {
                        subscriptionLink.style.display = 'block';
                    } else {
                        subscriptionLink.style.display = 'none';
                    }
                }
            }).catch((error) => {
                console.error("Error fetching subscription status:", error);
            });
        }
        // Call this function to check subscription status
        checkSubscriptionStatus();
        //----------------------------------------------------------------------------------------------------------------------



        function renderSurveyOverlay(survey, surveyId) {
            document.getElementById('surveyOverlayTitle').textContent = survey.title || 'Survey';
            document.getElementById('surveyOverlayBody').innerHTML = `
        <h6 class="mb-4" style="font-size: 17px; font-weight: bold; padding-bottom: 15px;">${survey.description || 'Please take a moment to complete this survey.'}</h6>
        <form id="surveyOverlayForm">
            ${survey.questions.map((q, index) => `
                <div class="mb-4">
                    <label class="form-label" style="font-size:1.1rem;">${index + 1}. ${q.text}</label>
                    ${q.type === 'rating' ? `
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-star text-warning"></i></span>
                            <select class="form-select survey-answer" name="q${index}">
                                <option value="">Select rating</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    ` : q.type === 'yesno' ? `
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-question-circle text-info"></i></span>
                            <select class="form-select survey-answer" name="q${index}">
                                <option value="">Select</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    ` : `
                        <input type="text" class="form-control survey-answer" name="q${index}" placeholder="Type your answer...">
                    `}
                </div>
            `).join('')}
        </form>
    `;
            document.getElementById('surveyOverlay').classList.add('active');
            document.getElementById('surveyOverlayCloseBtn').style.display = 'none';
            document.getElementById('surveyOverlaySubmitBtn').onclick = function () {
                submitSurveyOverlay(survey, surveyId);
            };
        }












        function submitSurveyOverlay(survey, surveyId) {
            const form = document.getElementById('surveyOverlayForm');
            const answers = [];
            let allAnswered = true;
            survey.questions.forEach((q, idx) => {
                const input = form.querySelector(`[name="q${idx}"]`);
                const value = input ? input.value : '';
                if (!value) allAnswered = false;
                answers.push({
                    question: q.text,
                    answer: value
                });
            });

            if (!allAnswered) {
                alert('Please answer all questions before submitting.');
                return;
            }

            db.collection('surveys').doc(surveyId).collection('answers').add({
                user: auth.currentUser ? auth.currentUser.email : 'anonymous',
                answers,
                submittedAt: new Date()
            }).then(() => {
                document.getElementById('surveyOverlay').classList.remove('active');
                alert('Thank you for completing our survey!');
                // Show close button again if needed
                document.getElementById('surveyOverlayCloseBtn').style.display = '';
            }).catch((err) => {
                alert('Error saving survey answer');
            });
        }

        // Check for active survey and if user has answered
        function checkAndShowSurveyOverlay() {
            db.collection('surveys')
                .where('status', '==', 'active')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .get()
                .then(snapshot => {

                    if (!snapshot.empty) {
                        const surveyDoc = snapshot.docs[0];
                        const survey = surveyDoc.data();
                        const surveyId = surveyDoc.id;
                        // Check if user already answered
                        db.collection('surveys').doc(surveyId).collection('answers')
                            .where('user', '==', auth.currentUser ? auth.currentUser.email : 'anonymous')
                            .get()
                            .then(ansSnap => {

                                if (ansSnap.empty) {
                                    renderSurveyOverlay(survey, surveyId);
                                }
                            });
                    }
                });
        }



    </script>






    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const mobileToggle = document.getElementById('mobileToggle');
            const mainNav = document.getElementById('mainNav');

            // Toggle nav open/close
            mobileToggle.addEventListener('click', function (e) {
                e.stopPropagation(); // Prevent document click from firing
                mainNav.classList.toggle('active');
            });

            // Close nav when clicking outside on mobile
            document.addEventListener('click', function (e) {
                if (window.innerWidth <= 992) {
                    if (!mainNav.contains(e.target) && e.target !== mobileToggle) {
                        mainNav.classList.remove('active');
                    }
                }
            });

            // Close nav when clicking a nav item on mobile
            mainNav.querySelectorAll('a, button').forEach(link => {
                link.addEventListener('click', function () {
                    if (window.innerWidth <= 992) {
                        mainNav.classList.remove('active');
                    }
                });
            });
        });





    </script>



    <script>
        // Initialize charts
        let patientsChart, testsChart, requestsChart, resultsChart;

        function initCharts() {
            // Patients Chart
            const patientsCtx = document.getElementById('patientsChart').getContext('2d');
            patientsChart = new Chart(patientsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#4285f4',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });

            // Tests Chart
            const testsCtx = document.getElementById('testsChart').getContext('2d');
            testsChart = new Chart(testsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#34a853',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });

            // Requests Chart
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            requestsChart = new Chart(requestsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#ea4335',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });

            // Results Chart
            const resultsCtx = document.getElementById('resultsChart').getContext('2d');
            resultsChart = new Chart(resultsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#673ab7',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            display: false
                        }
                    }
                }
            });
        }







        // refresh from refresh button
        document.getElementById('refreshBtn').addEventListener('click', function () {
            location.reload();
        });



        document.getElementById('employeeRequestsLink').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('employeeRequestsModal').classList.add('active');
            loadEmployeeRequests();
        });

        document.getElementById('employeeRequestsModalCloseBtn').addEventListener('click', function () {
            document.getElementById('employeeRequestsModal').classList.remove('active');
        });

        document.getElementById('employeeRequestsModal').addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });









        async function loadEmployeeRequests() {


            const body = document.getElementById('employeeRequestsModalBody');
            body.innerHTML = `<div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>`;


            let permissions = [];
            let shiftChanges = [];
            let leaveRequests = [];



            // Fetch leave requests (absence_requests) with status 'pending'
            const leaveSnap = await db.collection('absence_requests')
                .where('status', '==', 'pending')
                .orderBy('requestedAt', 'desc')
                .get();

            leaveSnap.forEach(doc => {
                const data = doc.data();
                leaveRequests.push({ ...data, id: doc.id });
            });


            // Get all employees
            const employeesSnap = await db.collection('employees').get();
            const employeeCodes = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                if (data.employeeCode) employeeCodes.push(data.employeeCode);
            });



            for (const code of employeeCodes) {
                const doc = await db.collection('permissions').doc(code).get();
                if (doc.exists && Array.isArray(doc.data().permissions)) {
                    doc.data().permissions.forEach((perm, idx) => {
                        if (perm.status === 'pending') {
                            permissions.push({
                                ...perm,
                                employeeCode: code,
                                id: idx // index in array, not Firestore doc id
                            });
                        }
                    });
                }


                // Fetch shift changes for each employee
                const shiftsSnap = await db.collection('shifts_timetable').doc('shift_change').collection(code).get();
                shiftsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'Pending') {
                        shiftChanges.push({ ...data, employeeCode: code, id: doc.id });
                    }
                });
            }

            // Render results with action icons
            let html = '';
            html += `<h5>Pending Permissions</h5>`;
            if (permissions.length === 0) {
                html += `<div class="alert alert-info">No pending permissions.</div>`;
            } else {
                html += `<div class="table-responsive">
        <table class="table table-bordered table-hover" style="border:2px solid #2196F3; border-radius:8px; background:#fff;">
            <thead class="table-light">
                <tr>
                    <th>Employee Code</th>
                    <th>Date</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Shift</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;
                permissions.forEach((p, idx) => {
                    html += `<tr>
            <td>${p.employeeCode}</td>
            <td>${p.date}</td>
            <td>${p.from}</td>
            <td>${p.to}</td>
            <td>${p.shift}</td>
            <td><span class="badge bg-warning">${p.status}</span></td>
            <td>
                <i class="fas fa-check-circle text-success action-btn approve-btn me-2" title="Approve" data-type="permission" data-idx="${idx}"></i>
                <i class="fas fa-times-circle text-danger action-btn reject-btn" title="Reject" data-type="permission" data-idx="${idx}"></i>
            </td>
        </tr>`;
                });
                html += `</tbody></table></div>`;
            }

            html += `<h5 class="mt-4">Pending Shift Changes</h5>`;
            if (shiftChanges.length === 0) {
                html += `<div class="alert alert-info">No pending shift changes.</div>`;
            } else {
                html += `<div class="table-responsive">
        <table class="table table-bordered table-hover" style="border:2px solid #2196F3; border-radius:8px; background:#fff;">
            <thead class="table-light">
                <tr>
                    <th>Employee Code</th>
                    <th>Date</th>
                    <th>My Shift</th>
                    <th>Requested With</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;
                shiftChanges.forEach((s, idx) => {
                    html += `<tr>
            <td>${s.employeeCode}</td>
            <td>${s.date}</td>
            <td>${s.myShift}</td>
            <td>${s.changeWith}</td>
            <td><span class="badge bg-warning">${s.status}</span></td>
            <td>
                <i class="fas fa-check-circle text-success action-btn approve-btn me-2" title="Approve" data-type="shift_change" data-idx="${idx}"></i>
                <i class="fas fa-times-circle text-danger action-btn reject-btn" title="Reject" data-type="shift_change" data-idx="${idx}"></i>
            </td>
        </tr>`;
                });
                html += `</tbody></table></div>`;
            }


            html += `<h5 class="mt-4">Pending Leave Requests</h5>`;
            if (leaveRequests.length === 0) {
                html += `<div class="alert alert-info">No pending leave requests.</div>`;
            } else {
                html += `<div class="table-responsive">
        <table class="table table-bordered table-hover" style="border:2px solid #198754; border-radius:8px; background:#fff;">
            <thead class="table-light">
                <tr>
                    <th>Employee Name</th>
                    <th>Employee Code</th>
                    <th>Type</th>
                    <th>Days</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;
                leaveRequests.forEach((r, idx) => {
                    html += `<tr>
            <td>${r.employeeName || '-'}</td>
            <td>${r.employeeCode || '-'}</td>
            <td>${r.type || '-'}</td>
            <td>${r.days || '-'}</td>
            <td>${r.fromDate || '-'}</td>
            <td>${r.toDate || '-'}</td>
            <td>${r.reason || '-'}</td>
            <td><span class="badge bg-warning">${r.status}</span></td>
            <td>
                <i class="fas fa-check-circle text-success action-btn approve-leave-btn me-2" title="Approve" data-idx="${idx}"></i>
                <i class="fas fa-times-circle text-danger action-btn reject-leave-btn" title="Reject" data-idx="${idx}"></i>
            </td>
        </tr>`;
                });
                html += `</tbody></table></div>`;
            }


            body.innerHTML = html;

            body.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const type = btn.getAttribute('data-type');
                    const idx = btn.getAttribute('data-idx');
                    if (type === 'permission') {
                        const p = permissions[idx];
                        // Approve permission (array update)
                        const docRef = db.collection('permissions').doc(p.employeeCode);
                        const docSnap = await docRef.get();
                        if (docSnap.exists && Array.isArray(docSnap.data().permissions)) {
                            const permsArr = docSnap.data().permissions;
                            permsArr[p.id].status = 'approved';
                            await docRef.update({ permissions: permsArr });
                        }
                    } else if (type === 'shift_change') {
                        const s = shiftChanges[idx];
                        await db.collection('shifts_timetable')
                            .doc('shift_change')
                            .collection(s.employeeCode)
                            .doc(s.id)
                            .update({ status: 'Approved' });
                    }
                    loadEmployeeRequests();
                });
            });

            body.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const type = btn.getAttribute('data-type');
                    const idx = btn.getAttribute('data-idx');
                    if (type === 'permission') {
                        const p = permissions[idx];
                        await db.collection('shifts_timetable')
                            .doc('permissions')
                            .collection(p.employeeCode)
                            .doc(p.dateKey)
                            .collection('items')
                            .doc(p.id)
                            .update({ status: 'Rejected' });
                    } else if (type === 'shift_change') {
                        const s = shiftChanges[idx];
                        await db.collection('shifts_timetable')
                            .doc('shift_change')
                            .collection(s.employeeCode)
                            .doc(s.id)
                            .update({ status: 'Rejected' });
                    }
                    loadEmployeeRequests();
                });
            });

            // Add event listeners for leave requests actions
            body.querySelectorAll('.approve-leave-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const idx = btn.getAttribute('data-idx');
                    const r = leaveRequests[idx];
                    await db.collection('absence_requests').doc(r.id).update({ status: 'approved' });
                    loadEmployeeRequests();
                });
            });
            body.querySelectorAll('.reject-leave-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const idx = btn.getAttribute('data-idx');
                    const r = leaveRequests[idx];
                    await db.collection('absence_requests').doc(r.id).update({ status: 'rejected' });
                    loadEmployeeRequests();
                });
            });



        }





        async function updateEmployeeRequestsBadge() {
            let pendingCount = 0;

            // Get all employees
            const employeesSnap = await db.collection('employees').get();
            const employeeCodes = [];
            employeesSnap.forEach(doc => {
                const data = doc.data();
                if (data.employeeCode) employeeCodes.push(data.employeeCode);
            });

            // Count pending permissions
            for (const code of employeeCodes) {
                const dateDocs = await db.collection('shifts_timetable')
                    .doc('permissions')
                    .collection(code)
                    .get();

                for (const dateDoc of dateDocs.docs) {
                    const itemsSnap = await db.collection('shifts_timetable')
                        .doc('permissions')
                        .collection(code)
                        .doc(dateDoc.id)
                        .collection('items')
                        .get();

                    itemsSnap.forEach(itemDoc => {
                        const data = itemDoc.data();
                        if (data.status === 'Pending') {
                            pendingCount++;
                        }
                    });
                }

                // Count pending shift changes
                const shiftsSnap = await db.collection('shifts_timetable').doc('shift_change').collection(code).get();
                shiftsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'Pending') {
                        pendingCount++;
                    }
                });
            }

            // Count pending leave requests
            const leaveSnap = await db.collection('absence_requests')
                .where('status', '==', 'pending')
                .get();
            pendingCount += leaveSnap.size;

            // Update badge
            const badge = document.getElementById('employeeRequestsCount');
            badge.textContent = pendingCount;
            if (pendingCount > 0) {
                badge.style.display = 'inline-flex';
                badge.classList.add('pulse');
            } else {
                badge.style.display = 'none';
                badge.classList.remove('pulse');
            }
        }
        // Call this function on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateEmployeeRequestsBadge();
            loadEmployeeRequests();
        });


        async function savePreviousDayTotalHours(email) {
            const dbRef = db.collection('employees').doc(email.toLowerCase());
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            const monthStr = dateStr.slice(0, 7);

            // Check if already saved
            const totalHoursDoc = await dbRef.collection('total_working_hours').doc(monthStr).get();
            let totalHoursData = totalHoursDoc.exists ? totalHoursDoc.data() : {};

            if (totalHoursData[dateStr]) {
                // Already saved, skip
                return;
            }

            // Get yesterday's login history
            const startOfDay = new Date(dateStr + 'T00:00:00');
            const endOfDay = new Date(dateStr + 'T23:59:59');
            const historySnap = await dbRef.collection('login_history')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                .orderBy('timestamp')
                .get();

            let firstLogin = null;
            let lastLogout = null;
            historySnap.forEach(doc => {
                const entry = doc.data();
                if (entry.action === 'Login.html' && !firstLogin) {
                    firstLogin = entry.timestamp.toDate();
                }
                if (entry.action === 'logout') {
                    lastLogout = entry.timestamp.toDate();
                }
            });

            let totalHoursStr = "0h 0m";
            let totalMinutes = 0;
            if (firstLogin && lastLogout) {
                const diffMs = lastLogout - firstLogin;
                const diffMins = Math.round(diffMs / 60000);
                const hours = Math.floor(diffMins / 60);
                const mins = diffMins % 60;
                totalHoursStr = `${hours}h ${mins}m`;
                totalMinutes = diffMins;
            }

            // Update the total for the month (sum of all days)
            // Get all days except 'total'
            let sumMinutes = 0;
            for (const [key, value] of Object.entries(totalHoursData)) {
                if (key !== "total" && /^\d{4}-\d{2}-\d{2}$/.test(key) && typeof value === "string") {
                    const match = value.match(/(\d+)h\s*(\d+)m/);
                    if (match) {
                        sumMinutes += parseInt(match[1]) * 60 + parseInt(match[2]);
                    }
                }
            }
            sumMinutes += totalMinutes; // Add yesterday's minutes

            // Format total as "Xh Ym"
            const totalHours = Math.floor(sumMinutes / 60);
            const totalMins = sumMinutes % 60;
            const totalStr = `${totalHours}h ${totalMins}m`;

            // Save to Firestore
            await dbRef.collection('total_working_hours').doc(monthStr)
                .set({ [dateStr]: totalHoursStr, total: totalStr }, { merge: true });
        }













        ///////////////////// span counter



        document.addEventListener('DOMContentLoaded', function () {


            // Countdown avatar logic
            let countdown = 3;
            const countdownAvatar = document.getElementById('roleCountdownAvatar');
            const countdownCircle = document.getElementById('roleCountdownCircle');
            const workingRoleValue = document.getElementById('workingRoleValue');

            countdownAvatar.style.display = 'inline-block';
            countdownCircle.textContent = countdown;

            const interval = setInterval(() => {
                // If role loaded, hide avatar and stop
                if (workingRoleValue.textContent && workingRoleValue.textContent !== '--') {
                    countdownAvatar.style.display = 'none';
                    clearInterval(interval);
                    return;
                }
                countdown--;
                if (countdown <= 0) {
                    countdownAvatar.style.display = 'none';
                    clearInterval(interval);
                } else {
                    countdownCircle.textContent = countdown;
                }
            }, 1000);
        });



    </script>



    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function updateSubscriptionCounterDashboard() {
                const db = firebase.database();
                db.ref('users').once('value').then(snapshot => {
                    const users = snapshot.val() || {};
                    let found = false;
                    let shown = false;
                    Object.values(users).forEach(user => {
                        if (user.hosting_domain_subscription && user.hosting_domain_subscription.isSubscribed) {
                            found = true;
                            const now = Date.now();
                            const endDate = user.hosting_domain_subscription.subscriptionEnd;
                            const timeLeft = endDate - now;
                            const threeDaysMs = 3 * 24 * 60 * 60 * 1000;
                            const counterSpan = document.getElementById('subscriptionCounterDashboard');
                            if (timeLeft > 0 && timeLeft < threeDaysMs) {
                                // Show counter
                                counterSpan.style.display = 'inline-block';
                                const endDateObj = new Date(endDate);
                                const fullTimestamp = endDateObj.toLocaleString();
                                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                                document.getElementById('subscriptionCounterDashboardValue').textContent =
                                    `Sub Ends: ${fullTimestamp} (${days}d ${hours}h ${minutes}m ${seconds}s left)`;
                                shown = true;
                            }
                        }
                    });
                    // Hide if not found or not less than 3 days
                    if (!shown) {
                        document.getElementById('subscriptionCounterDashboard').style.display = 'none';
                    }
                });
            }
            setInterval(updateSubscriptionCounterDashboard, 1000);
            updateSubscriptionCounterDashboard();
        });

        function openHelpPage() {
            window.open('Help-Center.html', '_blank');
        }

        function configServerIP() {
            const currentIP = localStorage.getItem('dms-server-ip') || 'http://localhost:3000';
            const newIP = prompt("Enter Main Server IP address (e.g., http://192.168.1.10:3000):", currentIP);
            if (newIP) {
                localStorage.setItem('dms-server-ip', newIP);
                location.reload();
            }
        }

        async function checkLabNetwork() {
            const statusEl = document.getElementById('networkStatus');
            const textEl = document.getElementById('statusText');
            if (!statusEl) return;
            const server = localStorage.getItem('dms-server-ip') || 'http://localhost:3000';

            try {
                const res = await fetch(`${server}/api/health`).catch(() => ({ ok: false }));
                if (res.ok) {
                    statusEl.classList.add('online');
                    statusEl.classList.remove('offline');
                    textEl.textContent = 'Lab Network: Online';
                } else {
                    throw new Error();
                }
            } catch (e) {
                statusEl.classList.add('offline');
                statusEl.classList.remove('online');
                textEl.textContent = 'Lab Network: Local Mode';
            }
        }

        setInterval(checkLabNetwork, 5000);
        checkLabNetwork();
    </script>

    <!-- Add Bootstrap JS for modal support -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <span id="noNotificationsText" style="display:none;">No new notifications</span>
</body>

</html>